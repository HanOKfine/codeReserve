<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>16 必学的标准库：collections 容器数据类型的使用和实现细节（下篇）</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="揭开被“简单易学”掩盖的Python真相">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2257";
	var chapter_title = "16 必学的标准库：collections 容器数据类型的使用和实现细节（下篇）";
	var aid = "79";
	var a_name = "Python 核心技术精讲";
	var a_price = "78.00";
	var a_pic = "https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg";
	var userId = 0;

	var column_id = '79';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-08-03&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			16 必学的标准库：collections 容器数据类型的使用和实现细节（下篇）
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img1.mukewang.com/5f276ba200011d5f06400426.jpg')"></div>
	
	
		<a href="/read/79">
			<div class="course-entry">
				<img src="https://img4.mukewang.com/5edcf963000148bc05200501-40-40.jpg" alt="郭元锴">
				<h3>Python 核心技术精讲</h3>
				<p>郭元锴 · BAT高级研发工程师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">天才就是长期劳动的结果。<p class="author">——牛顿</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h2 id="deque：双端队列"><code>deque</code>：双端队列</h2>
</div><div class="cl-preview-section"><h3 id="deque-与-list"><code>deque</code> 与 <code>list</code></h3>
</div><div class="cl-preview-section"><p>在前面的小节中，我们提到 <code>list</code> 的实现基于可变长的数组而并非链表，所以在使用 <code>list</code> 对某个索引查询（ Get Item ）时可以以 <code>O(1)</code> 的时间进行。但当我们使用 <code>insert()</code> 方法在列表中插入元素时，比如像下面这样在列表头部插入元素，它会以 <code>O(n)</code> 的时间复杂度进行，涉及到底层数据大小及位置的变化开销，其效率是相对低下的。同样，下面我们在弹出列表头部的元素时，它的效率也是低下的。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>所以当我们需要频繁的在列表的两端进行元素的插入或删除时，我们便可以使用双端队列  <code>collections.deque</code> 来完成。<code>deque</code> 是 “double-ended queue” 的简称，<code>collections.deque([iterable[, maxlen]])</code> 可接受一个可迭代对象 <code>iterable</code>，返回一个双端队列对象。如下所示，当 <code>maxlen</code> 为 <code>None</code> 或者未指定时，<code>deque</code> 的增长不会受到长度限制。反之，<code>deque</code> 的最大长度则为 <code>maxlen</code> ，当 <code>deque</code> 达到最大长度时，新添加的元素将会把同样数量的元素从 <code>deque</code> 另一端弹出。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p><code>deque</code> 对象支持在两个方向上以 <code>O(1)</code> 的时间复杂度进行高效的元素添加和弹出操作（ <code>append</code>、<code>appendleft</code>、<code>pop</code>、<code>popleft</code> ）。我们常用的栈、队列两种数据结构（添加和弹出被限制在某一端）可以看做是双端队列的两种简化形式。</p>
</div><div class="cl-preview-section"><p>需要注意的是，对于索引操作，在 <code>deque</code> 的两端可以以 <code>O(1)</code> 的时间复杂度进行，但在 <code>deque</code> 的中间则会降低至 <code>O(n)</code> ，所以我们应该根据不同的场景来选择相应的数据结构。<code>deque</code> 更适用于频繁的进行两端元素的插入或删除，而对于高效的使用索引随机访问元素，使用 <code>list</code> 更好一些（更多关于  CPython 各种操作的时间复杂度可以参考 <a href="https://wiki.python.org/moin/TimeComplexity">TimeComplexity</a> ）。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>appendleft<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">4</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="deque-的实现"><code>deque</code> 的实现</h3>
</div><div class="cl-preview-section"><p>我们可以在 <a href="https://github.com/python/cpython/blob/3.8/Modules/_collectionsmodule.c">collectionsmodule.c</a> 中查看 <code>deque</code> 相关的源码。<code>deque</code> 基于以内存块进行组织的双向链表实现。下面是来自于源码中的注释：</p>
</div><div class="cl-preview-section"><blockquote>
<p>Data for deque objects is stored in a doubly-linked list of fixed length blocks。</p>
</blockquote>
</div><div class="cl-preview-section"><p><code>block</code> 作为双向链表中的一个结点，包含两个指向左右 <code>block</code> 的指针和一个长度为 64 、元素指向 <code>PyObject</code> 的指针数组。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> BLOCKLEN 64</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CENTER ((BLOCKLEN - 1) / 2)</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> BLOCK <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> BLOCK <span class="token operator">*</span>leftlink<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>data<span class="token punctuation">[</span>BLOCKLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> BLOCK <span class="token operator">*</span>rightlink<span class="token punctuation">;</span>
<span class="token punctuation">}</span> block<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="deque-的常用方法"><code>deque</code> 的常用方法</h3>
</div><div class="cl-preview-section"><p>除了上面我们提到的 <code>append()</code>、<code>pop()</code> 等几种方法以及部分序列操作方法（比如索引访问、迭代、<code>len()</code>、<code>in</code> 成员检测等），<code>deque</code> 还支持 <code>clear()</code>、<code>copy()</code>、<code>count(x)</code>、<code>extend(iterable)</code>、<code>extendleft(iterable)</code>、<code>index(x[, start[, stop]])</code>、<code>insert(i, x)</code>、<code>remove(value)</code>、<code>reverse()</code>、<code>rotate(n=1)</code> 等方法。</p>
</div><div class="cl-preview-section"><p>鉴于其中大部分方法都较容易理解，在这里我们仅对 <code>extendleft(iterable)</code> 和 <code>rotate(n=1)</code> 进行一定的说明。<code>deque.extendleft(iterable)</code> 使用可迭代对象 <code>iterable</code> 中的元素来对原 <code>deque</code> 对象左侧进行扩展。在扩展时，我们需要注意 <code>iterable</code> 中的元素被添加后的顺序，如下所示。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>extendleft<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p><code>deque.rotate(n=1)</code> 将原 <code>deque</code> 中的元素向右循环移动 <code>n</code> 步，当 <code>n</code> 为负值时移动方向为左。我们可以看到下面的示例结果，<code>d.rotate()</code> 相当于 <code>d.appendleft(d.pop())</code>，<code>d.rotate(-1)</code> 相当于 <code>d.append(d.popleft())</code>。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
deque<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="deque-支持线程安全"><code>deque</code> 支持线程安全</h3>
</div><div class="cl-preview-section"><p><code>deque</code> 的 <code>append()</code> 、<code>appendleft()</code>、<code>pop()</code>、<code>popleft()</code> 等操作是线程安全的（可参考 <a href="https://bugs.python.org/issue15329">clarify which deque methods are thread-safe</a> ），比如我们可以使用多个线程同时对 <code>deque</code> 中的元素在其左右两端进行消费。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> time
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> collections <span class="token keyword">import</span> deque
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> threading
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">consume</span><span class="token punctuation">(</span>left<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">if</span> left<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 value <span class="token operator">=</span> d<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'popleft: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">else</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 value <span class="token operator">=</span> d<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'pop: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">break</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">deque_consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_right <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>consume<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_left <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>consume<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_right<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_left<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_right<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     thread_left<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> deque_consume<span class="token punctuation">(</span><span class="token punctuation">)</span>
pop<span class="token punctuation">:</span> <span class="token number">5</span>
popleft<span class="token punctuation">:</span> <span class="token number">0</span>
pop<span class="token punctuation">:</span> <span class="token number">4</span>
popleft<span class="token punctuation">:</span> <span class="token number">1</span>
pop<span class="token punctuation">:</span> <span class="token number">3</span>
popleft<span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>CPython 中 <code>deque</code> 的线程安全是借助 GIL 来实现的，比如下面所示的源码 <code>deque_append</code> 这个 C 函数中并没有进行 GIL 的释放（没有使用我们在之前 GIL 小节中提到的 <code>Py_BEGIN_ALLOW_THREADS</code> 及 <code>Py_END_ALLOW_THREADS</code> 等操作），GIL 在整个函数的执行过程中并不会切换。关于 <code>deque</code> 线程安全更多的讨论可以参考 <a href="https://stackoverflow.com/questions/717148/queue-queue-vs-collections-deque">Queue.Queue vs. collections.deque</a> 。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">static PyObject <span class="token operator">*</span>
deque_append<span class="token punctuation">(</span>dequeobject <span class="token operator">*</span>deque<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>item<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Py_INCREF<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deque_append_internal<span class="token punctuation">(</span>deque<span class="token punctuation">,</span> item<span class="token punctuation">,</span> deque<span class="token operator">-</span><span class="token operator">&gt;</span>maxlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    Py_RETURN_NONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="使用-deque-实现移动平均">使用 <code>deque</code> 实现移动平均</h3>
</div><div class="cl-preview-section"><p>这里我们基于一个官方文档中的例子，并对其进行内容上的扩充，首先我们先看看维基百科中关于移动平均的解释：</p>
</div><div class="cl-preview-section"><blockquote>
<p>移动平均（英语：moving average，MA ），又称 “移动平均线”，简称均线，是技术分析中一种分析时间序列数据的工具。最常见的是利用股价、回报或交易量等变数计算出移动平均。移动平均可抚平短期波动，反映出长期趋势或周期。数学上，移动平均可视为一种卷积。</p>
</blockquote>
</div><div class="cl-preview-section"><p>那么移动平均反映在序列数据上是什么效果呢？以简单移动平均为例，假设 <code>[40, 30, 50, 46, 39, 44]</code> 为某 6 天内的收市价，那么，<code>[(40 + 30 + 50) / 3, (30 + 50 + 46) / 3, (50 + 46 + 39) / 3, (46 + 39 + 44) / 3]</code> 即 <code>[40.0, 42.0, 45.0, 43.0]</code> 便是这段时间内收市价的 3 日简单移动平均。</p>
</div><div class="cl-preview-section"><p>结合上面的概念，我们来看看官方文档中的这段示例代码怎么来计算移动平均：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">moving_average</span><span class="token punctuation">(</span>iterable<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>
    d <span class="token operator">=</span> deque<span class="token punctuation">(</span>itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>it<span class="token punctuation">,</span> n<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    d<span class="token punctuation">.</span>appendleft<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token keyword">for</span> elem <span class="token keyword">in</span> it<span class="token punctuation">:</span>
        s <span class="token operator">+=</span> elem <span class="token operator">-</span> d<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>
        d<span class="token punctuation">.</span>append<span class="token punctuation">(</span>elem<span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s <span class="token operator">/</span> n

</code></pre>
</div><div class="cl-preview-section"><p>上面这段代码中，涉及的主要知识点包括迭代器、生成器、<code>deque</code> 相关方法的使用（对于迭代器，生成器，我们在这里简单的理解它们在代码中的作用即可，其核心的概念我们在后面的小节中讲解）。</p>
</div><div class="cl-preview-section"><p>首先通过 <code>iter(iterable)</code> 对入参 <code>iterable</code> 进行处理，其返回一个迭代器对象 。<code>deque(itertools.islice(it, n-1))</code>  中的 <code>itertools.islice(it, n-1)</code> 对应到代码中默认情况 <code>n=3</code> 时，应为 <code>itertools.islice(it, 2)</code>，它的作用是创建一个从 <code>it</code> 中返回指定范围内元素的迭代器，可以看作是迭代器切片。比如当 <code>iterable</code> 为 <code>[40, 30, 50, 46, 39, 44]</code> 时，<code>deque(itertools.islice(it, 2))</code> 对应的结果则是 <code>deque([40, 30])</code>，同时迭代器 <code>it</code> 中 <code>40</code> 和 <code>30</code> 也随之被消耗。</p>
</div><div class="cl-preview-section"><p>随后对于 <code>d</code> 的处理相对简单，通过 <code>appendleft(0)</code> 在 <code>d</code> 的左侧添加 <code>0</code>（此时 <code>d</code> 为 <code>deque([0, 40, 30])</code>）并计算所有元素的和 <code>s</code>（ <code>s</code> 为 <code>70</code> ）。接着通过 <code>for</code> 循环对 <code>it</code> 进行迭代，注意 <code>it</code> 中前两个元素已被消耗掉，此时的效果类似 <code>for elem in [50, 46, 39, 44]</code>，在第一次循环中，<code>s = s + elem - d.popleft()</code> 即 <code>s = 70 + 50 - 0</code>，<code>d.append(elem)</code> 向 <code>d</code> 中右侧添加 <code>50</code>（此时 <code>d</code> 为 <code>deque([40, 30, 50])</code> ）。</p>
</div><div class="cl-preview-section"><p>最后， 通过 <code>yield s / n</code> 语句使 <code>moving_average</code> 成为一个生成器函数（ generator ），当 <code>moving_average</code> 被调用时，会返回一个可以执行该函数的生成器迭代器（生成器函数创建的对象称为生成器迭代器 generator iterator ）。我们在这里不再引入过多关于迭代器和生成器的概念，运行该函数看看效果：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ma <span class="token operator">=</span> moving_average<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ma
<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> moving_average at <span class="token number">0x7f83e2dcbcf0</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">next</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token number">40.0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">next</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token number">42.0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">next</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token number">45.0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">next</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token number">43.0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">next</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
StopIteration
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> ma <span class="token operator">=</span> moving_average<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">40.0</span><span class="token punctuation">,</span> <span class="token number">42.0</span><span class="token punctuation">,</span> <span class="token number">45.0</span><span class="token punctuation">,</span> <span class="token number">43.0</span><span class="token punctuation">]</span>

</code></pre>
</div><div class="cl-preview-section"><p>另外，官方文档中也提供了诸如 <code>deque</code> 实现轮转调度器、模拟 Unix <code>tail</code> 命令等 <a href="https://docs.python.org/zh-cn/3/library/collections.html#deque-recipes">示例</a>，感兴趣的话可以继续深入下去。</p>
</div><div class="cl-preview-section"><h2 id="defaultdict：-具有默认值的字典"><code>defaultdict</code>： 具有默认值的字典</h2>
</div><div class="cl-preview-section"><h3 id="defaultdict-的基本用法"><code>defaultdict</code> 的基本用法</h3>
</div><div class="cl-preview-section"><p>我们可以通过 <code>collections.defaultdict([default_factory[, ...]])</code> 来创建一个  <code>defaultdict</code> 对象，它主要的作用是为不存在的键提供一个默认值：当查询的某个键在 <code>defaultdict</code> 对象中不存在时，可以通过一个指定的方法返回一个默认值，同时该键和默认值则组成新的键值对被插入到原 <code>defaultdict</code> 中。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> def_dict<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict
defaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p><code>collections.defaultdict([default_factory[, ...]])</code> 中的第一参数 <code>default_factory</code> 默认为 <code>None</code>，可以将其指定为一个可调用对象。当 <code>default_factory</code> 为 <code>None</code> 时，对不存在的键的查询会引发 <code>KeyError</code> 。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'peter'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span>
KeyError<span class="token punctuation">:</span> <span class="token string">'height'</span>

</code></pre>
</div><div class="cl-preview-section"><p>如下所示，除了 <code>default_factory</code> 外，<code>defaultdict</code> 中其余参数的传递方式和 <code>dict</code> 类似，在下面的示例代码中，注释中的两种初始化方式，和使用关键字参数的初始化方式，得到得结果是相同的。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># defaultdict(int, [('name', 'peter'), ('age', 27)])</span>
<span class="token comment"># defaultdict(int, zip(('name', 'age'), ('peter', 27)))</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'peter'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">27</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> def_dict<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token string">'peter'</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span>
<span class="token number">0</span>

</code></pre>
</div><div class="cl-preview-section"><p>另外，<code>defaultdict</code> 类为 <code>dict</code> 的子类，<code>defaultdict</code> 对象支持 <code>dict</code> 的所有操作。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>defaultdict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'__copy__'</span><span class="token punctuation">,</span> <span class="token string">'default_factory'</span><span class="token punctuation">,</span> <span class="token string">'__missing__'</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>defaultdict<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><h3 id="missing__-和-default_factory"><code>__missing__()</code> 和 <code>default_factory</code></h3>
</div><div class="cl-preview-section"><p>在 <code>defaultdict</code> 背后起到关键作用的是 <code>__missing__()</code> 方法。具体的说，若某个 <code>dict</code> 的子类实现了 <code>__missing__()</code> 方法，则当我们通过 <code>__getitem__()</code> 进行索引操作（ <code>self[key]</code> ）时，若找不到对应的键 <code>key</code> ，<code>__missing__()</code> 则会被调用。<code>__missing__()</code> 是一种通用的特性，不只针对 <code>defaultdict</code> 。 需要注意的是，<code>__missing__()</code> 只会被 <code>__getitem__()</code> 方法进行调用，对于其他方法（比如 <code>get()</code> 方法），则不会产生任何影响，如下所示。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'peter'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">27</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span>  <span class="token comment"># 返回 None 而不是 0</span>


</code></pre>
</div><div class="cl-preview-section"><p>对于 <code>defaultdict</code> 来说，在 <code>__missing__()</code> 方法中，会使用其 <code>default_factory</code> 属性来处理查询不到的键。结合上面，<code>__missing__()</code> 只会被 <code>__getitem__()</code> 方法进行调用，所以 <code>default_factory</code> 也只针对 <code>__getitem__()</code> 起作用。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/wiki/5ee6247509920bec11670161.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict<span class="token punctuation">.</span>default_factory
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">&gt;</span>

</code></pre>
</div><div class="cl-preview-section"><h3 id="defaultdict-的使用示例"><code>defaultdict</code> 的使用示例</h3>
</div><div class="cl-preview-section"><p>我们可以自定义一个提供默认值的函数来返回期望的默认值。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> def_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token string">'&lt;NotFound&gt;'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'peter'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token string">'My name is {0[name]}. I am {0[age]} years old.  I am good at {0[skill]}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>def_dict<span class="token punctuation">)</span>
<span class="token string">'My name is peter. I am 27 years old.  I am good at &lt;NotFound&gt;'</span>

</code></pre>
</div><div class="cl-preview-section"><p>我们在之前的小节中提到过 <code>dict.setdefault(key[, default])</code> ，它的作用是当 <code>key</code> 在 <code>dict</code> 中存在时返回 <code>key</code> 对应的值，当 <code>key</code> 不存在时，将 <code>key</code> 和 <code>default</code> （默认为 <code>None</code> ）组成的键值对插入 <code>dict</code> 中同时返回 <code>default</code>，如下所示。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
<span class="token punctuation">{</span><span class="token string">'skill'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Python'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p>上面 <code>setdefault</code> 方法示例中实现的功能，我们可以使用 <code>defaultdict</code> 更加简洁的完成：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">[</span><span class="token string">'skill'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
defaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'list'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'skill'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Python'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>前面我们了解了 <code>Counter</code> 计数器的使用，在这里也可以使用 <code>defaultdict</code> 在循环中便捷的完成计数的功能。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> s <span class="token operator">=</span> <span class="token string">'casablanca'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     d<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d
defaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'int'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><h2 id="namedtuple：-创建命名元组"><code>namedtuple</code>： 创建命名元组</h2>
</div><div class="cl-preview-section"><p>我们在之前的小节中已经了解了 <code>namedtuple</code> 使用方法，这里我们将涉及到 <code>namedtuple</code> 更详细的一些内容。</p>
</div><div class="cl-preview-section"><h3 id="namedtuple-的基本用法"><code>namedtuple</code> 的基本用法</h3>
</div><div class="cl-preview-section"><p><code>namedtuple()</code> 是一个工厂函数，用于创建一个带有具体类名称和字段名称的元组子类（命名元组），可以简单的把工厂函数理解为一种通过函数来创建对象的设计模式，就好比一个工厂可以生产多种具体的产品，在创建对象的过程中，也可以加入具体的细节。下面我们使用 <code>namedtuple</code> 创建一个 <code>Point</code> 类并实例化。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'__main__.Point'</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p <span class="token operator">=</span> Point<span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">)</span>
<span class="token comment"># 不仅可以通过索引来获取值，还可以通过字段名称来获取对应的值，这样提高了代码的可读性和自文档性。相较于字典对象而言，命名元组对象在内存的占用上也具有一定优势。</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y
<span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>创建 <code>Point</code> 实例还可以通过解包参数的方式：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'x'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point<span class="token punctuation">(</span><span class="token operator">**</span>d<span class="token punctuation">)</span>
Point<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><h3 id="namedtuple-源码分析"><code>namedtuple</code> 源码分析</h3>
</div><div class="cl-preview-section"><p>接下来我们结合源码具体分析 <code>namedtuple</code> 更加深入的使用方法。<code>namedtuple()</code> 的详细形式是 <code>collections.namedtuple(typename, field_names, *, rename=False, defaults=None, module=None)</code> 。可以看到，相比于前面涉及到的几种类型，<code>namedtuple</code> 的形式相对复杂一些。</p>
</div><div class="cl-preview-section"><p>首先是位置参数 <code>typename</code> 和 <code>field_names</code>，通过上面的代码我们能看到，<code>typename</code> 是创建的元组子类（至于为什么是元组子类，我们会在下面具体说明）的类名。<code>field_names</code> 则是字段名称，也可以叫做域名。对于 <code>field_names</code> 来说，它可以是 <code>['x', 'y']</code> 或者 <code>'x y'</code> ，关于这一点，我们通过 <a href="https://github.com/python/cpython/blob/3.8/Lib/collections/__init__.py#L339">源码</a> 中的处理就可以理解：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>field_names<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    field_names <span class="token operator">=</span> field_names<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
field_names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> field_names<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>对于 <code>typename</code> 和 <code>field_names</code> 来说，它们的命名有一些要求，比如不能以 Python 关键字命名、首字母不可为数字（域名首字母不仅不能为数字，也不能为下划线）。对比下面的示例和源码，我们可以看到对于 <code>typename</code> 和 <code>field_names</code> 具体的限制。另外，在源码中，我们也可以看到使用了 <code>set</code> 进行成员关系检测。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'0Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ValueError<span class="token punctuation">:</span> Type names <span class="token operator">and</span> field names must be valid identifiers<span class="token punctuation">:</span> <span class="token string">'0Point'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'_Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'_x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ValueError<span class="token punctuation">:</span> Field names cannot start <span class="token keyword">with</span> an underscore<span class="token punctuation">:</span> <span class="token string">'_x'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ValueError<span class="token punctuation">:</span> Type names <span class="token operator">and</span> field names cannot be a keyword<span class="token punctuation">:</span> '<span class="token keyword">class</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token punctuation">[</span>typename<span class="token punctuation">]</span> <span class="token operator">+</span> field_names<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Type names and field names must be strings'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> name<span class="token punctuation">.</span>isidentifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Type names and field names must be valid '</span>
                         f<span class="token string">'identifiers: {name!r}'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> _iskeyword<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Type names and field names cannot be a '</span>
                         f<span class="token string">'keyword: {name!r}'</span><span class="token punctuation">)</span>

seen <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> name <span class="token keyword">in</span> field_names<span class="token punctuation">:</span>
    <span class="token keyword">if</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token operator">not</span> rename<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Field names cannot start with an underscore: '</span>
                         f<span class="token string">'{name!r}'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> name <span class="token keyword">in</span> seen<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>f<span class="token string">'Encountered duplicate field name: {name!r}'</span><span class="token punctuation">)</span>
    seen<span class="token punctuation">.</span>add<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p><code>namedtuple()</code> 参数列表中的 <code>*</code> 表示随后的形参均为仅限关键字参数（这部分知识我们后面会涉及到），表明  <code>rename</code>、 <code>defaults</code>、<code>module</code> 参数都需要以关键字的形式传递。</p>
</div><div class="cl-preview-section"><p>对于 <code>rename</code> 参数来说，其默认值为 <code>False</code>，如果 <code>rename</code> 为 <code>True</code> ，则对于不合法的域名会自动进行名称转换，不合法的域名会被转换为 <code>_{index}</code> （比如<code>_0</code>）的形式，参考下面的示例和源码。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'_x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rename<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point<span class="token punctuation">.</span>_fields
<span class="token punctuation">(</span><span class="token string">'_0'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">if</span> rename<span class="token punctuation">:</span>
    seen <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>field_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> name<span class="token punctuation">.</span>isidentifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">or</span> _iskeyword<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token operator">or</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>
                <span class="token operator">or</span> name <span class="token keyword">in</span> seen<span class="token punctuation">)</span><span class="token punctuation">:</span>
            field_names<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token string">'_{index}'</span>
        seen<span class="token punctuation">.</span>add<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p><code>defaults</code> 的作用是为域名设置默认值，默认为 <code>None</code>，可以设置为一个可迭代对象。当提供的默认值数量小于域名的数量，默认值会和域名以右对齐的方式进行匹配，如下面的示例。当提供的默认值数量大于域名的数量，则会引发 <code>TypeError</code> 异常。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p <span class="token operator">=</span> Point<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p <span class="token operator">=</span> Point<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
TypeError<span class="token punctuation">:</span> Got more default values than field names

</code></pre>
</div><div class="cl-preview-section"><p>我们可以看到下面源码中匹配的具体逻辑 <code>field_defaults = dict(reversed(list(zip(reversed(field_names), reversed(defaults)))))</code> 。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">field_defaults <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">if</span> defaults <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    defaults <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>field_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Got more default values than field names'</span><span class="token punctuation">)</span>
    field_defaults <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>field_names<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            <span class="token builtin">reversed</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>上面的代码中，通过 <code>zip</code> 将倒序的 <code>field_names</code> 和 <code>defaults</code> 进行并排的元素配对，从而得到一个元组的迭代器，<code>zip</code> 会以这两个可迭代对象中长度最短的为准，当可迭代对象中最短的被耗尽时，配对将会终止，如下所示。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p>最后一个参数 <code>module</code> 可用于设置该元组子类的 <code>__module__</code> 属性（所属模块的名称）。</p>
</div><div class="cl-preview-section"><p>最后，我们来看 <code>namedtuple()</code> 怎样生成元组子类，我们在这里省略了源码中一些方法、及命名空间 <code>class_namespace</code> 的构建过程。下面源码中所示的 <code>result</code> 便是 <code>namedtuple()</code> 创建的元组子类，可以看到，<code>namedtuple()</code> 是通过 <code>type</code> 来创建元组子类的。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">result <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span>typename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class_namespace<span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>对于 <code>type</code> 来说，当传入一个参数时，其返回该参数的类型，这个我们在前面也提到过。这里要提到的是 <code>type()</code> 的另一个更为重要的作用：当 <code>type()</code> 传入三个参数时，会返回一个新的类（可以看作是 <code>class</code> 语句的动态形式，更多的内容我们在元类的小节继续深入）。这三个参数的作用分别是：类名、基类和命名空间。如下代码中所示的两种形式，分别是基于 <code>Class</code> 语句和基于 <code>type()</code> 来创建类，这两种形式所创建的类（也可称之为 <code>type</code> 对象）是相同的：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># 形式一</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Point</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     x <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
<span class="token comment"># 形式二</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>对照源码并结合 <code>type()</code> 的用法，可以知道 <code>result</code> 的类名为 <code>typename</code>，继承自 <code>tuple</code>，是一个新的元组子类（命名元组）。</p>
</div><div class="cl-preview-section"><h3 id="namedtuple-的相关方法"><code>namedtuple</code> 的相关方法</h3>
</div><div class="cl-preview-section"><p><code>namedtuple()</code> 创建的元组子类除继承了元组的相关方法以外， 还实现了 <code>_make</code>、<code>_asdict</code>、<code>_replace</code> 方法。我们看看这三种方法的使用方法，注意这三种方法（包括下面的属性 <code>_fields</code>  和 <code>_field_defaults</code> ）均使用了下划线开头，这样做的主要目的是为了防止和域名产生冲突。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># _make：基于可迭代对象创建一个命名元组对象</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p <span class="token operator">=</span> Point<span class="token punctuation">.</span>_make<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p
Point<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># _asdict：返回一个字段名称和对应的值作为键值对组成的字典</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>_asdict<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'x'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># _replace：返回一个指定字段被替换为新值的命名元组对象</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>_replace<span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
Point<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>除了上面所示的三种方法外，命名元组对象还有两个属性需要说明，分别为 <code>_fields</code>、<code>_field_defaults</code>：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># _fields：命名元组对象的所有域名</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>_fields
<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token comment"># 除了用于获取域名外，还可以用于创建新的命名元组对象</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> TDPoint <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'TDPoint'</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>_fields <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">'z'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> TDPoint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
TDPoint<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> z<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># _field_defaults：返回域名和默认值作为键值对组成的字典</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Point<span class="token punctuation">.</span>_field_defaults
<span class="token punctuation">{</span><span class="token string">'x'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><h2 id="ordereddict：有序字典"><code>OrderedDict</code>：有序字典</h2>
</div><div class="cl-preview-section"><h3 id="dict-和-ordereddict"><code>dict</code> 和 <code>OrderedDict</code></h3>
</div><div class="cl-preview-section"><p><code>OrderedDict</code> 是字典的子类， 具有用于重新排列字典顺序的相关方法。 创建 <code>OrderedDict</code> 对象和创建常规字典对象的方式类似。除了拥有额外的可移动键进行重新排序的相关方法外，<code>OrderedDict</code> 的操作和 <code>dict</code> 基本相同。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>OrderedDict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'__dict__'</span><span class="token punctuation">,</span> <span class="token string">'move_to_end'</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>OrderedDict<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># OrderedDict 的创建和操作方法与 dict 基本相同</span>
<span class="token comment"># 动态的使用键索引赋值</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'bob'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o
OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 使用构造函数</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> OrderedDict<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'bob'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">)</span>
<span class="token comment"># 使用 fromkeys() 从一个可迭代对象来创建</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> OrderedDict<span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p>由于 Python 3.7 中字典保持插入顺序这个特性的正式宣布，导致 <code>OrderedDict</code> 相比于之前的版本来说，重要性有所下降。如果你需要一个可保持插入顺序的字典，在 Python 3.7 及以后的版本中，使用 <code>dict</code> 即可。但相比于 <code>dict</code> ，<code>OrderedDict</code> 仍具有一些另外的特性，比如在相等性方面，<code>dict</code> 仅以内容为准，<code>OrderedDict</code> 还会考虑顺序。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'bob'</span><span class="token punctuation">}</span>
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token boolean">False</span>

</code></pre>
</div><div class="cl-preview-section"><p>在 Python 官方文档中对于 <code>dict</code> 和 <code>OrderedDict</code> 有着这样的比较：</p>
</div><div class="cl-preview-section"><blockquote>
<p>常规的 <code>dict</code> 被设计为非常擅长映射操作，跟踪插入顺序是次要的。<code>OrderedDict</code> 旨在擅长重新排序操作，空间效率、迭代速度和更新操作的性能是次要的。算法上，<code>OrderedDict</code> 可以比 <code>dict</code> 更好地处理频繁的重新排序操作，这使其适用于跟踪最近的访问（例如在 <code>LRU cache</code> 中）。</p>
<p>对于 <code>OrderedDict</code> ，相等操作检查匹配顺序。<code>OrderedDict</code> 类的 <code>popitem()</code> 方法有不同的签名，它接受一个可选参数来指定弹出元素的方式。另外，<code>OrderedDict</code> 类有一个 <code>move_to_end()</code> 方法，可以有效地将元素移动到任一端。</p>
</blockquote>
</div><div class="cl-preview-section"><h3 id="popitem-和-move_to_end"><code>popitem()</code> 和 <code>move_to_end()</code></h3>
</div><div class="cl-preview-section"><p>相比于常用的 <code>dict</code> 对象的 <code>popitem()</code> 方法来说，<code>OrderedDict</code> 对象的 <code>popitem()</code> 方法增加了一个 <code>last</code> 参数，用于决定移除键值对是按照 <code>LIFO</code> （后进先出）还是 <code>FIFO</code> （先进先出）的方式。而使用 <code>dict</code> 对象的 <code>popitem()</code> 方法的话，键值对默认按照 <code>LIFO</code> 的顺序移除（在 Python 3.7 之前会返回任意一个键值对）。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p><code>move_to_end(key, last=True)</code> 可将 <code>key</code> 移动至 <code>OrderedDict</code> 对象的任意一端。<code>last</code> 默认为 <code>True</code>，移至尾部，反之则移至首部，此方法非常适合应用于实现 <code>lru_cache</code>  。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>move_to_end<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o
OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>move_to_end<span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> last<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> o
OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'skill'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><h2 id="总结">总结</h2>
</div><div class="cl-preview-section"><p>在本小节中，我们分别对 <code>collections</code> 模块中包括 <code>ChainMap</code>、<code>Counter</code>、<code>deque</code>、<code>defaultdict</code>、<code>namedtuple()</code>、<code>OrderedDict</code> 在内的六种常用容器数据类型进行了相对详细的了解。我们结合源码提到了一些数据类型的实现原理，并对官方文档中的一些代码的写法进行了讲解。同时，我们在后面的小节中，结合相关内容，还会涉及到一些关于本小节中容器数据类型的应用。学习一种数据结构，认知原理是一部分，更重要的是学习它的适用场景和相关最佳实践。结合原理与应用，这样有助于我们写出更加简洁高效的代码。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img.mukewang.com/5f276baa00011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥78.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=79">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '16 必学的标准库：collections 容器数据类型的使用和实现细节（下篇）',
					'CID': '2257',
					'Teacher': '郭元锴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "16 必学的标准库：collections 容器数据类型的使用和实现细节（下篇）",
                    desc: "揭开被“简单易学”掩盖的Python真相",
                    imgUrl: 'https:https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    otherImgUrl: 'https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/79',
                    link: 'https://m.imooc.com/read/79'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
