<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>07 饱受争议的话题：全局解释器锁 GIL（上篇）</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="揭开被“简单易学”掩盖的Python真相">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2141";
	var chapter_title = "07 饱受争议的话题：全局解释器锁 GIL（上篇）";
	var aid = "79";
	var a_name = "Python 核心技术精讲";
	var a_price = "78.00";
	var a_pic = "https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg";
	var userId = 0;

	var column_id = '79';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-08-17&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			07 饱受争议的话题：全局解释器锁 GIL（上篇）
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img3.mukewang.com/5efbee910001fb9806400425.jpg')"></div>
	
	
		<a href="/read/79">
			<div class="course-entry">
				<img src="https://img4.mukewang.com/5edcf963000148bc05200501-40-40.jpg" alt="郭元锴">
				<h3>Python 核心技术精讲</h3>
				<p>郭元锴 · BAT高级研发工程师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">加紧学习，抓住中心，宁精勿杂，宁专勿多。 <p class="author">—— 周恩来</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h2 id="引言">引言</h2>
</div><div class="cl-preview-section"><p>有这样一个话题，它对于在 Python 中使用过多线程的开发者来说一定不会陌生。当你遇到它的时候，如果你不了解它的话，很可能你会质疑自己的代码是否具有一些隐藏的问题。在各种社区或论坛中，你也会经常看到关于它的讨论和分析。它便是在当前的 Python 中起到重要作用的全局解释器锁 GIL。在本小节中，我们会从最直观的实例对比中逐步了解 Python 中的 GIL，从多个角度分析它在 Python 实现中的作用和优劣。</p>
</div><div class="cl-preview-section"><h2 id="全局解释器锁-gil">全局解释器锁 GIL</h2>
</div><div class="cl-preview-section"><h3 id="什么是-gil？">什么是 GIL？</h3>
</div><div class="cl-preview-section"><p>全局解释器锁 GIL，英文名称为 Global Interpreter Lock，它是解释器中一种线程同步的方式。对于每一个解释器进程都具有一个 GIL ，它的直接作用是<strong>限制单个解释器进程中多线程的并行执行</strong>，使得即使在多核处理器上对于单个解释器进程来说，在同一时刻运行的线程仅限一个。</p>
</div><div class="cl-preview-section"><h3 id="python-中的-gil">Python 中的 GIL</h3>
</div><div class="cl-preview-section"><p>Python 代码被编译后的字节码会在解释器中执行，在执行过程中，存在于 CPython 解释器中的 GIL 会<strong>致使在同一时刻只有一个线程可以执行字节码</strong>。</p>
</div><div class="cl-preview-section"><p>对于 Python 来讲，GIL 并不是它语言本身的特性，而是 <strong>CPython 解释器的实现特性</strong>。在Python 目前众多的实现中，其中 PyPy 也是具有 GIL 的，Jython、IronPython 中没有 GIL，但这些解释器由于其他原因并未得到广泛使用。同时，其他的编程语言，比如 Ruby 的 C 语言实现中也是具有 GIL 的。</p>
</div><div class="cl-preview-section"><h3 id="cpython-中的-gil-导致的问题">CPython 中的 GIL 导致的问题</h3>
</div><div class="cl-preview-section"><p>GIL 的存在引起的最直接的问题便是：在一个解释器进程中通过多线程的方式无法利用多核处理器来实现真正的并行（对于并行、并发、进程、线程等概念我们在后面的小节中会有更加详细的描述）。对应到真实的业务场景中，在完成一些计算密集型任务时，我们无法通过多线程编程的方式来提高代码的执行效率。</p>
</div><div class="cl-preview-section"><h2 id="不同类型任务下-gil-对-python-多线程的影响">不同类型任务下 GIL 对 Python 多线程的影响</h2>
</div><div class="cl-preview-section"><p>接下来我们就用一些代码实例来验证对 GIL 的描述，上面我们提到���计算密集型任务，这里我简要对比计算密集型任务和 I/O 密集型任务。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/wiki/5ed3c4190910cb8012350344.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>计算密集型（ CPU-bound ）</strong>：也称为 CPU 密集型，大部分时间都用于进行计算、逻辑验证等 CPU 处理的程序，比如矩阵计算、视频编解码等，CPU 占用率高。</p>
</li>
<li>
<p><strong>I/O 密集型（ I/O-bound ）</strong>：大部分时间都用于等待 I/O （比如网络 I/O，磁盘 I/O ）处理完成的程序，比如大多数 Web 应用等，CPU 占用率低。</p>
</li>
</ul>
</div><div class="cl-preview-section"><h3 id="计算密集型任务">计算密集型任务</h3>
</div><div class="cl-preview-section"><p>首先我们以下面的递增函数为基础对计算密集型任务在 Python 多线程下的表现进行简单的测试。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">loop_add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">while</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         i <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
</code></pre>
</div><div class="cl-preview-section"><p>在单线程（即下面运行的主线程）下执行五次（ <code>repeat</code>  方法会默认执行 5 次，关于 <code>timeit</code> 模块的更多内容会在后面性能分析相关的小节中描述），执行时间平均值为 3.797136794799735 s。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> timeit       
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>stmt<span class="token operator">=</span><span class="token string">"loop_add(100000000)"</span><span class="token punctuation">,</span> setup<span class="token operator">=</span><span class="token string">"from __main__ import loop_add"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.824948476998543</span><span class="token punctuation">,</span> <span class="token number">3.784897646999525</span><span class="token punctuation">,</span> <span class="token number">3.7902461680005217</span><span class="token punctuation">,</span> <span class="token number">3.793153800001164</span><span class="token punctuation">,</span> <span class="token number">3.7924378819989215</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p>在下面的函数中开启两个线程分别进行上面单线程中一半数量的递增，在这里注意需要在开启线程后调用 <code>join()</code> 方法来等待线程终止（关于 <code>threading</code> 模块的更多内容会在后面多线程编程相关的小节中描述）。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> threading
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">multithread_loop_add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop_add<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">50000000</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop_add<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">50000000</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 启动线程</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 阻塞直至线程终止</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
</code></pre>
</div><div class="cl-preview-section"><p>上面的示例在 4 核心 CPU 机器上运行，按照我们预期内的多线程并行执行，两个线程分别执行一半数量递增任务的时间应该为上面单线程执行递增任务时间的 1/2。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>stmt<span class="token operator">=</span><span class="token string">"multithread_loop_add()"</span><span class="token punctuation">,</span> setup<span class="token operator">=</span><span class="token string">"from __main__ import multithread_loop_add"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.9824146000009932</span><span class="token punctuation">,</span> <span class="token number">3.9702273379989492</span><span class="token punctuation">,</span> <span class="token number">3.918540844000745</span><span class="token punctuation">,</span> <span class="token number">3.9172540660001687</span><span class="token punctuation">,</span> <span class="token number">3.8126948980007</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p>但在多线程下执行五次后的执行时间平均值为 3.9202263492003113 s，并不符合我们的预期执行时间。就上面的现象，我们可以从下面两个问题的解答中理解：</p>
</div><div class="cl-preview-section"><p><strong>为什么执行时间并没有减半？</strong></p>
</div><div class="cl-preview-section"><p>这正是上面提到的 GIL 导致的结果。由于在同一时刻，即使在多核 CPU 上，也仅有一个线程在获得该全局锁后才可以执行字节码，其他的线程想要执行字节码就需要等待该全局锁被释放，所以未能实现真正的并行执行，而是一种多线程交替执行的串行执行。</p>
</div><div class="cl-preview-section"><p><strong>为什么在没有减半的基础上，还比单线程执行慢？</strong></p>
</div><div class="cl-preview-section"><p>因为在多个线程执行过程中也涉及到了全局锁的获取和释放，上下文环境的切换等。并且相较于单核 CPU，这种效率降低的情况在多核 CPU 上在可能会更加显著。</p>
</div><div class="cl-preview-section"><h3 id="io-密集型任务">I/O 密集型任务</h3>
</div><div class="cl-preview-section"><p>首先我们以下面的循环网络请求函数为基础对 I/O 密集型任务在 Python 多线程下的表现进行简单的测试。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> urllib <span class="token keyword">import</span> request
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">loop_get</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span><span class="token string">"https://www.imooc.com"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>              
</code></pre>
</div><div class="cl-preview-section"><p>在单线程下执行五次，执行时间平均值为 4.795266318800714 s。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>stmt<span class="token operator">=</span><span class="token string">"loop_get(100)"</span><span class="token punctuation">,</span> setup<span class="token operator">=</span><span class="token string">"from __main__ import loop_get"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">4.631347359998472</span><span class="token punctuation">,</span> <span class="token number">4.591072030001669</span><span class="token punctuation">,</span> <span class="token number">4.871105291000276</span><span class="token punctuation">,</span> <span class="token number">4.901600085002428</span><span class="token punctuation">,</span> <span class="token number">4.9812068280007225</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p>如下面的代码所示，在多线程下执行五次后的执行时间平均值为 2.408049941000354 s。我们可以看到，在 I/O 密集型任务下，Python 多线程的表现是符合我们预期的。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">multithread_loop_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop_get<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop_get<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
</code></pre>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>stmt<span class="token operator">=</span><span class="token string">"multithread_loop_get()"</span><span class="token punctuation">,</span> setup<span class="token operator">=</span><span class="token string">"from __main__ import multithread_loop_get"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2.389618977002101</span><span class="token punctuation">,</span> <span class="token number">2.4772080140028265</span><span class="token punctuation">,</span> <span class="token number">2.405433809999522</span><span class="token punctuation">,</span> <span class="token number">2.6798762809994514</span><span class="token punctuation">,</span> <span class="token number">2.088112622997869</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p>那么为什么在 I/O 密集型任务下会有这样的效果呢？要回答这个问题，我们需要再对 GIL 更多的细节进行探究。</p>
</div><div class="cl-preview-section"><h2 id="gil-全局锁的实现细节">GIL 全局锁的实现细节</h2>
</div><div class="cl-preview-section"><h3 id="python-中的线程">Python 中的线程</h3>
</div><div class="cl-preview-section"><p>Python 使用的是特定于操作系统的线程实现，而并未在解释器中模拟线程。比如在 Linux 系统中，Python 的一个线程对应 Linux 系统中的一个 pthread，<strong>其线程调度是交由操作系统本身的调度来完成的</strong>。</p>
</div><div class="cl-preview-section"><h3 id="cpython-中有关-gil-的一些重要源码">CPython 中有关 GIL 的一些重要源码</h3>
</div><div class="cl-preview-section"><p>我们在当前版本的 <a href="https://github.com/python/cpython">CPython 代码库</a> 中可以找到 <a href="https://github.com/python/cpython/blob/master/Python/ceval_gil.h"><code>ceval_gil.h</code></a>，它是 GIL 的接口。其中 <code>_gil_runtime_state</code> 可以在 <a href="https://github.com/python/cpython/blob/master/Include/internal/pycore_gil.h">pycore_gil.h</a> 中找到相关定义。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">/*
 * Implementation of the Global Interpreter Lock (GIL).
 */</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">gil_created</span><span class="token punctuation">(</span><span class="token keyword">struct</span> _gil_runtime_state <span class="token operator">*</span>gil<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 省略部分源码</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create_gil</span><span class="token punctuation">(</span><span class="token keyword">struct</span> _gil_runtime_state <span class="token operator">*</span>gil<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     <span class="token comment">// 省略部分源码</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p><a href="https://github.com/python/cpython/blob/master/Python/ceval.c">ceval.c</a> 的主要作用是执行 Python 代码编译后的字节码，在这个文件中我们可以看到在初始化等过程中关于 GIL 的获取和释放：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 省略部分源码</span>
<span class="token keyword">void</span>
<span class="token function">PyEval_InitThreads</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 省略部分源码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gil_created</span><span class="token punctuation">(</span>gil<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">PyThread_init_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">create_gil</span><span class="token punctuation">(</span>gil<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 省略部分源码</span>
<span class="token punctuation">}</span>
<span class="token comment">// 省略部分源码</span>

</code></pre>
</div><div class="cl-preview-section"><h3 id="io-密集型任务下的线程切换">I/O 密集型任务下的线程切换</h3>
</div><div class="cl-preview-section"><p>在 I/O 密集型任务中，多线程在 GIL 下通常是一种<strong>协作式多任务形式</strong>。如下图多线程执行中，GIL 会在遇到 I/O 操作时被释放并交由其他线程继续执行，比如网络 I/O 操作、文件读写等。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/wiki/5ed3c43d09f2538109220414.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>我们继续在源码的基础上理解这种形式，下面的源码来自于 <a href="https://github.com/python/cpython/blob/27b33fb41a7c64a6211d73d14804aa0cd6defccb/Modules/socketmodule.c"><code>socketmodule.c</code></a> ，是网络 I/O 中的相关代码，我们可以看到源码中的 <code>Py_BEGIN_ALLOW_THREADS</code> 和 <code>Py_END_ALLOW_THREADS</code> ，这两处便是在网络连接过程中 Python 主动释放和获取 GIL 。这样便回答了上面关于多线程在 I/O 密集型任务下的表现问题，虽然这种形式仍是只有一个线程在执行字节码，但由于等待 I/O 的时间远远大于 CPU 执行时间，仍可通过 GIL 的释放和线程的切换执行来实现并发处理，可以有效的提高执行效率。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">internal_connect</span><span class="token punctuation">(</span>PySocketSockObject <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">,</span> <span class="token keyword">int</span> raise<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">,</span> err<span class="token punctuation">,</span> wait_connect<span class="token punctuation">;</span>

    Py_BEGIN_ALLOW_THREADS
    res <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>sock_fd<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Py_END_ALLOW_THREADS

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* connect() succeeded, the socket is connected */</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略部分源码</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><h3 id="计算密集型任务下的线程切换">计算密集型任务下的线程切换</h3>
</div><div class="cl-preview-section"><h4 id="python-3.2-之前的-”基于-opcode-计数“-机制">Python 3.2 之前的 ”基于 opcode 计数“ 机制</h4>
</div><div class="cl-preview-section"><p>那么对于计算密集型任务呢？在计算密集型任务中，如果没有 I/O 相关操作时，还需要一种执行机制来保证 GIL 的释放。在 Python 3.2 之前，CPython 是基于 opcode 执行数量进行周期性间隔检查（ Periodic Check ）的方式来进行 GIL 的释放和线程切换（我们在前面的小节已经了解了 opcode 的概念，即操作码或操作的数字代码）。如下图所示：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/wiki/5ed3c44d0962122506520240.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>具体地说，当线程在执行时，每经过 “100 ticks” 便主动释放 GIL，此时其他线程便可以获取 GIL 后进行执行。其中 ”tick“ 和时间没有直接关系，它是一个计数器，对应当前线程在两次释放 GIL 之间执行的 opcode 数量，注意这种对应关系并不是每个 opcode 对应一个 ”tick“，有些执行速度快的 opcode 并不会被计入其中，即有可能是多个 opcode 的执行对应一个 “tick”。如下图所示：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/wiki/5ed3c46a09623b9c13320496.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>这种检查机制时可以通过 <code>sys.setcheckinterval()</code> 和 <code>sys.getcheckinterval()</code> 来设置和查看检查间隔：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getcheckinterval<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">100</span>

</code></pre>
</div><div class="cl-preview-section"><p>当然，我们之前提到的在 I/O 操作中主动释放 GIL 和间隔检查的机制是结合在一起的，即当遇到 I/O 操作时，即使 tick 计数没有到100 也会主动释放 GIL 。</p>
</div><div class="cl-preview-section"><h4 id="”基于-opcode-计数“-机制存在的问题">”基于 opcode 计数“ 机制存在的问题</h4>
</div><div class="cl-preview-section"><ul>
<li>在 opcode 的执行过程中，“100 ticks” 对应的执行时间是不确定的，有些 opcode 的执行可能相当耗时，这样便导致一些线程的执行时间总是多于其他线程。尤其在多核 CPU 下，运行在不同核心上的线程，一个核心上正在运行执行时间较长的线程时，另外一个核心上的线程可能会多次的抢占 GIL ，导致 CPU 性能没有必要的损耗。</li>
<li>不管是在 I/O 操作时释放GIL，还是在执行了一定 opcode 后释放 GIL，Python 决定的是 GIL 的释放，至于哪个线程会获取到 GIL 并执行是交由操作系统来进行控制的。这样也导致了（尤其在多核 CPU 下），可能存在某些线程刚释放 GIL，又重新获取到 GIL，导致其余 CPU 上的线程反复的从唤醒到等待，造成线程颠簸（thrashing）。</li>
</ul>
</div><div class="cl-preview-section"><h4 id="python-3.2-后-”基于时间片计数“-机制">Python 3.2 后 ”基于时间片计数“ 机制</h4>
</div><div class="cl-preview-section"><p>在 Python 3.2 中，GIL 的实现机制发生了一些改变，新的实现机制使用固定的时间间隔来进行线程的切换，在其他线程请求获取 GIL 时，当前运行的线程会以 5 毫秒（默认时间）为间隔尝试释放 GIL。具体的细节可以大体总结为以下三点：</p>
</div><div class="cl-preview-section"><ul>
<li>基于固定时间而不是一定数量的 opcode 来进行线程切换。</li>
<li>当只存在单线程运行时，无需进行相关检查和 GIL 释放。</li>
<li>在某个线程释放 GIL 后，需要在其他的线程获取到 GIL 后才能再次进行 GIL 的获取。</li>
</ul>
</div><div class="cl-preview-section"><p>新的实现方式解决了之前 GIL 中某线程长时间执行以及 GIL 被某线程释放后又重新获取的问题。并且可以看到在 Python 3.2 后，之前的 <code>sys.setcheckinterval()</code> 和 <code>sys.getcheckinterval()</code>已经不再使用，换为 <code>sys.getswitchinterval()</code> 来查看线程切换时间。可以使用<code>help(sys.getswitchinterval)</code> 来查看对应的文档字符串。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getcheckinterval<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token builtin">input</span><span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span> DeprecationWarning<span class="token punctuation">:</span> sys<span class="token punctuation">.</span>getcheckinterval<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> sys<span class="token punctuation">.</span>setcheckinterval<span class="token punctuation">(</span><span class="token punctuation">)</span> are deprecated<span class="token punctuation">.</span>  Use sys<span class="token punctuation">.</span>getswitchinterval<span class="token punctuation">(</span><span class="token punctuation">)</span> instead<span class="token punctuation">.</span>
<span class="token number">100</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getswitchinterval<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">0.005</span>

</code></pre>
</div><div class="cl-preview-section"><p>但新的 GIL 实现机制中，线程对 GIL 的获取及执行还是由操作系统完成的，这样仍存在一些效率问题，比如需要被优先执行的某些 I/O 操作的线程可能无法及时获取到 GIL。同时，GIL 对多线程执行的限制这个根本问题还是存在的。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img3.mukewang.com/5efbee9b00011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥78.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=79">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '07 饱受争议的话题：全局解释器锁 GIL（上篇）',
					'CID': '2141',
					'Teacher': '郭元锴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "07 饱受争议的话题：全局解释器锁 GIL（上篇）",
                    desc: "揭开被“简单易学”掩盖的Python真相",
                    imgUrl: 'https:https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    otherImgUrl: 'https://img2.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/79',
                    link: 'https://m.imooc.com/read/79'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
