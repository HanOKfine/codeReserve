<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>05 刨根究底：网络层是如何工作的？</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="学好通用知识，提升技术竞争力">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2094";
	var chapter_title = "05 刨根究底：网络层是如何工作的？";
	var aid = "80";
	var a_name = "零基础学透网络编程";
	var a_price = "58.00";
	var a_pic = "https://img1.mukewang.com/5ed8c1c600015fc805400720.jpg";
	var userId = 0;

	var column_id = '80';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-06-09&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			05 刨根究底：网络层是如何工作的？
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img3.mukewang.com/5ed9fc120001831006400359.jpg')"></div>
	
	
		<a href="/read/80">
			<div class="course-entry">
				<img src="https://img1.mukewang.com/5458620000018a2602200220-40-40.jpg" alt="陈子兴">
				<h3>零基础学透网络编程</h3>
				<p>陈子兴 · 资深软件架构师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">最聪明的人是最不愿浪费时间的人。<p class="author">——但丁</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h2 id="前言">前言</h2>
</div><div class="cl-preview-section"><p>本章我们就要进入 TCP/IP 协议族的<strong>网络层</strong>学习了，回忆《素昧平生：初识网络协议大家族》一文的 TCP/IP 协议族大图，网络层包含：IPv4、IPv6、ICMP、IGMP、ICMPv6 等协议。由于 IPv4 是应用最早、也是应用最广泛的网络层协议，所以本文只介绍 IPv4，其他协议不做介绍。</p>
</div><div class="cl-preview-section"><p>学习完 IPv4 你就能理解分组是如何在网络中交换的，然后再去学习其他协议会容易很多。比如 ICMP 是一个辅助协议，在分组出现差错的时候一种通知机制等等。关于 IPv4 的具体内容也是非常多，理解难度比较大，也比较抽象。我们通过人们最为熟悉的“快递运输”的例子来类比 IP 层的分组交换过程，首先让你有一个感性的认识，然后再逐个介绍网络层的基本概念、以及各个细节。综合起来包含如下内容：</p>
</div><div class="cl-preview-section"><ul>
<li>快递运输过程</li>
<li>网络层基本概念</li>
<li>IPv4 Header 格式</li>
<li>IPv4 地址格式</li>
<li>子网划分</li>
<li>IPv4 私有地址划分</li>
<li>NAT 工作原理</li>
<li>关于路由表</li>
<li>路由匹配算法</li>
<li>路由转发过程</li>
</ul>
</div><div class="cl-preview-section"><p><strong>网络层</strong>也叫 Internet 协议层，主要职责就是<strong>提供端到端</strong>的网络传输，比如主机到主机的通信。这样的解释理解起来是不是比较抽象？其实网络层在 TCP/IP 协议族的作用可以类比快递公司在物流行业中的场景。那首先让我们从快递运输开始吧。</p>
</div><div class="cl-preview-section"><h2 id="快递运输过程">快递运输过程</h2>
</div><div class="cl-preview-section"><p>假设阿三和阿四是兄弟两，阿四在古都西安搞水果批发，阿三在北京的慕课网上班。阿四想给远在北京的哥哥阿三邮寄水果，必须找一家快递公司邮寄，运输过程可以参考下图：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed862bc0001932613130787.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>阿四给阿三邮寄石榴的过程如下：</p>
</div><div class="cl-preview-section"><p>（1）阿四把石榴交给快递小哥，小哥给阿四一个单子填写收件人姓名、电话号码、地址，寄件人姓名、电话号码、地址。为了简单，图中只是标出了收件人和寄件人的电话号码。现在手机号实名制了，手机号可以唯一确定一个人，当然手机号是可以更换的啊，不像名字不能更换。</p>
</div><div class="cl-preview-section"><p>（2）小哥收好阿四的快递（当然，钱是不能少的啊<sup>_</sup>），然后把快递装进自己的小三轮，三轮写着“十里铺配送站”，快递很快就被送到了“十里铺配送站”。</p>
</div><div class="cl-preview-section"><p>（3）十里铺配送站工作人员看到阿四的快递，根据收件人（阿三）的电话号码进行分拣，发现此快递需要发往“港务区配送中心”，随手把此快递装上了写有“港务区配送中心”的车上。</p>
</div><div class="cl-preview-section"><blockquote>
<p>注意！“十里铺配送站”可以给很多配送中心发送快递，但是前提必须要<strong>根据收件人的地址</strong>确定要发往哪个配送中心。比如，此快递不能发往“未央区配送中心”和“西咸新区配送中心”。</p>
</blockquote>
</div><div class="cl-preview-section"><p>（4）当阿四的快递到了“港务区配送中心”以后，工作人员还是要查看收件人地址，根据收件人（阿三）的电话号码进行分拣，发现此快递需要发往“海淀配送中心”，随手把此快递装上了写有“海淀配送中心”的车上。从此石榴开始了从古都到帝都长达一天的旅行��</p>
</div><div class="cl-preview-section"><p>第（5）、（6）步类似第（3）、（4）步工作程序。</p>
</div><div class="cl-preview-section"><p>第（7）步，帝都的快递小哥把阿四的石榴运到“慕课网大厦”，给阿三打电话取走石榴。</p>
</div><div class="cl-preview-section"><p>在整个石榴运送过程中，快递公司的主要职责就是将快递从一个端运送到另一端，至于中间所经过的环节是快递公司自己要关心、解决的问题。对于阿三和阿四来说他们处于两端，他们只关心石榴有没有送到，而不关心石榴是怎么从古都运送到帝都的。</p>
</div><div class="cl-preview-section"><p>在 TCP/IP 协议中呢，网络层的工作职责非常类似快递公司在物流行业的职责，就是负责将数据包从源端主机传输到目的端主机。至于如何完成这一重任，是网络层的所有工作细节。现在让我们开始网络层的学习吧。</p>
</div><div class="cl-preview-section"><h2 id="网络层基本概念">网络层基本概念</h2>
</div><div class="cl-preview-section"><p>假如 Alice 在家里远程访问公司的服务器，数据包的发送过程是啥样的呢？为了便于理解我们展示一张拓扑图，图标的含义可以参考《追本溯源：探寻协议栈的发展历程》一文中拓扑结构的图例：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed862cf00017d1b16150839.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>我们先对拓扑图做一个解释说明。</p>
</div><div class="cl-preview-section"><p>我们把图中 Alice MPB 和 Alice Linux 叫做主机。你有没有发现主机包含了 TCP/IP 完整的协议栈呢？没错，主机是实现了完整的网络协议栈，主机的目的就是提供各种应用。比如，Linux Server 可以提供 Web 服务，个人 PC 可以通过浏览器访问 Web 网站等等。</p>
</div><div class="cl-preview-section"><p>图中标有 R1、R2、R3、R4 的设备叫做<strong>路由器（Router）</strong>。你是不是也发现<a href="https://en.wikipedia.org/wiki/Router_(computing)" title="router"><strong>路由器</strong></a>只包含 TCP/IP 协议栈中的三层：<strong>物理层</strong>、<strong>链路层</strong>、<strong>网络层</strong>？没错，<strong>路由器</strong>的主要职责是提供<strong>路由选择</strong>和<strong>转发</strong>。由各种不同功能类型的路由器和交换机共同组成了数据通信网，非常类似快递公司配送系统。</p>
</div><div class="cl-preview-section"><p>路由器是分组交换网络中的核心设备，每个路由器都有很多端口。用网线将不同路由器的端口相互连接组成了庞大的数据通信网。我们所说的<strong>转发</strong>是指路由器将输入端口的数据包转发到输出端口，由于输出端口有很多，数据包到底转发到哪个端口呢？路由器首先查看数据包的<strong>网络层头</strong>，其中填写了目的 IP 地址（类似收件人电话号码），会查询<strong>路由表</strong>，路由表中记录了目的 <strong>IP</strong> 地址和输出端口的对应关系。这是不是很类似快递公司的分拣发往下一站呢？</p>
</div><div class="cl-preview-section"><p>那么路由表是怎么形成的呢？路由器的控制平面有一套动态选路算法，比如，RIP、OSPF等。当然你也可以手动配置路由表。我们把路由表项的形成过程叫做<strong>路由选择</strong>。路由算法有很多，属于路由器的一部分，本文不再展开讲解。</p>
</div><div class="cl-preview-section"><p>网络层的具体实现一般都在操作系统内核协议栈中实现的。比如，linux、windows、unix 等。</p>
</div><div class="cl-preview-section"><p>你现在是不是可以结合快递配送过程，分析一下从 Alice MBP 发送一个分组到 Alice Linux 的过程（图中标出了 5 个过程）呢？</p>
</div><div class="cl-preview-section"><blockquote>
<p>说明：<br>
我们在讲 TCP/IP 协议族的时候，把链路层和物理层统一放在链路层讲解。之所以这样，是因为我们更多关心的是软件层面的内容。为了拓扑图的完整性，我们明确标出了物理层。</p>
</blockquote>
</div><div class="cl-preview-section"><p>你是否还记得我们在学习链路层的时候，目的 MAC 地址和源 MAC 地址是保存在帧头中？同样，网络层的 <strong>Header</strong> 叫做 <strong>IP Header</strong>。<strong>IP Header</strong>包含发送主机的 <strong>IP 地址</strong>和接收主机的<strong>IP 地址</strong>。接下来我们先看一下 <strong>IP Header</strong>格式。</p>
</div><div class="cl-preview-section"><h2 id="ipv4-header-格式">IPv4 Header 格式</h2>
</div><div class="cl-preview-section"><p>我们把 IPv4 Header 通过一张图来展示。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed862e1000187c711430405.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>Version</strong>： 长度是 4 个 bit ，表示 IP 协议的版本，IPv4 的值是 4。对于 IPv6，此值是 6。IPv1、IPv2、IPv3、IPv5 都是实验版本；</p>
</li>
<li>
<p><strong>Header Len</strong>：长度是 4 个 bit，由于 IP Header 支持可选的头字段（Option），Header 长度是可变的，必须通过一个专门的字段来记录 IP Header 的长度。Header Len 单位是 4 字节的个数，最小取值是 5，即 20 字节长，表示只是包含 20 字节长的基本头字段，没有任何选项字段；最大取值是 2^4 - 1 = 15，即 60 字节长，表示除了包含 20 字节的基本头字段，还可以额外包含 40 字节的选项字段；</p>
</li>
<li>
<p><strong><a href="https://en.wikipedia.org/wiki/Differentiated_services" title="dscp">DSCP</a>（Differentiated Services Code Point）</strong>：长度是 6 个 bit，主要是用于 IP 网络上的流量管理和 QoS 机制。可以简单理解为对数据包进行优先级设置，以便路由器进行做出更好的选择。比如在音视频通信中，我们希望语音包能优先传输，所以可以通过设置 DSCP 来达到此目的。在 WebRTC 规范中针对 DSCP 应用有专门的定义。DSCP 和 ECN 字段早期是叫 TOS（Type Of Service），但是基本没什么用，后来索性改成现在这个样子了；</p>
</li>
<li>
<p><strong>ECN（Explicit Congestion Notification）</strong>：长度是 2 个 bit，主要是用于拥塞控制的；</p>
</li>
<li>
<p><strong>Total Length</strong>：长度是 16 个 bit，表示 IP Header 和 Payload 的总长，单位是字节；</p>
</li>
<li>
<p><strong>Identification</strong>：长度是 16 个 bit，用于标识 IP 分组的，主要是在 IP 分片中使用；</p>
</li>
<li>
<p><strong>Flags</strong>：长度是 3 个 bit，也是和数据包分片有关；</p>
</li>
<li>
<p><strong>Fragment Offset</strong>：长度是 13 个 bit，用于标识某个分片在分组中的偏移量。</p>
</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：</p>
<ul>
<li>你还记得链路层数据帧最大传输限制是通过 MTU 来表示的吗？不同的链路层实现 MTU 值是不一样的。如果网络层发给链路层的分组长度超过 MTU 限制，会产生 ICMP 错误。为此，IP 层支持了分片的机制，将一个 IP 分组拆分成多个 <strong>分片（Fragment）</strong>，保证能正常传输。当然在接收端网络层要进行<strong>分片</strong>的重组；</li>
<li>在实际应用中，我们应该尽量不要让消息长度超过 MTU 的限制。因为 IP 层在发送的时候进行分片，接收端进行重组，会带来额外开销，导致性能下降。比如，我们传输一帧视频图像，会按照 MTU 限制切分成多个分片，然后再打包成 RTP 包发送的。</li>
</ul>
</blockquote>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>TTL（Time To Live）</strong>：长度是 8 个 bit，表示分组在网络中的存活时间，即路由器能够转发的次数(hop)。一般由源主机设置此值，通常设置 64，每当分组被路由器转发一次，TTL 就会被减 1。如果 TTL 变成 0，分组就会被丢弃。你可以通过系统 ping 命令去 ping 慕课网主站，体验一下 TTL 的变化；</p>
</li>
<li>
<p><strong>Protocol</strong>：长度是 8 个 bit，表示传输层协议类型，比如 TCP 是 6；</p>
</li>
<li>
<p><strong>Header Checksum</strong>：长度是 16 个bit，用于差错检测；</p>
</li>
<li>
<p><strong>Source IP Address</strong>：长度是 32 个 bit，表示源 IPv4 地址；</p>
</li>
<li>
<p><strong>Destination IP Address</strong>：长度是 32 个 bit，表示目标 IPv4 地址；</p>
</li>
<li>
<p><strong>Options</strong>：长度最大是 40 个字节，不常用。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>介绍完了 IPv4 Header 格式，我们看一下 IPv4 地址格式。</p>
</div><div class="cl-preview-section"><h2 id="ipv4-地址格式">IPv4 地址格式</h2>
</div><div class="cl-preview-section"><p>打开你的系统命令行，如果是 Windows 系统，请输入 ipconfig；如果是 linux 或者是苹果系统，请输入 ifconfig。比如我的 Windows 系统显示结果如下：</p>
</div><div class="cl-preview-section"><pre><code>无线局域网适配器 无线网络连接：// 无线网卡
   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::f874:7548:3239:a10d%13
   IPv4 地址 . . . . . . . . . . . . : 192.168.0.100 // IPv4 地址
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.0.1
</code></pre>
</div><div class="cl-preview-section"><p>可以看到我的无线网卡绑定了一个 IPv4 的地址 192.168.0.100。接入互联网的每一个主机，至少有一个网卡配置了 IP 地址，这个 IP 地址和主机是唯一绑定的。当然每一个<strong>路由器</strong>端口必须配置一个 IP 地址，用于唯一标识此路由器端口。</p>
</div><div class="cl-preview-section"><p>IPv4 地址长度是 32 bit，4 个字节，每个字节是独立取值，通常用点分十进制的形式表示。例如，192.168.0.100。IPv4 地址范围是 0.0.0.0 ~ 255.255.255.255，最多包含 4294967296（2^32) 个 IP 地址。这么多 IP 地址是通过一定的原则进行划分的，主要是通过子网划分来体现的。</p>
</div><div class="cl-preview-section"><h2 id="子网划分">子网划分</h2>
</div><div class="cl-preview-section"><p>IP 网络是由通信子网组成，所谓<strong>通信子网</strong>是一个路由器端口下面所有主机或者其他设备组成的网络。同一个路由器端口下面的所有主机属于同一个网络，可以说拥有同一个网络 ID，然而每个主机都有自己的<strong>主机 ID</strong>。通过把 IP 地址划分成<strong>网络 ID</strong>和<strong>主机 ID</strong>两部分来达到此目的。拿 192.168.0.100 来说，主机 ID 和 网络 ID 划分如下：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed862fe00018c8202610106.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>最早的 IP 地址划分非常简单，只有最高 8 个 bit 表示网络 ID，剩下的 24 个 bit 表示主机 ID。如下：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed86311000186a408160095.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>然而，这样的划分最多只能表示 <code>2^8 = 256</code> 个网络，很快就不够用了。于是 1981 年重新修订了 IP 地址规范，引入了<strong>分类网络架构（classful network）</strong>，此架构将网络分为如下几类：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed8633900011c9309070541.png" alt="图片描述"><br>
对 IP 地址分类以后，每一类的范围如下：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>分类</th>
<th>起始地址</th>
<th>结束地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>0.0.0.0</td>
<td>127.255.255.255</td>
</tr>
<tr>
<td>B</td>
<td>128.0.0.0</td>
<td>191.255.255.255</td>
</tr>
<tr>
<td>C</td>
<td>192.0.0.0</td>
<td>223.225.255.255</td>
</tr>
<tr>
<td>D</td>
<td>224.0.0.0</td>
<td>239.255.255.255</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p>这样划分相对于最早的划分确实进步了很多，可以划分更多的网络。然而这样的划分缺乏灵活性，对于 A 类地址来说网络 ID 只有 <code>2^7 = 128</code> 还是少，但是主机ID 多达 <code>2^24 = 16777216</code>，浪费很大。对于 C 类地址来说网络 ID 可以有 <code>2^21 = 2097152</code>，但是主机 ID 只有 <code>2^8 = 256</code> 个，对于有些组织来说根本不够分。于是 1993 年出现了 CIDR（Classless Inter-Domain Routing）的编址策略，叫做<strong>无类别域间路路由选择</strong>。</p>
</div><div class="cl-preview-section"><p>CIDR 编址是一种 IP 地址的压缩表示方式，将 IP 地址分为<strong>网络前缀</strong>和<strong>主机标识</strong>两部分，形如 a.b.c.d/x 的表示方式，x 是一个小于 32 的十进制数字，代表网络前缀占用 x 个比特，主机标识占用 32-x 个比特。比如，200.101.80.0/20 表示网络前缀占用 20 个比特，主机标识占用 12 个比特。</p>
</div><div class="cl-preview-section"><p>在 CIDR 编址方式下，如何通过 IP 地址快速确定网络 ID 呢？是通过<strong>子网掩码</strong>来确定的。对于形如 a.b.c.d/x 的子网，子网掩码是由 x 个 bit 1 和 32 - x 个 bit 0 组成的二进制数。只要把 a.b.c.d 和子网掩码做一个按位与(&amp;)运算，就可以得到网络 ID。可以说，形如 a.b.c.d/x 的表示，可以唯一确定一个网络 ID，我们通常把 a.b.c.d/x 表示叫做<strong>网段</strong>。你可以说 a.b.c.d/x 表示了一个网段，网段就是形如 a.b.c.d/x 的表示形式。</p>
</div><div class="cl-preview-section"><p>比如，200.101.80.0/20 网段的子网掩码的二进制形式是 11111111 11111111 11110000 00000000，十进制形式是 255.255.240.0。将 200.101.80.0 和 255.255.240.0 做按位与(&amp;)运算，得到的网络 ID 是 200.101.80.0。</p>
</div><div class="cl-preview-section"><p>那么 IP 地址 200.101.96.1 是 200.101.80.0/20 网段的 IP 吗？我们只需要把 200.101.96.1 和 255.255.240.0 做一个按位与（&amp;）运算，查看结果是否等于 200.101.80.0 即可。</p>
</div><div class="cl-preview-section"><p>采用 CIDR 编码方式优势如下：</p>
</div><div class="cl-preview-section"><ul>
<li>简单灵活</li>
<li>有效利用 IP 地址空间</li>
<li>减小路由表规模</li>
</ul>
</div><div class="cl-preview-section"><p>比如 200.101.80.0/20 网段中的 IP 地址 200.101.80.100，如果按照分类，属于 C 类地址，网络 ID 占用 24 个 bit，主机 ID 占用 8 个 bit；如果采用 CIDR 方式，网络 ID 占用 20 个 bit，主机 ID 占用 12 个 bit。对于主机较多的网络，极大地提高了 IP 地址的利用率。</p>
</div><div class="cl-preview-section"><p>其实提高 IP 地址的利用率的研究一直没有停止，下来我们再了解一下<strong>私有地址</strong>的概念。</p>
</div><div class="cl-preview-section"><h2 id="ipv4-私有地址划分">IPv4 私有地址划分</h2>
</div><div class="cl-preview-section"><p>随着互联网的飞速发展，每个家庭都有家庭网络，小型企业办公网络也越来越多。拿家庭网来说，家庭成员基本人手一部手机，还有笔记本、台式电脑、IP 电视等等设备。如果按照 TCP/IP 最早的设计，每一个设备都配有全局唯一的 IP 地址，所谓的端到端能互相访问的公网 IP，一方面对早期 IPv4 来说是不够用的(IPv4 最多 40 亿）；另一方面，完全没有这个必要，毕竟你也不希望别人随时随地连接你的手机，对吧？所以私有 IP 地址应用而生了，特别是在家庭网络和企业网，有着非常广泛的应用。目前，家庭网络的私有网段主要是 192.168.0.0/16 ，比如我的电脑的私有 IP 是 192.168.0.100/24。私有 IP 分块如下：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>CIDR 块</th>
<th>范围</th>
<th>分类描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0.0.0/8</td>
<td>10.0.0.0 – 10.255.255.255</td>
<td>单块 A 地址</td>
</tr>
<tr>
<td>172.16.0.0/12</td>
<td>172.16.0.0 – 172.31.255.255</td>
<td>16 块连续 B 类地址</td>
</tr>
<tr>
<td>192.168.0.0/16</td>
<td>192.168.0.0 – 192.168.255.255</td>
<td>256 块连续 C 类地址</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><blockquote>
<p>注意！私有地址只是划分了三块，你可以根据自己的需要再次进行子网划分。</p>
</blockquote>
</div><div class="cl-preview-section"><p>请记住：私有 IP 地址只能在某个组织（家庭、企业）网络内部使用，互联网主机是无法主动访问配有私有 IP 地址的主机的。那么私有 IP 是如何在互联网中工作的呢？</p>
</div><div class="cl-preview-section"><h2 id="nat-工作原理">NAT 工作原理</h2>
</div><div class="cl-preview-section"><p>我们知道可以在家庭网络中配置私有 IP，那每个家庭都可以配置相同的私有 IP 吗？答案是肯定的。其中奥妙就是<strong>网络地址转换协议</strong>（NAT，Network Address Translation）在发挥作用。当你向运营商申请了宽带账户以后，会给你一个光信号 Modem，为你分配一个公网 IP 地址。你只需要再购买一个支持 Wifi 的路由器连接到光信号 Modem，将光信号 Modem 连接到运营商网络，你就可以访问互联网了。</p>
</div><div class="cl-preview-section"><p>目前国内的家庭无线路由器分配的网段基本都是 192.168.1.0/24。我们说 IP 地址和主机必须一一对应，不能出现冲突。如果每个家庭网络都配置相同的私有网段，IP 地址不就冲突吗？这又该如何解释呢？那就让我们分析一下 NAT 的基本工作原理吧。我们分析一下 Alice 在家里上网，访问公司服务器的过程。<br>
<img src="https://img.mukewang.com/5ed863510001c66c10040473.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>关于图中所展示的信息说明：</p>
</div><div class="cl-preview-section"><ul>
<li>图中的路由器 R1 是 Alice 的无线路由器，其中的一个端口配置了 192.168.0.1/24 网段，作为内网网段；另外一个端口配置的是 147.1.88.2/20 网段，作为公网网段；</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：<br>
如果路由器的某个端口连接了主机的话，那么路由器的此端口必须要配置 IP 地址。路由器端口的下连接的所有主机的 IP 地址必须和路由器端口在同一个网段。</p>
</blockquote>
</div><div class="cl-preview-section"><ul>
<li>Alice 的笔记本配置的 IP 地址是 192.168.0.101/24；</li>
<li>Alice公司服务器配置的 IP 地址是 200.1.100.2/24；</li>
<li>在路由器 R1 内部有一张 <strong>NAT 映射表</strong>，记录了私有 IP 和公网 IP 的映射关系；</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：</p>
<ul>
<li>通常家庭网络的公网出口 IP 地址只有一个，实际情况比较复杂，有的运营商给的是固定 IP，有的运营商给的不是固定 IP。很有可能运营商给你的家庭 Modem 配置的 IP 地址还是私有 IP。</li>
<li>NAT 映射表的记录，只有内网访问外网才会生成，并且每条记录都有存活时间。作者曾经遇到一个情况是，客户把 NAT 映射记录的存活时间设置为 5 分钟，导致网络业务每隔 5 分钟断线一次。所以你在工作中遇到类似频繁断线的问题，可以从这方面考虑一下。</li>
</ul>
</blockquote>
</div><div class="cl-preview-section"><ul>
<li>图中演示的数据包，不是标准的 IP Header 格式。对于源和目的地址，我们用了 IP：Port 的形式，Port 表示端口号，是传输层的概念，在后面专栏会详细介绍。因为 NAT 映射需要关心<strong>端口</strong>，我们只能这样表示一下，也算是权宜之计吧；</li>
</ul>
</div><div class="cl-preview-section"><p>现在来分析一下 Alice 的笔记本通过家庭网络访问公司服务器的过程中，NAT 是如何工作的。在图中我们用序号标出了六个过程，前三个是发送过程，后三个是接收过程。</p>
</div><div class="cl-preview-section"><ol>
<li>
<p>当 Alice 的 MBP 要发送数据包时，操作系统的网络层和传输层将会为每个待发送的数据包添加<strong>目的地址</strong> 200.1.100.2:80 和<strong>源地址</strong> 192.168.0.101:5000，然后发往路由器 R1。如图中步骤 (1)；</p>
</li>
<li>
<p>当路由器 R1 收到 Alice 的 MBP 发送的数据包以后，根据<strong>源地址</strong>查找 NAT 映射表，如果 NAT 映射表中有此记录，就取出公网地址；如果没有就重新生成一个公网地址到本地地址的映射，然后记录在 NAT 映射表中。比如，路由器 R1 的公网地址 147.1.88.2:322。如图中步骤 (2)；</p>
</li>
<li>
<p>将源地址替换成 147.1.88.2:322，然后发往公网出口。如图中步骤 (3)；</p>
</li>
<li>
<p>当数据包通过互联网到达 Alice 的服务器 200.1.100.2/24 以后，Alice 的服务器会执行相应的接收逻辑，然后发送响应数据包给 Alice 的 MBP。此时，响应数据包会通过企业出口路由器发往互联网。如图中步骤 (4)；</p>
</li>
<li>
<p>当响应数据包到达路由器 R1 以后，R1 会根据响应数据包的<strong>目的地址</strong>查找 NAT 映射表，找出对应的本地地址，即 192.168.0.101:5000。如图中步骤 (5)；</p>
</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p>注意！从公网到内网查找 NAT 映射表，如果没有查到相应记录，数据包会被路由器丢掉。</p>
</blockquote>
</div><div class="cl-preview-section"><ol start="6">
<li>路由器 R1 将响应数据包的目的地址修改成 192.168.0.101:5000，发往 Alice MBP。如图中步骤 (6)。</li>
</ol>
</div><div class="cl-preview-section"><p>NAT 协议的优点很明显，一方面可以提高 IP 地址的利用率，另一方面可以保护主机安全，同时也带来了很多麻烦。比如，假如两台主机想直接通信，必须实现 NAT 穿越，否则是无法之间互通的，这就又引出了 P2P 穿越的问题，P2P 穿越在 1 对 1 通信中非常流行，你要是有兴趣可以自行查阅相关资料。</p>
</div><div class="cl-preview-section"><p>我们已经学完了子网划分、IP 地址分类的历程、以及 NAT 的工作原理，现在该学习一下<strong>路由表</strong>了。还记得 Alice 的主机给 Alice 的服务器发送数据包需要查询<strong>路由表</strong>的事情吗？</p>
</div><div class="cl-preview-section"><h2 id="路由表">路由表</h2>
</div><div class="cl-preview-section"><p><strong>路由表</strong>也叫<strong>路由信息库</strong>是保存在主机或者<strong>路由器</strong>上的一种数据存储结构，主要是用于保存目标网络的转发路径。</p>
</div><div class="cl-preview-section"><blockquote>
<p>注意：</p>
<ol>
<li>路由表里面并没有记录所有目标主机的完整转发路径，只是记录了数据包发往下一跳（主机或者路由器）应该从哪个接口发送出去， 所谓的逐跳(hop-by-hop)转发。</li>
<li>路由表认为下一跳（hop）是最接近目标主机的，整个转发路径是单向的、没有环路的。</li>
<li>路由表的记录是通过 RIP、OSPF、BGP 等协议形成的。关于路由表的形成不是我们本章要关注的内容。</li>
</ol>
</blockquote>
</div><div class="cl-preview-section"><p>不同系统对路由表的实现可能略有差异，但是必须包含以下内容：</p>
</div><div class="cl-preview-section"><ul>
<li><strong>目标（Destination）</strong>：这是数据包转发的目标网络。取值可以是网络 ID、主机 IP、默认路由（0.0.0.0）；</li>
<li><strong>网络掩码（Genmask）</strong>：类似我们之前介绍的子网掩码的作用，用于和目标 IP 地址实现按位与（&amp;）运算，寻找最佳匹配结果；</li>
<li><strong>网关（Gateway）</strong>：表示数据包要转发的下一跳（hop）地址；</li>
<li><strong>接口（Interface）</strong>：网卡接口，表示数据包从路由器或者主机的哪一个网卡发往下一跳。</li>
</ul>
</div><div class="cl-preview-section"><p>由于没有真实的路由器可以实验，通过主机的路由表也可以说明问题。我的 Ubuntu 18.04 的路由表：</p>
</div><div class="cl-preview-section"><pre><code>ubuntu@ip-172-31-3-221:~$ route
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         ip-172-31-0-1.u 0.0.0.0         UG    100    0        0 eth0
172.31.0.0      0.0.0.0         255.255.240.0   U     0      0        0 eth0
ip-172-31-0-1.u 0.0.0.0         255.255.255.255 UH    100    0        0 eth0
</code></pre>
</div><div class="cl-preview-section"><p>Windows 10 的路由表：</p>
</div><div class="cl-preview-section"><pre><code>           网络目标        网络掩码               网关          接口        跃点数
          0.0.0.0          0.0.0.0         192.168.0.1    192.168.0.102     55
        127.0.0.0        255.0.0.0            在链路上         127.0.0.1    331
        127.0.0.1  255.255.255.255            在链路上         127.0.0.1    331
  127.255.255.255  255.255.255.255            在链路上         127.0.0.1    331
      192.168.0.0    255.255.255.0            在链路上     192.168.0.102    311
    192.168.0.102  255.255.255.255            在链路上     192.168.0.102    311
    192.168.0.255  255.255.255.255            在链路上     192.168.0.102    311
        224.0.0.0        240.0.0.0            在链路上         127.0.0.1    331
        224.0.0.0        240.0.0.0            在链路上     192.168.0.102    311
  255.255.255.255  255.255.255.255            在链路上         127.0.0.1    331
  255.255.255.255  255.255.255.255            在链路上     192.168.0.102    311
</code></pre>
</div><div class="cl-preview-section"><p>观察 Windows 10 和 Ubuntu 18.04 的路由表，你会发现：</p>
</div><div class="cl-preview-section"><ul>
<li>两个路由表都包含了目标、掩码、网关、接口四项，这是必须包含的四项内容，其他几项略微有些差异，但是关系不大；</li>
<li>路由表<strong>目标</strong>（Destination）一项的取值，包含了 “default 、0.0.0.0 、IP、网络 ID” 几种情况。其中，取值 default 和 0.0.0.0 所表示的实含义是一样的，都表示<strong>缺省路由</strong>，default 是 Linux 系统的表示，0.0.0.0 是 Windows 系统的表示；</li>
<li>Ubuntu 路由表的<strong>网关</strong>一项有取值是 0.0.0.0 的情况，表示不能进行下一跳转发，只能进行局域网内转发。Windows 的路由表针对这种情况，网关直接用“在链路上”表示；</li>
<li>Ubuntu 路由表还有 Flags 一项。其中有三个标记，U 表示 路由可用，G 表示是下一跳是网关，H 表示是直接转发。</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：</p>
<ul>
<li>在 Windows 系统查看路由表的命令是 netstat -rn 或者 route print。</li>
<li>在 Linux 系统查看路由表的命令是 route -rn 或者 route。</li>
</ul>
</blockquote>
</div><div class="cl-preview-section"><h2 id="路由匹配算法">路由匹配算法</h2>
</div><div class="cl-preview-section"><p>路由表采用<strong>最长前缀匹配算法</strong>，为了理解起来更直观，我们以上一节 Ubuntu 18.04 的路由表为例，通过一张图来展示路由匹配算法。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed86374000104af16970596.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>对上图做一个解释：</p>
</div><div class="cl-preview-section"><ul>
<li>
<p>首先把路由表每一项进行编号，用 i 来表示。每一项的掩码用 m(i) 表示，每一项的目标用 d(i) 表示；</p>
</li>
<li>
<p>以三个目标 IP 地址为例，分别是 172.31.0.1, 172.31.6.1, 134.31.6.6；</p>
</li>
<li>
<p>遍历路由表的每一项，对目标 IP 和 m(i) 做一个“按位与（&amp;）”运算，把得到的结果填在对应的表格，并且和相应的 d(i) 做比较，如果匹配，需要标出掩码 m(i) 占用 bit 1 的个数；如果不匹配，就标出不匹配；</p>
</li>
<li>
<p>查找所有匹配项里面掩码 m(i) 占用 bit 1 的个数最多的一项，此项就是下一跳路由的路径。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>利用这个规则为 172.31.0.1, 172.31.6.1, 134.31.6.6 三个 IP 地址寻找最佳匹配。你会发现：</p>
</div><div class="cl-preview-section"><ul>
<li>172.31.0.1 和路由表每一项的<strong>目标</strong>值都匹配，但是最佳匹配是编号为 3 的表项；</li>
<li>172.31.6.1 只和编号为 1 和编号为 2 的表项都匹配，但是最佳匹配是编号为 2 的表项；</li>
<li>134.31.6.6 只和编号唯一的表项匹配。这是一条默认路由表项。</li>
</ul>
</div><div class="cl-preview-section"><p>我们把上面这个计算规则叫做<strong>最长前缀匹配算法</strong>。</p>
</div><div class="cl-preview-section"><p>通常只有路由器才能完成不同网络的路由转发，从而实现端到端的传输。而对于主机来说，如果目标地址不是同一局域网内的其他主机，那么都会通过默认路由发往自己的网关。网关 IP 一般是主机所在的路由器端口所配置的 IP 地址。</p>
</div><div class="cl-preview-section"><p>你已经了解了路由表的细节，下来我们再总结一下路由转发过程。还记得 Alice 的 MBP 向她的 Linux 发送数据包，当数据包经过路由器时，需要查��路由表的事情吗？</p>
</div><div class="cl-preview-section"><h2 id="路由转发过程">路由转发过程</h2>
</div><div class="cl-preview-section"><p>你在《刨根究底_数据链路层是如何工作的》一文中学习了“在同一个网络下，数据包在各节点之间是如何传输的”。通过本文的学习，我们知道：”当数据包在不同网络之间传输时，路由器是通过查找路由表，以逐跳转发的方式，最终将数据包发送到对端”。路由器的使命就是实现端到端的数据转发。现在，我们将网络层和链路层结合起来，分析一下不同网络之间的数据包转发过程。先看下图：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed8638a000170d213410577.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>首先对上图做一个说明：</p>
</div><div class="cl-preview-section"><ul>
<li>我们的目的是为了演示数据包的路由转发过程，所以���中只画出了主机和路由器，算是一个示意图，不是完整的拓扑图；</li>
<li>图中三台路由器用 R1、R2、R3 表示；</li>
<li>每一台路由器都有一个 L1 和 L2 接口；</li>
<li>每一个路由器接口都必须配有 IP 地址，我们没有画出来；</li>
<li>每一个路由器接口都配有 MAC 地址，我们用“路由器名-接口名”，即 Rx-Lx 的形式表示。；</li>
<li>主机的 MAC 用 S-MAC 和 D-MAC 表示，主机的 IP 用 S-IP 和 D-IP 表示；</li>
<li>在数据包中，我们只是标出了链路层和网络层的头，没有标出Payload 和 传输层头；</li>
<li>包头中的 src mac 和 dst mac 分别表示源 MAC 和目的 MAC；</li>
<li>包头中的 src ip 和 dst ip 分别表示源 IP 和 目标 IP。</li>
</ul>
</div><div class="cl-preview-section"><p>Alice 的 MBP 向她的 Linux 主机发送数据包的过程如下：</p>
</div><div class="cl-preview-section"><ul>
<li>
<p>Alice MPB 要发送分组，主机的网络层一般都是直接查询路由表，然后发给网关，也就是路由器 R1 的 L1 接口。所以 dst mac 是 R1-L1，src mac 是 S-MAC。dst ip 是 Alice Linux 主机的 IP，src ip 是 Alice MBP 的 IP；</p>
</li>
<li>
<p>R1 收到分组以后查询路由表，最佳匹配应该是转发到 R1-L2 接口。R1-L2 接口会执行链路层逻辑，查询 ARP 表，将 dst mac 换成 R2-L1，将 src mac 换成 R1-L2。网络层的 dst ip 和 src ip 保持不变，因为执行的是端到端的传输；</p>
</li>
<li>
<p>在分组经过的每一个路由器节点，都要执行步骤二中的逻辑；</p>
<blockquote>
<p>提示：</p>
<p>在路由转发过程中，数据包的的 src mac 和 dst mac 一直在变化，而 src ip 和 dst ip 保持不变。</p>
</blockquote>
</li>
<li>
<p>最终，Alice MPB 发送的数据包会被通信子网中的设备转发到 Alice Linux。这是不是类似快递的转发过程呢？收件人、发件人的地址不变，但是快递配送中心一直在更换呢？</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>好了，到此为止，关于 IP4 相关的知识介绍完了，内容比较多，不知道你理解的如何呢？</p>
</div><div class="cl-preview-section"><h2 id="总结">总结</h2>
</div><div class="cl-preview-section"><p>本文的开篇，我们演示了快递的传输过程，目的是让你对转发有一个感性的认识。接着我们以网络层的基本概念为切入点，逐层展开，介绍了 IPv4 Header 格式、IPv4 地址格式、子网划分、NAT工作原理、路由表的细节，最后结合网络层和链路层对数据分组的转发过程做了一个总结。</p>
</div><div class="cl-preview-section"><p>关于路由表的形成，涉及到了网络层的另外一个主题，主要是各种路由协议，内容也是相当丰富，我们没有展开介绍，如果你有兴趣，可以自行查阅资料学习。</p>
</div><div class="cl-preview-section"><p>到此为止，你可以回头再复习一下链路层的知识，总结一下<strong>通信子网</strong>是如何完成端到端传输的。接下来，我们就应该学习<strong>传输层</strong>的相关知识了。</p>
</div><div class="cl-preview-section"><h2 id="思考时间">思考时间</h2>
</div><div class="cl-preview-section"><ol>
<li>
<p>通过本文学习，我相信你应该感受到 IP 地址是一个宝贵资源，肯定是受控的。请了解一下公网 IP 的申请过程。</p>
</li>
<li>
<p>如果一个网络中有很多主机，这些主机的 IP 地址是管理员手动配置还是主机自动配置呢？如果是主机自动配置，请描述主机自动配置 IP 的工作原理。（提示：请学习一下 DHCP 的工作原理）。</p>
</li>
<li>
<p>请总结一下几类特殊 IP 地址，并且描述一下它们的应用场景。</p>
</li>
</ol>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img2.mukewang.com/5ed9fc17000109e706700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥58.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=80">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '05 刨根究底：网络层是如何工作的？',
					'CID': '2094',
					'Teacher': '陈子兴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "05 刨根究底：网络层是如何工作的？",
                    desc: "学好通用知识，提升技术竞争力",
                    imgUrl: 'https:https://img1.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    otherImgUrl: 'https://img1.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/80',
                    link: 'https://m.imooc.com/read/80'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
