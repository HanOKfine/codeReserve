<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>22 函数进阶：作用域与闭包（下篇）</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="揭开被“简单易学”掩盖的Python真相">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "1";
	var chapter_id = "2304";
	var chapter_title = "22 函数进阶：作用域与闭包（下篇）";
	var aid = "79";
	var a_name = "Python 核心技术精讲";
	var a_price = "78.00";
	var a_pic = "https://img.mukewang.com/5ee98cca00018e2a05400720.jpg";
	var userId = 0;

	var column_id = '79';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-08-24&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			22 函数进阶：作用域与闭包（下篇）
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img.mukewang.com/5f43196600012bc306400426.jpg')"></div>
	
	
		<a href="/read/79">
			<div class="course-entry">
				<img src="https://img1.mukewang.com/5edcf963000148bc05200501-40-40.jpg" alt="郭元锴">
				<h3>Python 核心技术精讲</h3>
				<p>郭元锴 · BAT高级研发工程师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">自信和希望是青年的特权。<p class="author">——大仲马</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><p>接着《函数进阶：作用域与闭包》上篇的内容，我们继续来了解其余的知识点。</p>
</div><div class="cl-preview-section"><h2 id="python-作用域中的其他情况">Python 作用域中的其他情况</h2>
</div><div class="cl-preview-section"><p>在 Python 作用域体系中，除了我们前面提到的 LEGB 四种作用域，还有一些特定的情况需要我们注意。</p>
</div><div class="cl-preview-section"><h3 id="非限定名称查找与属性引用">非限定名称查找与属性引用</h3>
</div><div class="cl-preview-section"><p>LEGB 原则针对的是代码中的非限定名称的解析查找，这些名称中不包含点号 <code>.</code> ，比如上面嵌套函数中的 <code>a</code>、<code>b</code>、<code>c</code>。对于类似于 <code>object.attr</code> 这种对象属性引用的访问形式来说，<code>attr</code> 的查找并不遵循 LEGB 原则，它会在对象中查找，我们在面向对象的章节中再了解，但对于 <code>object.attr</code> 中的名称 <code>object</code> 来说，它的查找仍然是遵循 LEGB 原则的。</p>
</div><div class="cl-preview-section"><h3 id="for-循环中赋值的变量名称"><code>for</code> 循环中赋值的变量名称</h3>
</div><div class="cl-preview-section"><p>从下面的代码中可以看到，对于 <code>for</code> 循环代码块中赋值的变量名称，在 <code>for</code> 循环外部也可以访问，并不是局部变量。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">0</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="推导表达式中赋值的变量名称">推导表达式中赋值的变量名称</h3>
</div><div class="cl-preview-section"><p>和 <code>for</code> 循环语句块中赋值的名称不同的是，推导表达式内部赋值的变量是局部的，在表达式外部不能访问。下面的例子说明了列表推导中赋值的名称是局部的，对于其他的推导语法，比如字典推导、集合推导、生成器推导也是相同的效果，相当于在推导表达式内部也存在一个类似嵌套的局部作用域。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Python 3.X</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>   NameError<span class="token punctuation">:</span> name <span class="token string">'i'</span> <span class="token keyword">is</span> <span class="token operator">not</span> defined
</code></pre>
</div><div class="cl-preview-section"><p>不过需要注意的是，这个特性在 2.X 和 3.X 之间有一些细微的差别，在 2.X 中列表推导中赋值的名称可以在列表推导表达式外部访问，除此之外的其他推导语法和 3.X 相同。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Python 2.X</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span> i
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
NameError<span class="token punctuation">:</span> <span class="token keyword">global</span> name <span class="token string">'i'</span> <span class="token keyword">is</span> <span class="token operator">not</span> defined
</code></pre>
</div><div class="cl-preview-section"><h3 id="try-语句中赋值的变量名称"><code>try</code> 语句中赋值的变量名称</h3>
</div><div class="cl-preview-section"><p>如下面的代码所示，在 <code>try</code> 语句的 <code>except</code> 分句中赋值的异常变量是局部的，可以看出包括 <code>try</code> 以及推导表达式在内，都是相当于定义了更加局部的作用域。但在 Python 2.X 中，这个通过 <code>except</code> 分句赋值的异常变量不是局部的，可以在 <code>try</code> 语句代码块退出仍然保持可访问。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Python 3.X</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
division by zero
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
NameError<span class="token punctuation">:</span> name <span class="token string">'e'</span> <span class="token keyword">is</span> <span class="token operator">not</span> defined
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Python 2.X</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
integer division <span class="token operator">or</span> modulo by zero
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
integer division <span class="token operator">or</span> modulo by zero
</code></pre>
</div><div class="cl-preview-section"><h3 id="类的顶层">类的顶层</h3>
</div><div class="cl-preview-section"><p>从下面的代码中我们可以看到，在 <code>class</code> 语句顶部赋值的变量名称也处于类似函数的局部作用域中，在 <code>class</code> 语句顶层中对名称 <code>a</code> 的查找会先查找 <code>class</code> 语句顶层。 但不同的是，类的顶层并不会像嵌套函数的外层函数那样提供一个嵌套作用域以供类中的方法进行名称解析，正如下面 <code>foo</code> 方法中的 <code>print(a)</code> ，可以看到对名称 <code>a</code> 的解析，不会在 <code>class</code> 语句顶层查找，要访问在<code>class</code> 语句顶层赋值的名称 <code>a</code> ，则需要通过类属性或者实例属性来访问。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     b <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">def</span> <span class="token function">spam</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             a <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t <span class="token operator">=</span> T<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     t<span class="token punctuation">.</span>spam<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">4</span>
<span class="token number">2</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><h2 id="global-与-nonlocal"><code>global</code> 与 <code>nonlocal</code></h2>
</div><div class="cl-preview-section"><p>接下来，我们来了解  <code>global</code> 和 <code>nonlocal</code> 语句的概念，这两个语句进一步丰富了 Python 作用域的场景多样性，并从某种程度上限制了 <code>LEGB</code> 原则。</p>
</div><div class="cl-preview-section"><h3 id="global-语句"><code>global</code> 语句</h3>
</div><div class="cl-preview-section"><p>在 Python 中，<code>global</code> 与 <code>nonlocal</code> 语句起着声明名称命名空间的作用。在一个代码块中使用 <code>global</code> 语句，会将该语句所指定的名称声明为全局变量名称，这些名称将会被映射到全局命名空间中。<code>global</code> 语句限制了对其声明的名称的解析规则，在此之后对这些名称的查找都会直接从全局作用域中开始，若在全局作用域查找无果，则会继续在内置作用域中查找。</p>
</div><div class="cl-preview-section"><p><code>global</code> 语句的直接作用是在局部作用域中��改或创建全局变量，换句话说，如果你想要在局部作用域中（比如函数内部）对全局变量赋值，那么你必须使用 <code>global</code> 来声明它。但如果仅仅是在局部作用域中引用全局变量名称，是不需要进行声明的。</p>
</div><div class="cl-preview-section"><p>首先我们来看在局部作用域中修改全局变量的情况，参考下面两个代码片段，在第一段代码中，我们在局部作用域中对名称 <code>a</code> 进行了赋值，创建了一个新的局部变量，根据 LEGB 查找规则，它并不会影响到全局作用域中已存在的同名变量 <code>a</code> 的搜索；在第二段代码中，我们通过 <code>global</code> 语句将 <code>a</code> 声明为全局变量，并结合随后的赋值语句，从而修改了全局作用域中已存在的名称 <code>a</code> 所引用的对象，并不是像上面那样创建一个新的局部变量。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a
<span class="token number">1</span>
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>接着我们再来看看局部作用域中创建全局变量的情况。下面第一个代码片段中，在函数 <code>test</code> 中创建的 <code>s</code> 是局部变量，所以在全局作用域中查找名称 <code>s</code> 时会抛出 <code>NameError</code> 异常，但在第二段代码中，我们通过 <code>global</code> 语句将 <code>s</code> 映射到全局作用域中，虽然在此之前全局作用域中并不存在该名称，但接下来的赋值语句 <code>s = 'foo'</code> 会在全局作用域中创建 <code>s</code> 。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s <span class="token operator">=</span> <span class="token string">'foo'</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> s
NameError<span class="token punctuation">:</span> name <span class="token string">'s'</span> <span class="token keyword">is</span> <span class="token operator">not</span> defined
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">global</span> s
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    s <span class="token operator">=</span> <span class="token string">'foo'</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> s
<span class="token string">'foo'</span>
</code></pre>
</div><div class="cl-preview-section"><p>对于 <code>global</code> 语句的使用，存在一些相关的功能细节和限制，我们在下面一一列举：</p>
</div><div class="cl-preview-section"><ul>
<li>
<p>在同一代码块中， <code>global</code> 语句里声明的名称不能在 <code>global</code> 语句之前使用：</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
  File <span class="token string">"&lt;stdin&gt;"</span><span class="token punctuation">,</span> line <span class="token number">3</span>
SyntaxError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> assigned to before <span class="token keyword">global</span> declaration
</code></pre>
<pre class=" language-python"><code class="prism  language-python"> <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
    File <span class="token string">"&lt;stdin&gt;"</span><span class="token punctuation">,</span> line <span class="token number">3</span>
  SyntaxError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> used prior to <span class="token keyword">global</span> declaration
</code></pre>
</li>
<li>
<p><code>global</code> 后可以跟着多个名称，并由逗号隔开：</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> b <span class="token operator">=</span> c <span class="token operator">=</span> d <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li>
<p>函数的形参名称不能出现在 <code>global</code> 语句的声明中：</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">2</span>
SyntaxError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> parameter <span class="token operator">and</span> <span class="token keyword">global</span>
</code></pre>
</li>
</ul>
</div><div class="cl-preview-section"><p>另外还有一些其他的非强制限制，比如不能作为 <code>for</code> 循环的控制目标、以及类定义、函数定义、导入语句或者变量标注，虽然目前我们可以在程序中以提到的非强制限制中的方式来编写，但这样做是不好的，因为在未来的 Python 版本中，可能会强制性禁止提到的这些方式。</p>
</div><div class="cl-preview-section"><p><code>global</code> 语句为我们提供了在局部作用域中创建和修改全局变量的技术可能性，这在 Python 中是一种最简单的保持共享数据的方式，借助它你可以不通过传递参数便能在函数间共享某些数据，或为函数的后续调用来记忆上一次调用的数据状态。但在局部作用域中创建和修改全局变量通常在很多种场合下都被认为是一种欠佳的解决方案，因为这样会使得全局变量名称所引用的对象随着函数调用顺序的变化而变化，从而破坏代码的可维护性，并且会导致相关影响全局变量的代码之间的耦合度上升，在出现问题时，你的代码可能会因此变得难以调试。</p>
</div><div class="cl-preview-section"><h3 id="nonlocal-语句"><code>nonlocal</code> 语句</h3>
</div><div class="cl-preview-section"><p>在了解 <code>nonlocal</code> 语句的概念之前，我们先来看看下面两个对比示例。在第一个示例中，我们试图修改嵌套作用域中的 <code>a</code> 所引用的对象，但可以看到抛出了 <code>UnboundLocalError</code> 异常，由此可以看出，在默认情况下， 嵌套作用域只对引用有效而对赋值无效，我们可以在嵌套作用域中查找内嵌函数局部作用域中的名称并且引用对应的对象，但并不能直接在嵌套作用域中进行写入操作。对比第二个示例中，我们使用了 <code>nonlocal</code> 语句来声明名称 <code>a</code>，完成了对于外层嵌套作用域中变量的修改。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
UnboundLocalError<span class="token punctuation">:</span> local variable <span class="token string">'a'</span> referenced before assignment
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>理解了上面的过程，我们再来看 <code>nonlocal</code> 的概念，<code>nonlocal</code> 语句把其后列出的名称声明为非本地变量名称，使得这些名称映射到最近的嵌套作用域（ nearest enclosing scope ）中除全局变量以外的变量上。</p>
</div><div class="cl-preview-section"><blockquote>
<p>Prevents x from becoming a local name in the current scope. All occurrences of x in the current scope will refer to the x bound in an outer enclosing scope.</p>
</blockquote>
</div><div class="cl-preview-section"><p>和 <code>global</code> 语句类似，<code>nonlocal</code> 语句也限制了对其声明的名称的解析规则，不同的是，对 <code>nonlocal</code> 声明的名称的查找都仅限于在嵌套作用域中进行，在嵌套作用域中查找无果时，并不会继续在全局作用域和内置作用域中查找，像下面这样：</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">3</span>
SyntaxError<span class="token punctuation">:</span> no binding <span class="token keyword">for</span> <span class="token keyword">nonlocal</span> <span class="token string">'a'</span> found
</code></pre>
</div><div class="cl-preview-section"><p>根据之前提到的 <code>LEGB</code> 原则中嵌套作用域的存在，我们可以在内嵌函数中引用外层函数局部作用域中的变量，而 <code>nonlocal</code> 的出现，我们不仅可以引用，还可以对嵌套作用域中的变量进行修改赋值，这进一步提升了嵌套作用域的作用，这也是 <code>nonlocal</code> 的主要作用。</p>
</div><div class="cl-preview-section"><p>在引入该特性时，有多个备选关键字（或形式），比如下面所列出的一部分，而选择 <code>nonlocal</code> 的主要原因则是其含义更能反映出特性代表的正确意义，即：它声明的名称不是本地的。<code>nonlocal</code> 语句由 Python 3.0 引入，更多的细节可以参考 <a href="https://www.python.org/dev/peps/pep-3104/">PEP 3104 – Access to Names in Outer Scopes</a> 。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python">scoped x
<span class="token keyword">global</span> x <span class="token keyword">in</span> f<span class="token punctuation">(</span>explicitly specify which scope<span class="token punctuation">)</span>
outer x
<span class="token keyword">nonlocal</span> x
extern x
using x
</code></pre>
</div><div class="cl-preview-section"><p>和 <code>global</code> 相同，<code>nonlocal</code> 后也可以跟多个列出的名称：</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">nonlocal</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z
</code></pre>
</div><div class="cl-preview-section"><p>相比于 <code>global</code> 语句， <code>nonlocal</code> 语句的限制更多一些。<code>nonlocal</code> 语句只能在函数等的局部作用域中使用，比如下面的示例 1。在 <code>nonlocal</code> 后列出的名称，必须已存在（且只能存在）于对应的嵌套作用域中，并且也不能是其中已声明的全局变量，若名称不存在于任何嵌套作用域中则会引发 <code>SyntaxError</code> 异常，这表示我们不能像 <code>global</code> 那样在局部作用域中创建全局作用域中不存在的名称，比如下面的示例 2 和 3。同时，<code>nonlocal</code> 后列出的名称也不能和对应局部作用域中位于 <code>nonlocal</code> 语句之前的已存在的名称冲突，否则同样也会引发 <code>SyntaxError</code> 异常，比如下面的示例 4。另外，我们可以看到在示例 2、3、4 中，异常在 <code>foo</code> 函数定义时就已经抛出，而不是在调用 <code>foo</code> 函数时。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">global</span> a
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">nonlocal</span> a
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">1</span>
SyntaxError<span class="token punctuation">:</span> <span class="token keyword">nonlocal</span> declaration <span class="token operator">not</span> allowed at module level
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">3</span>
SyntaxError<span class="token punctuation">:</span> no binding <span class="token keyword">for</span> <span class="token keyword">nonlocal</span> <span class="token string">'a'</span> found
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 3</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">global</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">5</span>
SyntaxError<span class="token punctuation">:</span> no binding <span class="token keyword">for</span> <span class="token keyword">nonlocal</span> <span class="token string">'a'</span> found
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 4</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
  File <span class="token string">"&lt;input&gt;"</span><span class="token punctuation">,</span> line <span class="token number">5</span>
SyntaxError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> assigned to before <span class="token keyword">nonlocal</span> declaration
</code></pre>
</div><div class="cl-preview-section"><p><code>nonlocal</code> 给嵌套函数提供了可以修改外层函数作用域中变量的可能性，这很重要，我们由此可以给嵌套函数进行状态数据的保持，而不必借助于类等其他更加复杂的方式，比如像下面这样记录函数 <code>foo</code> 被调用的次数：</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         a <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span>
</code></pre>
</div><div class="cl-preview-section"><h2 id="闭包（-closure-）">闭包（ closure ）</h2>
</div><div class="cl-preview-section"><p>在前面的内容中，我们用大量的篇幅对 Python 中作用域相关的概念进行了比较详细的说明，尤其是针对其中的嵌套作用域。这些内容看似枯燥，但对于理解 Python 中更上层概念十分有用处，比如我们即将要介绍的 Python 中闭包的概念（而理解闭包的概念，也有助于我们理解后面要提到的装饰器的概念）。</p>
</div><div class="cl-preview-section"><p>我们以两个对比示例开始，这两个对比示例非常相似，但又有所区分，它们同样都是嵌套函数，但其中之一包含着闭包的概念，另外一个则没有。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         b <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f
<span class="token operator">&lt;</span>function test<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">&gt;</span><span class="token punctuation">.</span>foo at <span class="token number">0x7f23a45bf488</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 示例 2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token operator">=</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         b <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f
<span class="token operator">&lt;</span>function test<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">&gt;</span><span class="token punctuation">.</span>foo at <span class="token number">0x7f23a45e3620</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>看完这两个示例，我们先不说明哪个示例中应用了闭包的能力，我们先思考一个问题，对于示例 1 中 <code>test()</code> 生成的 <code>foo()</code>，它是如何在外层函数代码块已经结束后仍然可以引用到 <code>a</code> 的呢？因为我们知道，一个函数中的局部变量会随着函数的运行结束而消失，同时 <code>a</code> 也并不是一个全局变量或者 <code>foo</code> 内部的局部变量。要理解这个问题，我们还是先来了解闭包的概念，了解这个概念之后，答案就会非常明显。</p>
</div><div class="cl-preview-section"><p>目前在大多数主流编程语言中，都支持闭包。笼统的说，闭包（ Closure ）是一种在将函数作为头等公民的计算机程序设计语言中实现词法作用域下名称绑定的技术。追根溯源，闭包的概念最初是由英国计算机科学家彼得·兰丁在 20 世纪 60 年代定义的，它将闭包定义为一种包含环境部分（ environment part ）和控制部分（ control part ）的实体，这个概念也反映了闭包在实现层面的构成。那么，具体到实现层面来看，闭包由一个函数和其关联环境组成，在内部通常由包含有一个函��地址和一个映射的结构体来实现，在映射中（即对应的环境部分）包含了自由变量的名称-值映射关系。</p>
</div><div class="cl-preview-section"><p>这段描述中，我们提到了两个比较陌生的名词，这里解释一下：</p>
</div><div class="cl-preview-section"><ul>
<li>
<p>将函数作为头等公民的计算机程序设计语言，即该语言支持头等函数（ first-class functions ）。如何理解头等函数的概念？头等函数是函数式编程中的核心要素，它表示我们在程序设计中可以将函数赋值给变量，作为其他函数的参数 / 返回值，以及存储在一些复合数据结构中。比如我们在 Python 中经常使用的内置函数 <code>map(func, *iterables)</code> ，它会将函数作为参数应用在 <code>iterables</code> 中的每一项，我们会在函数式编程的小节中接触更多相关内容。</p>
</li>
<li>
<p>什么是自由变量？下面是关于自由变量在 Python 官方文档中的解释。</p>
<blockquote>
<p>如果名称绑定在一个代码块中，则为该代码块的局部变量，除非声明为  <code>nonlocal</code> 或  <code>global</code> 。<br>
如果名称绑定在模块层级，则为全局变量 （模块代码块的变量既为模块局部变量又为全局变量） 。<br>
如果变量在一个代码块中被使用但不是在其中定义，则为自由变量。</p>
</blockquote>
</li>
</ul>
</div><div class="cl-preview-section"><p>我们需要细化一下上面文档中对于自由变量的描述，参考下面的示例：</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_freevars
<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>这里提到的自由变量，是指在一个代码块中被使用但不再其中被定义的变量。那么对于 <code>foo</code> 来说，按照这个定义的完整自由变量集合既包括 <code>a</code>，也包括 <code>b</code>，但这里我们需要缩小一下范围，我们在闭包中所说的自由变量，指的仅仅是 <code>b</code>，而不包括 <code>a</code>，所以对于我们在闭包场景下所说的自由变量的一个更细化的定义是：</p>
</div><div class="cl-preview-section"><blockquote>
<p>Variables that are used locally, but defined in an enclosing scope.</p>
</blockquote>
</div><div class="cl-preview-section"><p>上面我们讲到了，闭包是一种函数和环境的组合体。但仍然需要进一步细化，闭包不同于函数，它和一个常见函数的不同点在于，闭包使用了自由变量，并且闭包中的自由变量在脱离了定义该自由变量的上下文环境后，仍然可以正常的被使用，这也是在示例 1 中外层函数运行结束后 <code>foo</code> 可以引用到 <code>a</code> 的原因。我们上面在概念中提到，闭包中不仅包括了函数的入口地址，而且包括了函数的关联环境，这个关联的环境便是用于存放这些自由变量和其他相关数据的载体，在 Python 内部，闭包实现的过程和 <code>PyCodeObject</code>、<code>PyCellObject</code>、<code>co_cellvars</code>、<code>co_freevars</code>有关。</p>
</div><div class="cl-preview-section"><p>这里我们基本的说明了闭包的核心概念，那么什么情况下会产生闭包呢？其实上面的概念也能够从某种程度上说明这个问题，不过我们还是举个例子来说明，这样更加明确一些：当我们在一个外层函数中定义了一个内嵌的函数时，如果在这个内嵌的函数中使用了自由变量，那么将在编译过程中产生闭包。这时我们再回过头看看最开始我们定义的两个函数，显而易见的是，在示例 1 中，我们应用了闭包的能力。这里，我们给示例 1 再增加了一些内容，用于说明一些内部的情况。</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     b <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         c <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>__closure__
<span class="token punctuation">(</span><span class="token operator">&lt;</span>cell at <span class="token number">0x7f23a45fc528</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token builtin">object</span> at <span class="token number">0x8ddde0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>cell at <span class="token number">0x7f23a45a46a8</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token builtin">object</span> at <span class="token number">0x8ddde0</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>i<span class="token punctuation">.</span>cell_contents <span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">.</span>__closure__<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_freevars
<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>常常有人将闭包解释为一种可以记住外层函数内部变量的函数（哪怕是外层函数对应的嵌套作用域已不存在），虽然这种解释在直观的角度上来看并没有太大的问题。但我们应该更清楚的了解，闭包不仅仅指的是一种嵌套函数，其更全面的是指一种由函数和环境共同构成的实体。</p>
</div><div class="cl-preview-section"><p>我们可以利用闭包来为内嵌函数保持状态，这样可以简单的代替类的编写，所以有人也将这种方式称为“穷人的类”：</p>
</div><div class="cl-preview-section"><pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> foo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f <span class="token operator">=</span> test<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">11</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">12</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token number">13</span>
</code></pre>
</div><div class="cl-preview-section"><p>另外，产生闭包时通常不会真正执行，闭包在被调用真正执行，所以这也是一种惰性求值的方式，并且也可以用于实现更复杂的控制结构。</p>
</div><div class="cl-preview-section"><h2 id="总结">总结</h2>
</div><div class="cl-preview-section"><p>这一小节中，我们接触了非常多的术语和概念。命名空间是存放和查找一组变量名称的位置；赋值决定一个名称所在的作用域，作用域是名称和实体保持有效的范围，用于描述名称的可见性；而对一个名称引用的解析遵循 LEGB 原则；<code>global</code> 和 <code>nonlocal</code> 进一步限制了 LEGB 原则；闭包则是一种包含函数和环境的组合体，也是我们理解后续装饰器概念的关键。</p>
</div><div class="cl-preview-section"><p>相信不少读者也已经慢慢的发现这个专栏中非常注重概念的描述，有些读者可能也会觉得概念的描述比较枯燥，不如代码或者示例来得直接。但笔者仍然想说明的是，想要结合编程语言的特性说明来合理的描述一个计算机科学中的概念，并做到不产生歧义以及让读者尽可能的容易理解，其实是一件非常有难度的事。而充分的理解这一个个概念、一个个术语的来龙去脉，尽管在短期内对于一部分读者不会有特别大的跃升，但对我们整个编程生涯来说，它必将会产生长远的、有益的影响。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img1.mukewang.com/5f43196b00011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<ul class="comment-content">
				
				<li class="item">
					<a href="/read/commentdetail/7087">
						<img src="https://img4.mukewang.com/5f9393a4000116e501320132-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">开心哥7794047</h4>
						<div class="comment-text">如果变量在一个代码块中被使用但不是在其中定义，则为自由变量。<br />这句话给断个句，用普通话再解释下吧。</div>
						<div>
							
								<div class="reply">讲师回复：同学你好，你所列出的是我在文章中引用的官方文档。在引用的官方文档下方，有专门用于解释什么是自由变量的示例，可以先看一下这部分示例和对应的解释，应该不难理解。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">5天前</span>
						<a href="/read/commentdetail/7087">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="7087" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
			</ul>
			
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥78.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=79">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '22 函数进阶：作用域与闭包（下篇）',
					'CID': '2304',
					'Teacher': '郭元锴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "22 函数进阶：作用域与闭包（下篇）",
                    desc: "揭开被“简单易学”掩盖的Python真相",
                    imgUrl: 'https:https://img.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    otherImgUrl: 'https://img.mukewang.com/5ee98cca00018e2a05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/79',
                    link: 'https://m.imooc.com/read/79'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
