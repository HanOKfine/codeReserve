<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>06 小试牛刀，解剖浮点对象 float</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="突破技术瓶颈，迈向更高岗位">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "11";
	var chapter_id = "1902";
	var chapter_title = "06 小试牛刀，解剖浮点对象 float";
	var aid = "76";
	var a_name = "Python 源码深度剖析";
	var a_price = "68.00";
	var a_pic = "https://img4.mukewang.com/5eb68ab400017cda05400720.jpg";
	var userId = 0;

	var column_id = '76';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-07-23&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			06 小试牛刀，解剖浮点对象 float
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img.mukewang.com/5ebd2a400001a8b506400426.jpg')"></div>
	
	
		<a href="/read/76">
			<div class="course-entry">
				<img src="https://img4.mukewang.com/5e4a3ec90001ef8d04000400-40-40.jpg" alt="fasionchan">
				<h3>Python 源码深度剖析</h3>
				<p>fasionchan · 资深 Python 研发工程师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">天才就是百分之二的灵感，百分之九十八的汗水。<p class="author">——爱迪生</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><p>经过前面章节，我们知道 <em>float</em> 对象背后由 <em>PyFloatObject</em> 组织，对其结构也了然于胸。 那么，本节为何要重复讨论 <em>float</em> 对象呢？</p>
</div><div class="cl-preview-section"><p>一方面， 对象模型中关于 <em>float</em> 对象的讨论， 着眼于 <em>Python</em> 面向对象体系的讲解，许多细节没来得及展开。 另一方面， <em>float</em> 作为 <em>Python</em> 中最简单的对象之一，“麻雀虽小，五脏俱全”， 拥有对象的全部必要属性。 以 <em>float</em> 对象为起点开启源码之旅，能够快速上手，为研究更复杂的内置对象打好基础，建立信心。</p>
</div><div class="cl-preview-section"><h1 id="内部结构">内部结构</h1>
</div><div class="cl-preview-section"><p><em>float</em> 实例对象在 <em>Include/floatobject.h</em> 中定义，结构很简单：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    PyObject_HEAD
    <span class="token keyword">double</span> ob_fval<span class="token punctuation">;</span>
<span class="token punctuation">}</span> PyFloatObject<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>除了定长对象共用的头部，只有一个额外的字段 <em>ob_fval</em> ，存储对象所承载的浮点值。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ebd2b640001dc2503900280.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>​ 				<em>浮点实例对象内部结构</em></p>
</div><div class="cl-preview-section"><p><em>float</em> 类型对象又长啥样呢？</p>
</div><div class="cl-preview-section"><p>与实例对象不同， <em>float</em> 类型对象 <strong>全局唯一</strong> ，因此可以作为 <strong>全局变量</strong> 定义。 在 <em>C</em> 文件 <em>Objects/floatobject.c</em> 中，我们找到了代表 <em>float</em> 类型对象的全局变量 <em>PyFloat_Type</em> ：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyTypeObject PyFloat_Type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyType_Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">"float"</span><span class="token punctuation">,</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyFloatObject<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>destructor<span class="token punctuation">)</span>float_dealloc<span class="token punctuation">,</span>                  <span class="token comment">/* tp_dealloc */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_print */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_getattr */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_setattr */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_reserved */</span>
    <span class="token punctuation">(</span>reprfunc<span class="token punctuation">)</span>float_repr<span class="token punctuation">,</span>                       <span class="token comment">/* tp_repr */</span>
    <span class="token operator">&amp;</span>float_as_number<span class="token punctuation">,</span>                           <span class="token comment">/* tp_as_number */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_sequence */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_mapping */</span>
    <span class="token punctuation">(</span>hashfunc<span class="token punctuation">)</span>float_hash<span class="token punctuation">,</span>                       <span class="token comment">/* tp_hash */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_call */</span>
    <span class="token punctuation">(</span>reprfunc<span class="token punctuation">)</span>float_repr<span class="token punctuation">,</span>                       <span class="token comment">/* tp_str */</span>
    PyObject_GenericGetAttr<span class="token punctuation">,</span>                    <span class="token comment">/* tp_getattro */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_setattro */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_buffer */</span>
    Py_TPFLAGS_DEFAULT <span class="token operator">|</span> Py_TPFLAGS_BASETYPE<span class="token punctuation">,</span>   <span class="token comment">/* tp_flags */</span>
    float_new__doc__<span class="token punctuation">,</span>                           <span class="token comment">/* tp_doc */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_traverse */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_clear */</span>
    float_richcompare<span class="token punctuation">,</span>                          <span class="token comment">/* tp_richcompare */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_weaklistoffset */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_iter */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_iternext */</span>
    float_methods<span class="token punctuation">,</span>                              <span class="token comment">/* tp_methods */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_members */</span>
    float_getset<span class="token punctuation">,</span>                               <span class="token comment">/* tp_getset */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_base */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_dict */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_descr_get */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_descr_set */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_dictoffset */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_init */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_alloc */</span>
    float_new<span class="token punctuation">,</span>                                  <span class="token comment">/* tp_new */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>PyFloat_Type</em> 中保存了很多关于浮点对象的 <strong>元信息</strong> ，关键字段包括：</p>
</div><div class="cl-preview-section"><ul>
<li><em>tp_name</em> 字段保存类型名称，常量 <em>float</em> ；</li>
<li><em>tp_dealloc</em> 、 <em>tp_init</em> 、 <em>tp_alloc</em> 和 <em>tp_new</em> 字段是对象创建销毁相关函数；</li>
<li><em>tp_repr</em> 字段是生成语法字符串表示形式的函数；</li>
<li><em>tp_str</em> 字段是生成普通字符串表示形式的函数；</li>
<li><em>tp_as_number</em> 字段是数值操作集；</li>
<li><em>tp_hash</em> 字段是哈希值生成函数；</li>
</ul>
</div><div class="cl-preview-section"><p><em>PyFloat_Type</em> 很重要，作为浮点 <strong>类型对象</strong> ，它决定了浮点 <strong>实例对象</strong> 的 <strong>生死和行为</strong> 。 接下来，我们以不同小节分别展开讨论。</p>
</div><div class="cl-preview-section"><h1 id="对象的创建">对象的创建</h1>
</div><div class="cl-preview-section"><p>在 <a href="https://www.imooc.com/read/76/article/1901">从创建到销毁，对象的生命周期</a> 一节，我们初步了解到创建实例对象的一般过程。</p>
</div><div class="cl-preview-section"><p>调用类型对象 <em>float</em> 创建实例对象，<em>Python</em> 执行的是 <em>type</em> 类型对象中的 <em>tp_call</em> 函数。 <em>tp_call</em> 函数进而调用 <em>float</em> 类型对象的 <em>tp_new</em> 函数创建实例对象， 再调用 <em>tp_init</em> 函数对其进行初始化：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ebd2b930001560e10970920.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>​       <em>创建对象的过程</em></p>
</div><div class="cl-preview-section"><p>注意到， <em>float</em> 类型对象 <em>PyFloat_Type</em> 中 <em>tp_init</em> 函数指针为空。 这是因为 <em>float</em> 是一种很简单的对象，初始化操作只需要一个赋值语句，在 <em>tp_new</em> 中完成即可。</p>
</div><div class="cl-preview-section"><p>除了通用的流程， <em>Python</em> 为内置对象实现了对象创建 <em>API</em> ，简化调用，提高效率：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyObject <span class="token operator">*</span>
<span class="token function">PyFloat_FromDouble</span><span class="token punctuation">(</span><span class="token keyword">double</span> fval<span class="token punctuation">)</span><span class="token punctuation">;</span>

PyObject <span class="token operator">*</span>
<span class="token function">PyFloat_FromString</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li><em>PyFloat_FromDouble</em> 函数通过浮点值创建浮点对象；</li>
<li><em>PyFloat_FromString</em> 函数通过字符串对象创建浮点对象；</li>
</ul>
</div><div class="cl-preview-section"><p>以 <em>PyFloat_FromDouble</em> 为例，特化的对象创建流程如下：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyObject <span class="token operator">*</span>
<span class="token function">PyFloat_FromDouble</span><span class="token punctuation">(</span><span class="token keyword">double</span> fval<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyFloatObject <span class="token operator">*</span>op <span class="token operator">=</span> free_list<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        free_list <span class="token operator">=</span> <span class="token punctuation">(</span>PyFloatObject <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
        numfree<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        op <span class="token operator">=</span> <span class="token punctuation">(</span>PyFloatObject<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PyObject_MALLOC</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyFloatObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>op<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PyErr_NoMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Inline PyObject_New */</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">PyObject_INIT</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PyFloat_Type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    op<span class="token operator">-&gt;</span>ob_fval <span class="token operator">=</span> fval<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span> op<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><ol>
<li>为对象 <strong>分配内存空间</strong> ，优先使用空闲对象缓存池 (第 <em>4-12</em> 行)；</li>
<li>初始化 <strong>对象类型</strong> 字段 <em>ob_type</em> 以及 <strong>引用计数</strong> 字段 <em>ob_refcnt</em> (第 <em>14</em> 行)；</li>
<li>将 <em>ob_fval</em> 字段初始化为指定 <strong>浮点值</strong> (第 <em>15</em> 行)；</li>
</ol>
</div><div class="cl-preview-section"><p>其中，宏 <em>PyObject_INIT</em> 在头文件 <em>Include/objimpl.h</em> 中定义：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> PyObject_INIT(op, typeobj) \
    ( Py_TYPE(op) = (typeobj), _Py_NewReference((PyObject *)(op)), (op) )</span>
</code></pre>
</div><div class="cl-preview-section"><p>宏 <em>_Py_NewReference</em> 将对象引用计数初始化为 <em>1</em> ，在 <em>Include/Object.h</em> 中定义：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _Py_NewReference(op) (                          \
    _Py_INC_TPALLOCS(op) _Py_COUNT_ALLOCS_COMMA         \
    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA               \
    Py_REFCNT(op) = 1)</span>
</code></pre>
</div><div class="cl-preview-section"><h1 id="对象的销毁">对象的销毁</h1>
</div><div class="cl-preview-section"><p>当对象不再需要时， <em>Python</em> 通过 <em>Py_DECREF</em> 或者 <em>Py_XDECREF</em> 宏减少引用计数； 当引用计数降为 <em>0</em> 时， <em>Python</em> 通过 <em>_Py_Dealloc</em> 宏回收对象。</p>
</div><div class="cl-preview-section"><p><em>_Py_Dealloc</em> 宏调用类型对象 <em>PyFloat_Type</em> 中的 <em>tp_dealloc</em> 函数指针：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _Py_Dealloc(op) (                               \
    _Py_INC_TPFREES(op) _Py_COUNT_ALLOCS_COMMA          \
    (*Py_TYPE(op)-&gt;tp_dealloc)((PyObject *)(op)))</span>
</code></pre>
</div><div class="cl-preview-section"><p>因此，实际调用的函数是 <em>float_dealloc</em> (代码在下一小节 <strong>空闲对象缓存池</strong> 中解析)：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">float_dealloc</span><span class="token punctuation">(</span>PyFloatObject <span class="token operator">*</span>op<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyFloat_CheckExact</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numfree <span class="token operator">&gt;=</span> PyFloat_MAXFREELIST<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
            <span class="token function">PyObject_FREE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        numfree<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> _typeobject <span class="token operator">*</span><span class="token punctuation">)</span>free_list<span class="token punctuation">;</span>
        free_list <span class="token operator">=</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">tp_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>总结起来，对象从创建到销毁整个生命周期所涉及的 <strong>关键函数、宏及调用关系</strong> 如下：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ebd2ba00001973007701122.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h1 id="空闲对象缓存池">空闲对象缓存池</h1>
</div><div class="cl-preview-section"><p>浮点运算背后涉及 <strong>大量临时对象创建以及销毁</strong> ，以计算圆周率为例：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> area <span class="token operator">=</span> pi <span class="token operator">*</span> r <span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>这个语句首先计算半径 <em>r</em> 的平方，中间结果由一个临时对象来保存，假设是 <em>t</em> ； 然后计算圆周率 <em>pi</em> 与 <em>t</em> 的乘积，得到最终结果并赋值给变量 <em>area</em> ； 最后，销毁临时对象 <em>t</em> 。 这么简单的语句，背后居然都隐藏着一个临时对象的创建以及销毁操作！</p>
</div><div class="cl-preview-section"><p>创建对象时需要分配内存，销毁对象时又需要回收内存。 <strong>大量临时对象创建销毁</strong> ，意味着 <strong>大量内存分配回收操作</strong> ，这显然是是不可接受的。</p>
</div><div class="cl-preview-section"><p>因此 <em>Python</em> 在浮点对象销毁后，并不急于回收内存，而是将对象放入一个 <strong>空闲链表</strong> 。 后续需要创建浮点对象时，先到空闲链表中取，省去分配内存的开销。</p>
</div><div class="cl-preview-section"><p>浮点对象的空闲链表同样在 <em>Objects/floatobject.c</em> 中定义：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> PyFloat_MAXFREELIST</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PyFloat_MAXFREELIST    100</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token keyword">static</span> <span class="token keyword">int</span> numfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> PyFloatObject <span class="token operator">*</span>free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li><em>free_list</em> 变量，指向空闲链表 <strong>头节点</strong> 的指针；</li>
<li><em>numfree</em> 变量，维护空闲链表 <strong>当前长度</strong> ；</li>
<li><em>PyFloat_MAXFREELIST</em> 宏，限制空闲链表的 <strong>最大长度</strong> ，避免占用过多内存；</li>
</ul>
</div><div class="cl-preview-section"><p>为了保持简洁， <em>Python</em> 把 <em>ob_type</em> 字段当作 <em>next</em> 指针来用，将空闲对象串成链表：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ebd2ba8000156b908400240.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>​       <em>空闲对象链表</em></p>
</div><div class="cl-preview-section"><p>由此一来，需要创建浮点对象时，可以从链表中取出空闲对象，省去申请内存的开销！ 以 <em>PyFloat_FromDouble</em> 为例：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyFloatObject <span class="token operator">*</span>op <span class="token operator">=</span> free_list<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    free_list <span class="token operator">=</span> <span class="token punctuation">(</span>PyFloatObject <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    numfree<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    op <span class="token operator">=</span> <span class="token punctuation">(</span>PyFloatObject<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PyObject_MALLOC</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyFloatObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><ol>
<li>检查 <em>free_list</em> 是否为空(第 <em>2</em> 行)；</li>
<li>如果 <em>free_list</em> 非空，取出头节点备用， 并将 <em>numfree</em> 减一(第 <em>3-4</em> 行)；</li>
<li>如果 <em>free_list</em> 为空，则调用 <em>PyObject_MALLOC</em> 分配内存(第 <em>6</em> 行)；</li>
</ol>
</div><div class="cl-preview-section"><p>如果对 C 语言链表操作不熟悉，可以结合以下图示加以理解：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ebd2bb10001af1608400260.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>对象销毁时， <em>Python</em> 将其缓存在空闲链表中，以备后用。考察 <em>float_dealloc</em> 函数：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>numfree <span class="token operator">&gt;=</span> PyFloat_MAXFREELIST<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token function">PyObject_FREE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
numfree<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token function">Py_TYPE</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> _typeobject <span class="token operator">*</span><span class="token punctuation">)</span>free_list<span class="token punctuation">;</span>
free_list <span class="token operator">=</span> op<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ol>
<li>第 <em>1-4</em> 行，空闲链表长度达到限制值，调用 <em>PyObject_FREE</em> 回收对象内存；</li>
<li>第 <em>5-7</em> 行，空闲链表长度暂未达到限制，将对象插到空闲链表头部；</li>
</ol>
</div><div class="cl-preview-section"><p>这就是 <em>Python</em> 空闲对象缓存池的全部秘密！ 由于空闲对象缓存池在 <strong>提高对象分配效率</strong> 方面发挥着至关重要的作用， 后续研究其他内置对象时，我们还会经常看到它的身影。</p>
</div><div class="cl-preview-section"><h1 id="对象的行为">对象的行为</h1>
</div><div class="cl-preview-section"><p><em>PyFloat_Type</em> 中定义了很多函数指针，包括 <em>tp_repr</em> 、 <em>tp_str</em> 、 <em>tp_hash</em> 等。 这些函数指针将一起决定 <em>float</em> 对象的行为，例如 <em>tp_hash</em> 函数决定浮点哈希值的计算：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token number">3.14</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">hash</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>
<span class="token number">322818021289917443</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>tp_hash</em> 函数指针指向 <em>float_hash</em> 函数，实现了针对浮点对象的哈希值算法：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> Py_hash_t
<span class="token function">float_hash</span><span class="token punctuation">(</span>PyFloatObject <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_Py_HashDouble</span><span class="token punctuation">(</span>v<span class="token operator">-&gt;</span>ob_fval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="数值操作集">数值操作集</h3>
</div><div class="cl-preview-section"><p>由于加减乘除等数值操作很常见， <em>Python</em> 将其抽象成数值操作集 <em>PyNumberMethods</em> 。 数值操作集 <em>PyNumberMethods</em> 在头文件 <em>Include/object.h</em> 中定义：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Number implementations must check *both*
    arguments for proper type and implement the necessary conversions
    in the slot functions themselves. */</span>

    binaryfunc nb_add<span class="token punctuation">;</span>
    binaryfunc nb_subtract<span class="token punctuation">;</span>
    binaryfunc nb_multiply<span class="token punctuation">;</span>
    binaryfunc nb_remainder<span class="token punctuation">;</span>
    binaryfunc nb_divmod<span class="token punctuation">;</span>
    ternaryfunc nb_power<span class="token punctuation">;</span>
    unaryfunc nb_negative<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    binaryfunc nb_inplace_add<span class="token punctuation">;</span>
    binaryfunc nb_inplace_subtract<span class="token punctuation">;</span>
    binaryfunc nb_inplace_multiply<span class="token punctuation">;</span>
    binaryfunc nb_inplace_remainder<span class="token punctuation">;</span>
    ternaryfunc nb_inplace_power<span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span> PyNumberMethods<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>PyNumberMethods</em> 定义了各种数学算子的处理函数，数值计算最终由这些函数执行。 处理函数根据参数个数可以分为： <strong>一元函数</strong> ( <em>unaryfunc</em> )、 <strong>二元函数</strong> ( <em>binaryfunc</em> )等。</p>
</div><div class="cl-preview-section"><p>回到 <em>Objects/floatobject.c</em> 观察浮点对象数值操作集 <em>float_as_number</em> 是如何初始化的：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> PyNumberMethods float_as_number <span class="token operator">=</span> <span class="token punctuation">{</span>
    float_add<span class="token punctuation">,</span>          <span class="token comment">/* nb_add */</span>
    float_sub<span class="token punctuation">,</span>          <span class="token comment">/* nb_subtract */</span>
    float_mul<span class="token punctuation">,</span>          <span class="token comment">/* nb_multiply */</span>
    float_rem<span class="token punctuation">,</span>          <span class="token comment">/* nb_remainder */</span>
    float_divmod<span class="token punctuation">,</span>       <span class="token comment">/* nb_divmod */</span>
    float_pow<span class="token punctuation">,</span>          <span class="token comment">/* nb_power */</span>
    <span class="token punctuation">(</span>unaryfunc<span class="token punctuation">)</span>float_neg<span class="token punctuation">,</span> <span class="token comment">/* nb_negative */</span>
    <span class="token comment">// ...</span>

    <span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">/* nb_inplace_add */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">/* nb_inplace_subtract */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">/* nb_inplace_multiply */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">/* nb_inplace_remainder */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                  <span class="token comment">/* nb_inplace_power */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>以加法为例，以下语句在 <em>Python</em> 内部最终由 <em>float_add</em> 函数执行：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">1.5</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> <span class="token number">1.1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">+</span> b
<span class="token number">2.6</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>float_add</em> 是一个 <strong>二元函数</strong> ，同样位于 <em>Objects/floatobject.h</em> 中：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> PyObject <span class="token operator">*</span>
<span class="token function">float_add</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>w<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>
    <span class="token function">CONVERT_TO_DOUBLE</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CONVERT_TO_DOUBLE</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyFPE_START_PROTECT</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">,</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">)</span>
    a <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token function">PyFPE_END_PROTECT</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">PyFloat_FromDouble</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>函数实现只有寥寥几步： 首先，将两个参数对象转化成浮点值( <em>5-6</em> 行)； 然后，对两个浮点值求和( <em>8</em> 行)； 最后，创建一个新浮点对象保存计算结果并返回( <em>10</em> 行)。</p>
</div><div class="cl-preview-section"><h1 id="面试题精讲">面试题精讲</h1>
</div><div class="cl-preview-section"><h2 id="例题一">例题一</h2>
</div><div class="cl-preview-section"><p>以下例子中， <em>area</em> 计算过程中有临时对象创建吗？为什么？</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token number">3.14</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> r <span class="token operator">=</span> <span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> area <span class="token operator">=</span> pi <span class="token operator">*</span> r <span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>Python 如何优化临时对象创建效率？</p>
</div><div class="cl-preview-section"><h3 id="解析">解析</h3>
</div><div class="cl-preview-section"><p>这个语句首先计算半径 <em>r</em> 的平方，中间结果由一个临时对象来保存，假设是 <em>t</em> ； 然后计算圆周率 <em>pi</em> 与 <em>t</em> 的乘积，得到最终结果并赋值给变量 <em>area</em> ； 最后，销毁临时对象 <em>t</em> 。</p>
</div><div class="cl-preview-section"><p>为了提高浮点对象创建效率， <em>Python</em> 引入了 <strong>空闲对象缓存池</strong> 。</p>
</div><div class="cl-preview-section"><p>浮点对象销毁后， <em>Python</em> 并不急于回收内存，而是将对象放入一个 <strong>空闲链表</strong> 。 后续需要创建浮点对象时，先到空闲链表中取，省去分配内存的开销。</p>
</div><div class="cl-preview-section"><h2 id="例题二">例题二</h2>
</div><div class="cl-preview-section"><p>以下例子中，变量 e 的 id 值为何与已销毁的变量 pi 相同？</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token number">3.14</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">id</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>
<span class="token number">4565221808</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> del pi
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> e <span class="token operator">=</span> <span class="token number">2.71</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">id</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token number">4565221808</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="section"></h3>
</div><div class="cl-preview-section"><h3 id="解析-1">解析</h3>
</div><div class="cl-preview-section"><p><em>Python</em> 为了优化浮点对象内存分配效率，引入了 <strong>空闲对象缓存池</strong> 。 浮点对象销毁后， <em>Python</em> 并不急于回收对象内存，而是将对象缓存在空闲链表中，以备后用。</p>
</div><div class="cl-preview-section"><p>例子中， <em>pi</em> 对象销毁后， <em>Python</em> 先不回收对象内存，而是将其插空闲对象链表头部。 当创建浮点对象 <em>e</em> 时， <em>Python</em> 从链表头取出空闲对象来用，省去了申请内存的开销。 换句话讲， <em>pi</em> 对象销毁后被 <em>e</em> 重新利用了，因此 <em>id</em> 值相同也就不奇怪了。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img4.mukewang.com/5ebd2a4400011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<ul class="comment-content">
				
				<li class="item">
					<a href="/read/commentdetail/6737">
						<img src="https://img.mukewang.com/598428590001910101000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">qq_泡沫_40</h4>
						<div class="comment-text">Py_TYPE() 请教一下老师 这个函数的作用是什么呀？</div>
						<div>
							
								<div class="reply">讲师回复：这是一个宏定义，位于 Include/object.h 头文件：#define Py_TYPE(ob)             (((PyObject*)(ob))-&amp;gt;ob_type)。

它的作用是：将给定对象的类型对象取出。由于对象的类型保存在ob_type字段，因此它只是将对象的ob_type字段返回而已。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-09-07</span>
						<a href="/read/commentdetail/6737">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="6737" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6706">
						<img src="https://img1.mukewang.com/571a341e0001d3fc06400640-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">jxs1211</h4>
						<div class="comment-text">面试题二，相同的代码，验证出来的结果好像id不同，为什么呢？</div>
						<div>
							
								<div class="reply">讲师回复：跟Python版本有关，同个版本的Python还可以通过编译选项，配置成不同的行为，理解主要思想即可。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-09-02</span>
						<a href="/read/commentdetail/6706">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6706" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6622">
						<img src="https://img2.mukewang.com/5f3dd00b0001ad3625601600-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">纪老猴子_2020</h4>
						<div class="comment-text">freelist就是一个链表，但是处理过程中貌似没有加锁，光靠freelist的实现无法保证线程安全，估计是GIL锁保证的freelist线程安全；Python的freelist长度是固定的，从这点我想起了OpenMPI源码中freelist的实现：长度固定，那么直接用数组，当做存储空间，然后在把另外一个数据构建成链表，这样效率应该比Python的freelist更高，就是更费内存。</div>
						<div>
							
								<div class="reply">讲师回复：①Python内部很多对象的线程安全性都靠GIL保证，list/dict等对象在底层都没有加锁，但GIL保证不会有两个线程同时调用list/dict的同一方法；②float对象的freelist实现内存使用效率其实很高，唯一的代价只是全局变量free_list而已，next指针都复用了PyObject结构体中的ob_type字段，没有任何额外开销；③空闲对象缓存可以加快对象创建速度，但空闲对象占用内存不能及时释放，有利有弊，但利大于弊。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-08-24</span>
						<a href="/read/commentdetail/6622">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6622" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6472">
						<img src="https://img3.mukewang.com/5b8cdcfa0001903902000200-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">一修学习</h4>
						<div class="comment-text">请教老师：
浮点对象有空闲对象缓存池，是因为浮点对象是定长对象；
大整数没有空闲对象缓存池，是因为大整数是变长对象。
这么理解对吗？</div>
						<div>
							
								<div class="reply">讲师回复：对。如果对象是变长的，就不适合做统一缓存。实际上，也可以选择只缓存底层数组长度为1的整数对象。在这个范围内的整数使用也比较频繁，缓存能带来一定的收益；但对象创建的代码逻辑却变复杂了，需要先判断目标对象底层数组长度，决定到底是使用缓存还是直接分配；对象销毁也是一样。很多技术方案没有绝对对错，更多是结合场景权衡利弊。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-08-06</span>
						<a href="/read/commentdetail/6472">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6472" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6414">
						<img src="https://img1.mukewang.com/5b8cef5700018f7102000199-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">weixin_慕雪5030482</h4>
						<div class="comment-text">这个空闲链表的存取方式，感觉更想一个栈的逻辑结构</div>
						<div>
							
								<div class="reply">讲师回复：没错，这种用法在C语言中很常见。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-08-04</span>
						<a href="/read/commentdetail/6414">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6414" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>1</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6336">
						<img src="https://img.mukewang.com/598acd270001003001000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">qq_毕竟太年轻_1</h4>
						<div class="comment-text">老师，“调用类型对象 float 创建实例对象，Python 执行的是 type 类型对象中的 tp_call 函数”中，为什么会执行type类型对象中的 tp_call 函数而不是float类型对象中的 tp_call 函数(float类型对象中的 tp_call 函数被初始化为0了，这个我知道)</div>
						<div>
							
								<div class="reply">讲师回复：理论上，实例对象x的行为，包括调用行为，是由其类型对象x.__class__决定的。因此，对于某个对象x，它是不是可调用(callable)，取决于其类型对象x.__class__是否定义了tp_call。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-28</span>
						<a href="/read/commentdetail/6336">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6336" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6268">
						<img src="https://img3.mukewang.com/533e4c3300019caf02000200-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">蒙古力_康康康</h4>
						<div class="comment-text">感觉老师后面能多加一些面试精讲或者总结更好了</div>
						<div>
							
								<div class="reply">讲师回复：嗯嗯，目前每个部分都有一个小节，专门讲一些高频典型的面试题。如果大家都有需求，我后续会考虑再加一些。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-23</span>
						<a href="/read/commentdetail/6268">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6268" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>3</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6172">
						<img src="https://img3.mukewang.com/58c9c7ef0001d83601000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">JUSTsleep</h4>
						<div class="comment-text">爱了爱了</div>
						<div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-17</span>
						<a href="/read/commentdetail/6172">
							<span class="icon r"><i class="imwap-comment"></i><em>0</em></span>
						</a>
						<span data-cid="6172" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>1</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5969">
						<img src="https://img4.mukewang.com/images/unknow-160.png" alt="" class="avatar">
						<h4 class="nickname">Kada8109531</h4>
						<div class="comment-text">真是好呀啊啊啊啊 awsl</div>
						<div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-06-29</span>
						<a href="/read/commentdetail/5969">
							<span class="icon r"><i class="imwap-comment"></i><em>0</em></span>
						</a>
						<span data-cid="5969" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>2</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5827">
						<img src="https://img3.mukewang.com/5f02eed50001d9e104000400-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">Python源码</h4>
						<div class="comment-text">老师写的太好了，深入浅出</div>
						<div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-06-13</span>
						<a href="/read/commentdetail/5827">
							<span class="icon r"><i class="imwap-comment"></i><em>0</em></span>
						</a>
						<span data-cid="5827" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>2</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5573">
						<img src="https://img.mukewang.com/539dbce6000186d207400740-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">amilu</h4>
						<div class="comment-text">代码块能显示行号就好了。</div>
						<div>
							
								<div class="reply">讲师回复：我也觉得文章和代码样式还有提升空间，已经给平台提了建议，程序哥哥们正在快马加鞭优化中。你的建议，是我们努力的方向?</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-22</span>
						<a href="/read/commentdetail/5573">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="5573" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
			</ul>
			
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥68.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=76">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '06 小试牛刀，解剖浮点对象 float',
					'CID': '1902',
					'Teacher': 'fasionchan'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "06 小试牛刀，解剖浮点对象 float",
                    desc: "突破技术瓶颈，迈向更高岗位",
                    imgUrl: 'https:https://img4.mukewang.com/5eb68ab400017cda05400720.jpg',
                    otherImgUrl: 'https://img4.mukewang.com/5eb68ab400017cda05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/76',
                    link: 'https://m.imooc.com/read/76'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
