<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>36 如何增加安全性</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="全面掌握迈向高级工程师的必备技能">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2195";
	var chapter_title = "36 如何增加安全性";
	var aid = "82";
	var a_name = "网络编程之Netty一站式精讲";
	var a_price = "68.00";
	var a_pic = "https://img4.mukewang.com/5f052aa90001f15b05400720.jpg";
	var userId = 0;

	var column_id = '82';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-08-27&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			36 如何增加安全性
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img3.mukewang.com/5f05971e0001d17b06400359.jpg')"></div>
	
	
		<a href="/read/82">
			<div class="course-entry">
				<img src="https://img3.mukewang.com/5d9c91f40001dcac05000500-40-40.jpg" alt="彤哥读源码">
				<h3>网络编程之Netty一站式精讲</h3>
				<p>彤哥读源码 · 互联网大厂项目经理</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">人的差异在于业余时间。<p class="author">——爱因斯坦</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h1 id="前言">前言</h1>
</div><div class="cl-preview-section"><p>你好，我是彤哥。</p>
</div><div class="cl-preview-section"><p>上一节，我们一起从扩展性的角度将实战项目的通信协议修改为了 WebSocket，有了 WebSocket，服务端可能很轻松地适配各端各语言，但是，如果我们的应用是暴露在外网的，还缺乏安全性。</p>
</div><div class="cl-preview-section"><p>因此，本节，我将从安全性的角度来给实战项目添加上安全的外衣，增加连接和数据的安全性。</p>
</div><div class="cl-preview-section"><p>好了，让我们开始今天的学习吧。</p>
</div><div class="cl-preview-section"><h1 id="何为安全性？">何为安全性？</h1>
</div><div class="cl-preview-section"><p>安全，是一个非常广泛地词，从广义上来讲，对于我们的应用，分为内部安全和外部安全。</p>
</div><div class="cl-preview-section"><p>内部安全，即系统本身是不是安全，有没有 OOM 的风险，数据是否加密存储，等等。</p>
</div><div class="cl-preview-section"><p>外部安全，即外部系统访问该系统是不是安全，连接是否可靠，是否是非法连接，传输数据是否安全，等等。</p>
</div><div class="cl-preview-section"><p>本节，我们讨论的主题主要是外部安全，对于外部安全，我把它分成三个部分：连接可靠性、连接合法性、数据安全性，我们一起来学习 Netty 是怎么解决这些问题的。</p>
</div><div class="cl-preview-section"><h1 id="连接可靠性">连接可靠性</h1>
</div><div class="cl-preview-section"><p>身为互联网人，你肯定听过一个词 ——keepalive，在不同的场合，它可能还会被称为心跳监测、空闲检测等，它的主要目的是为了告诉服务端，我还活着，不要关闭我的连接。</p>
</div><div class="cl-preview-section"><p>常用的处理方法是客户端定时的给服务端发送一个心跳包，服务端隔一定时间没收到这个客户端的心跳包，则认为它死了，可以把它关闭了。</p>
</div><div class="cl-preview-section"><p>但是，这样有个缺陷，如果客户端本身一直在和服务端交互，这种定时发送的方式就有点浪费带宽和流量，所以，比较好的方法是，客户端检测一定时间没跟服务端交互了才发送一个心跳包，服务端隔一定时间没收到客户端的请求了才认为它可以关闭了。</p>
</div><div class="cl-preview-section"><p>那么，在 Netty 中，我们该如何实现呢？</p>
</div><div class="cl-preview-section"><p>其实，Netty 天然就支持空闲检测，不过还缺少心跳的部分，正好上一节介绍的 WebSocket 是支持心跳协议的，两者结合起来就达到了 “空闲检测 + 心跳” 的目的。</p>
</div><div class="cl-preview-section"><blockquote>
<p>在 WebSocket 中，是通过 Ping/Pong 这一对消息来表示心跳���，它们分别是 PingWebSocketFrame 和 PongWebSocketFrame。</p>
</blockquote>
</div><div class="cl-preview-section"><p>好了，让我们先看服务端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerIdleCheckHandler</span> <span class="token keyword">extends</span> <span class="token class-name">IdleStateHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重写构造方法</span>
    <span class="token keyword">public</span> <span class="token function">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 10秒钟没收到读事件就认为是空闲了</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelIdle</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> IdleStateEvent evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token operator">==</span> IdleStateEvent<span class="token punctuation">.</span>FIRST_READER_IDLE_STATE_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"idle check close the client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检测到读空闲则关闭连接</span>
            ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>是不是非常简单？！只需要继承 IdleStateHandler 即可，重写构造方法指定空闲时间，并在 channelIdle () 方法中处理空闲事件。</p>
</div><div class="cl-preview-section"><p>然后，别忘了将其添加到 Pipeline 中，可以把它放在前面：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加Http协议编解码器、处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 添加WebSocket处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerCompressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerProtocolHandler</span><span class="token punctuation">(</span>WEBSOCKET_PATH<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// websocket编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 二次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>好了，再来客户端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientIdleCheckHandler</span> <span class="token keyword">extends</span> <span class="token class-name">IdleStateHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>客户端除了要实现空闲检测外，还需要发送 Ping 请求，而 Ping 请求是 WebSocket 的东西，它需要经过 WebSocket 的进一步编解码，所以还需要写一个处理空闲的 Handler，要放在 WebSocket 处理器的后面：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingPongHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token operator">&lt;</span>PongWebSocketFrame<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> PongWebSocketFrame msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 返回pong响应</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"client received pong response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Object evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 检测到是写空闲事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token operator">==</span> IdleStateEvent<span class="token punctuation">.</span>FIRST_WRITER_IDLE_STATE_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"idle check, send ping request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 发送ping请求</span>
            ByteBuf buffer <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PingWebSocketFrame frame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PingWebSocketFrame</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>在这个处理器中，检测到空闲了就发一个 Ping 请求给服务端，并处理 Pong 响应。</p>
</div><div class="cl-preview-section"><p>然后，把这两个 Handler 分别添加到 Pipeline 中：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpClientCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>WebSocketClientCompressionHandler<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 心跳 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PingPongHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// websocket编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 二次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>细心的同学可能会发现，怎么没看到服务端处理 Ping 请求呢？</p>
</div><div class="cl-preview-section"><p>其实，Ping 请求的处理是在 WebSocketServerProtocolHandler 中，它接收到是 Ping 请求，直接返回了一个 Pong 响应：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> WebSocketFrame frame<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token keyword">instanceof</span> <span class="token class-name">PingWebSocketFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PongWebSocketFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readIfNeeded</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token keyword">instanceof</span> <span class="token class-name">PongWebSocketFrame</span> <span class="token operator">&amp;&amp;</span> dropPongFrames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">readIfNeeded</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p>细心的同学会看到，它这里也使用了 retain () 方法，跟我们上一节用的 <code>ReferenceCountUtil.retain(msg);</code> 是一样的。</p>
</blockquote>
</div><div class="cl-preview-section"><p>到这里，空闲检测 + 心跳 就完成了，分别启动服务端和客户端，查看日志：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token number">19</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">09</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> PingPongHandler<span class="token operator">:</span> idle check<span class="token punctuation">,</span> send ping request
<span class="token number">19</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">09</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> PingPongHandler<span class="token operator">:</span> client received pong response
</code></pre>
</div><div class="cl-preview-section"><p>一切正常，不过，试着在牌局中停顿一会，会发现，连接被无情地断开了，这是因为客户端有一个等待用户输入的操作，这个操作是阻塞的，导致客户端的心跳没有发送出去，要解决这个问题其实也很简单，在客户端添加一个业务线程池，专门处理业务逻辑：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 添加业务线程池</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MahjongClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>再次运行程序，一切都正常了，我就不演示了。</p>
</div><div class="cl-preview-section"><p>好了，到这里，空闲检测 + 心跳就介绍完毕了，你 Get 到了吗？</p>
</div><div class="cl-preview-section"><h1 id="连接合法性">连接合法性</h1>
</div><div class="cl-preview-section"><p>其实，上面介绍的空闲检测 + 心跳的方式，在一定程度上，也包含了连接合法性的要求，你可能已经发现了，PingWebSocketFrame 是可以设置一个参数的，这个参数相当于是密钥，我们可以利用这个参数提高一定的安全性，如果是非法的客户端，它可能都不一定知道要心跳，即使知道要心跳，也不一定知道密钥是多少。</p>
</div><div class="cl-preview-section"><p>那么，我们这里说的连接合法性是什么呢？</p>
</div><div class="cl-preview-section"><p>一般是指黑白名单。</p>
</div><div class="cl-preview-section"><p>所谓黑名单，是被服务端禁止访问的用户，反之，白名单表示只有在白名单中的用户才可以访问服务端。</p>
</div><div class="cl-preview-section"><p>最简单的黑白名单实现方式，就是通过 IP 地址进行判断。</p>
</div><div class="cl-preview-section"><p>Netty 支持黑白名单吗？</p>
</div><div class="cl-preview-section"><p>天然支持。</p>
</div><div class="cl-preview-section"><p>在 Netty 中，定义了两种 IP 策略，一种是 UniqueIpFilter，一种是 RuleBasedIpFilter，前者表示一个 IP 地址只能建立一条连接，后者表示基于 IP 的过滤器，你可以设置一些规则，常用的规则是根据子网判断。</p>
</div><div class="cl-preview-section"><p>我以 RuleBasedIpFilter 为例添加一个黑名单过滤器：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 黑名单过滤器 ******</span>
IpFilterRule ipFilterRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IpSubnetFilterRule</span><span class="token punctuation">(</span><span class="token string">"192.168.175.1"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> IpFilterRuleType<span class="token punctuation">.</span>REJECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RuleBasedIpFilter</span><span class="token punctuation">(</span>ipFilterRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...省略其他</span>
</code></pre>
</div><div class="cl-preview-section"><p>这里的 IpSubnetFilterRule 使用的是 CIDR 表示法，即经常看到的 <code>130.39.37.100/24</code> 表示法，有兴趣的同学可以去了解下，当然，你也可以实现 IpFilterRule 接口定义自己的规则。</p>
</div><div class="cl-preview-section"><p>此时，重启服务端，启动客户端会被无情的断开连接：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">-</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> CLOSE
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> USER_EVENT<span class="token operator">:</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>ChannelInputShutdownReadComplete<span class="token annotation punctuation">@41034074</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> INACTIVE
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> UNREGISTERED
</code></pre>
</div><div class="cl-preview-section"><p>好了，黑白名单我们就介绍到这里，是不是超级简单，想不想了解源码怎么实现的？自己看去～～</p>
</div><div class="cl-preview-section"><h1 id="数据安全性">数据安全性</h1>
</div><div class="cl-preview-section"><p>到目前为止，前后端传输的数据还是明文的，怎么做到加密传输呢？</p>
</div><div class="cl-preview-section"><blockquote>
<p>虽然已经使用 Protobuf 序列化成字节数组了，但是仍然视为明文，别人只要拿到这个数据和结构体很容易就分析出来的。</p>
</blockquote>
</div><div class="cl-preview-section"><p>这就不得不提鼎鼎大名的 SSL/TLS 了，有兴趣的同学可以去了解下它加密传输的过程，非常有意思。</p>
</div><div class="cl-preview-section"><p>那么，Netty 支持 SSL 吗？</p>
</div><div class="cl-preview-section"><p>天然支持，一个 Handler 的事，没有什么是 Handler 不能解决的问题。</p>
</div><div class="cl-preview-section"><p>好，我们来看 Netty 如何支持 SSL，先看服务端：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MahjongServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String WEBSOCKET_PATH <span class="token operator">=</span> <span class="token string">"/websocket"</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PORT <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"8443"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// ssl，使用自己生成的证书</span>
        SelfSignedCertificate ssc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelfSignedCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SslContext sslCtx <span class="token operator">=</span> SslContextBuilder<span class="token punctuation">.</span><span class="token function">forServer</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssc<span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查看证书生成的位置</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...省略其他代码</span>
        
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                <span class="token comment">// ...省略其他代码</span>

                <span class="token comment">// 空闲检测</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ssl，创建一个handler</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>使用自己生成的证书，并通过 SslContext 生成一个 Handler 添加到 Pipeline 中即可，就是这么简单。</p>
</div><div class="cl-preview-section"><p>我们再来看看客户端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MahjongClient</span> <span class="token punctuation">{</span>

    <span class="token comment">// 记得修改协议为wss</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> String URL <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"wss://127.0.0.1:8443/websocket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 创建sslContext</span>
        SslContext sslCtx <span class="token operator">=</span> SslContextBuilder<span class="token punctuation">.</span><span class="token function">forClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 工作线程池</span>
        NioEventLoopGroup workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Bootstrap bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>workerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span>NioSocketChannel<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                    <span class="token comment">// ...省略其他代码</span>
                    
                    <span class="token comment">// 空闲检测</span>
                    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// ssl，创建handler</span>
                    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>客户端的实现基本上类似，是不是很简单？让我们运行起来看看，报错了，提示找不到证书，这是怎么回事呢？</p>
</div><div class="cl-preview-section"><p>那是因为我们的证书是自己生成的，不是从权威机构花钱买的，所以，不受信任，此时，需要把导入证书，客户端才能正常访问服务器，导入命令如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 导入证书</span>
keytool<span class="token punctuation">.</span>exe <span class="token operator">-</span><span class="token keyword">import</span> <span class="token operator">-</span>alias netty<span class="token operator">-</span>core <span class="token operator">-</span>keystore <span class="token string">"D:\Program Files\Java\jdk1.8.0_202\jre\lib\security\cacerts"</span> <span class="token operator">-</span>file <span class="token string">"C:\Users\alan\AppData\Local\Temp\keyutil_example.com_8575751454001666416.crt"</span> <span class="token operator">-</span>storepass changeit

<span class="token comment">// 移除证书</span>
keytool<span class="token punctuation">.</span>exe <span class="token operator">-</span>delete <span class="token operator">-</span>alias netty<span class="token operator">-</span>core <span class="token operator">-</span>keystore <span class="token string">"D:\Program Files\Java\jdk1.8.0_202\jre\lib\security\cacerts"</span> <span class="token operator">-</span>storepass changeit
</code></pre>
</div><div class="cl-preview-section"><p>注意，保存的位置是你的 IDEA 使用的 JRE 的位置下面的 <code>lib\security\cacerts</code>，我的 IDEA 一般配置的是 JDK 的目录，那就用 JDK 目录下面的 JRE 下面对应的路径，别弄错了。证书的位置在服务端启动的时候会打印出来路径。</p>
</div><div class="cl-preview-section"><p>OK，再次重启客户端，一切正常了，我就不演示了。</p>
</div><div class="cl-preview-section"><p>到此，我们也通过 SSL 的方式实现了数据安全了。</p>
</div><div class="cl-preview-section"><h1 id="后记">后记</h1>
</div><div class="cl-preview-section"><p>本节，我们从空闲检测（心跳）、黑白名单、SSL 三个方面分别对我们的实战项目做了安全增强，在 Netty 中，使用这些技术都变得非常简单，没有什么是一个 Handler 不能搞定的事，如果真的有，那就用两个，可见，Netty 的扩展性真的是无话可说。</p>
</div><div class="cl-preview-section"><p>到这里，Netty 还可以再调优吗？</p>
</div><div class="cl-preview-section"><p>下一节，我们将从参数的角度来对实战项目进行调优，敬请期待。</p>
</div><div class="cl-preview-section"><h1 id="思维导图">思维导图</h1>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5f3f31cd0001419614410953.png" alt="图片描述"></p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img1.mukewang.com/5f05422200011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥68.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=82">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '36 如何增加安全性',
					'CID': '2195',
					'Teacher': '彤哥读源码'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "36 如何增加安全性",
                    desc: "全面掌握迈向高级工程师的必备技能",
                    imgUrl: 'https:https://img4.mukewang.com/5f052aa90001f15b05400720.jpg',
                    otherImgUrl: 'https://img4.mukewang.com/5f052aa90001f15b05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/82',
                    link: 'https://m.imooc.com/read/82'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
