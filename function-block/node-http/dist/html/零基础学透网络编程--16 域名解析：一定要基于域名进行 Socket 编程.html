<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>16 域名解析：一定要基于域名进行 Socket 编程</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="学好通用知识，提升技术竞争力">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2105";
	var chapter_title = "16 域名解析：一定要基于域名进行 Socket 编程";
	var aid = "80";
	var a_name = "零基础学透网络编程";
	var a_price = "58.00";
	var a_pic = "https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg";
	var userId = 0;

	var column_id = '80';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-06-09&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			16 域名解析：一定要基于域名进行 Socket 编程
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img3.mukewang.com/5ed9fd3f0001a3ac06400359.jpg')"></div>
	
	
		<a href="/read/80">
			<div class="course-entry">
				<img src="https://img.mukewang.com/5458620000018a2602200220-40-40.jpg" alt="陈子兴">
				<h3>零基础学透网络编程</h3>
				<p>陈子兴 · 资深软件架构师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">没有智慧的头脑，就像没有蜡烛的灯笼。<p class="author">——托尔斯泰</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h2 id="前言">前言</h2>
</div><div class="cl-preview-section"><p>在前面专栏的学习过程中，我们知道了 TCP/IP 协议栈是用 IP 地址来唯一标识网络中的一台主机的，IP 地址有 IPv4 和 IPv6 之分。IPv4 的地址格式是<strong>点分十进制</strong>形式，比如 10.0.1.12，而 IPv6 的地址格式是<strong>八元组</strong>形式，比如 2001:0DB8::1428:57ab。计算机喜欢处理数字化的 IP 地址，而我们人类并不喜欢数字，因为数字不直观、不便于记忆、不利于使用。试想一下，如果让你去记忆各大网站的 IP 地址，我相信你能记住的 IP 地址不会超过 10 个。</p>
</div><div class="cl-preview-section"><p>那么该怎么化解这个尴尬呢？科学家们又发明了另一套字符型的地址方案，即用<strong>主机名</strong>（Host Name）来唯一标识一台主机，主机名是用我们人类自己的语言来命名，当然目前主要是英语了。英语是不是很重要啊？<sup>_</sup></p>
</div><div class="cl-preview-section"><p>在这里需要注意的是 Host Name 也可以唯一标识一台主机，���另外一套地址方案。只不过 Host Name 是方便人类使用的，而计算机还是用 IP 地址。</p>
</div><div class="cl-preview-section"><p>在互联网中，有不计其数的主机，要保证这些主机的唯一性，必须用一套统一的 Host Name 编码方案。目前应用最广泛的就是<strong>域名系统</strong>（DNS，Domain Name System），DNS 是一个分布式系统，DNS 所包含的两项最主要的工作就是：<strong>域名分配</strong>和<strong>域名解析</strong>。<strong>域名分配</strong>就是为互联网中的主机分配一个唯一的<strong>域名</strong>，<strong>域名解析</strong>就是将<strong>域名</strong>转换为<strong>IP 地址</strong>的过程。本文主要是围绕 DNS 展开，包含三部分：</p>
</div><div class="cl-preview-section"><ul>
<li>域名空间</li>
<li>域名解析</li>
<li>域名解析实践</li>
</ul>
</div><div class="cl-preview-section"><p>让我们首先了解一下什么是域名，以及域名系统的工作方式。</p>
</div><div class="cl-preview-section"><h2 id="域名空间">域名空间</h2>
</div><div class="cl-preview-section"><p>也许你没注意，其实你早已经接触过域名了，我们曾经在第一篇专栏中提到过域名，还记得下图吗？</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed9a7fc0001ec1805680667.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>让我们再回忆一下，这张图展示了 Alice 打开自己的浏览器，在地址栏输入 <a href="http://www.imooc.com/topic/webframe"><i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-5">http</i>://www.imooc.com/topic/webframe</a>? 以后，���议栈背后的行为。</p>
</div><div class="cl-preview-section"><p>图中 <i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-5">HTTP</i> GET 请求的 URL 中的 <a href="http://www.imooc.com">www.imooc.com</a> 就是慕课网的域名，图中我们只是展示了 TCP 连接建立的<strong>三次握手</strong>过程，其实浏览器还有一个<strong>域名解析</strong>过程，别忘了域名是给人类用的，计算机最终要处理的依然是 IP 地址。</p>
</div><div class="cl-preview-section"><p>过去给小孩起名字是有很多讲究的，比如孩子是不能占用父辈的名讳的。那么我们给主机命名有讲究吗？也是有的，至少要保证唯一性。我们先分析一下慕课网的域名结构，如下图所示。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed9a8090001e64411920543.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>从图中可以看出，域名是一颗树形结构，包含了许多层级：</p>
</div><div class="cl-preview-section"><ul>
<li><strong>根级域</strong>，是指一个无名的树根；</li>
<li><strong>顶级域</strong>，顶级域分为 generic TLDs（gTLDs），country-code TLDs（ccTLDs）、internationalized country-code TLDs（IDN，ccTLDs）、infrastructure TLD。我们在图中列举的 net、edu、org、gov、com 是指 gTLDs，即通用顶级域。比如 .com；</li>
<li><strong>二级域</strong>，是指顶级域的下一级。比如 .imooc；</li>
<li><strong>子域</strong>，是指二级域以下的所有层级。其实也可以叫做三级域、四级域等。比如 www。</li>
</ul>
</div><div class="cl-preview-section"><p>域名是由美国非营利性机构 ICANN 维护的，它管理着全世界的域名系统。比如，所有的顶级域（TLD）都是由 ICANN 来规定。当然全球的所有域名的注册、管理、维护也不是由 ICANN 机构亲自执行的，而是委托给了一些代理公司。如果你对域名管理的相关细节感兴趣，可以找一些资料了解一下。</p>
</div><div class="cl-preview-section"><p>如果你要建站并且给自己的主机绑定域名，是需要向域名管理机构申请的，目前有很多代理机构都可以申请。申请域名的流程也比较简单，你只需要想好名字，到相关机构申请即可。</p>
</div><div class="cl-preview-section"><p>下来我们分析一下域名解析的流程。</p>
</div><div class="cl-preview-section"><h2 id="域名解析">域名解析</h2>
</div><div class="cl-preview-section"><p>试想一下，当 Alice 在浏览器输入 <a href="http://www.imooc.com">www.imooc.com</a> 以后，又是如何将这样一串英文字符转为对应的 IP 地址呢？</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed9a8160001b76e10740538.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>仔细观察上图，你会发现浏览器需要 14 步才能获取 <a href="http://www.imooc.com">www.imooc.com</a> 对应的 IP 地址。下来，我们就针对域名解析的一些细节展开讨论。</p>
</div><div class="cl-preview-section"><p>首先我们需要理解域名解析中的 Cache 机制，<strong>本地 Resolver</strong>或者 <strong>DNS 服务器</strong>都有 Cache 机制。DNS 服务器在解析客户机请求时, 如果本地没有该 DNS 信息，则会询问其他 DNS 服务器，当其他 DNS 服务器返回查询结果时，此 DNS 服务器会将结果记录在本地 Cache 中，当下一次客户机提交相同请求时，DNS 服务器可以直接返回 Cache 中保存的 DNS 信息。这样做的目的是提升域名解析的效率。</p>
</div><div class="cl-preview-section"><p>下来，我们介绍一下域名解析过程中的各个参与部分。</p>
</div><div class="cl-preview-section"><ul>
<li>浏览器，这不用说，是用于访问 Internet 的一个应用程序；</li>
<li>本地 Resolver，这是由系统提供的一个本地域名解析机制，以 API 的形式提供给应用程序调用。比如，gethostbyname 、getaddrinfo；</li>
<li>本地 Cache，这是<strong>本地 Resolver</strong> 的 Cache 机制，保存本机所请求过的所有域名和 IP 地址；</li>
<li>本地 /etc/hosts，这是一个系统文件，方便用户手动配置<strong>域名</strong>和 IP 地址的对应关系。在不同系统下，文件所在的位置不同，但是功能都是相同的；</li>
<li>本地域名服务器，一般是系统本地配置的，比如 linux 系统的配置文件是 /etc/resolv.conf；</li>
<li>根域名服务器，全球有 13 个 <strong>根域名服务器</strong>。可以通过 dig 命令列出此 13 个根域名服务器：</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	g<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	m<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	b<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	j<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	a<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	c<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	k<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	d<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	h<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	i<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	f<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	e<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
<span class="token punctuation">.</span>			<span class="token number">111</span>	IN	NS	l<span class="token punctuation">.</span>root<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>

</code></pre>
</div><div class="cl-preview-section"><ul>
<li>.com 顶级域名服务器，可以通过 dig -t ns com. 列出 .com gTLD 域名服务器：</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	l<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	k<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	b<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	a<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	f<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	g<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	i<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	h<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	c<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	j<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	d<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	m<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
com<span class="token punctuation">.</span>			<span class="token number">600</span>	IN	NS	e<span class="token punctuation">.</span>gtld<span class="token operator">-</span>servers<span class="token punctuation">.</span>net<span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><p>.com 顶级域名服务器是由 Verisign 公司管理。</p>
</div><div class="cl-preview-section"><ul>
<li>.imooc.com 二级域名服务器，是由慕课网维护。</li>
</ul>
</div><div class="cl-preview-section"><p>现在我们分析一下图中（1） ~ （14）步中域名解析过程：</p>
</div><div class="cl-preview-section"><p>在（1）步，Alice 的浏览器调用本地 Resolver 库解析域名；</p>
</div><div class="cl-preview-section"><p>在（2）步，本地 Resolver 首先查看本地 Cache 是否已经有此域名的 A 记录；</p>
</div><div class="cl-preview-section"><p>在（3）步，如果本地 Cache 中已经有域名相关信息，那么直接返回给浏览器；否则，进入第（4）步；</p>
</div><div class="cl-preview-section"><p>在（4）步，本地 Resolver 查看本地 hosts 文件是否有域名的 A 记录。</p>
</div><div class="cl-preview-section"><p>Windows 系统的 hosts 文件路径及内容：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 文件路径</span>
C<span class="token punctuation">:</span>\Windows\System32\drivers\etc\hosts

<span class="token comment">// 文件内容</span>
<span class="token number">192.30</span><span class="token punctuation">.</span><span class="token number">253.113</span> github<span class="token punctuation">.</span>com
</code></pre>
</div><div class="cl-preview-section"><p>Linux 系统的 hosts 文件路径及内容：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 文件路径</span>
<span class="token operator">/</span>etc<span class="token operator">/</span>hosts

<span class="token comment">// 文件内容</span>
<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span>	localhost
<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span>	<span class="token number">10</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token number">10.9</span><span class="token punctuation">.</span><span class="token number">50.2</span>	<span class="token number">10</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">1.1</span>	ubuntu
</code></pre>
</div><div class="cl-preview-section"><p>在（5）步，如果本地 hosts 有域名信息，那么直接返回；否则，进入第（6）步；</p>
</div><div class="cl-preview-section"><p>在（6）步，查询本地域名服务器的 Cache，如果有直接第（13）步返回，否则进入第（7）步。本地域名服务器的地址一般会在系统中配置；</p>
</div><div class="cl-preview-section"><p>linux 系统的配置路径：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 文件路径</span>
<span class="token operator">/</span>etc<span class="token operator">/</span>resolv<span class="token punctuation">.</span>conf

<span class="token comment">// 文件内容</span>
nameserver <span class="token number">10.9</span><span class="token punctuation">.</span><span class="token number">255.1</span>
nameserver <span class="token number">10.9</span><span class="token punctuation">.</span><span class="token number">255.2</span>
nameserver <span class="token number">114.114</span><span class="token punctuation">.</span><span class="token number">114.114</span>
</code></pre>
</div><div class="cl-preview-section"><p>在 Windows 系统中，本地域名服务器地址可以在网络配置中心查看。</p>
</div><div class="cl-preview-section"><p>在（7）步，本地域名服务器向根域名服务器请求 A 记录；</p>
</div><div class="cl-preview-section"><p>在（8）步，根域名服务器并不会解析域名，而是返回 .com 顶级域名服务器���表；</p>
</div><div class="cl-preview-section"><p>在（9）步，本地域名服务器向 .com 顶级域名服务器请求 A 记录；</p>
</div><div class="cl-preview-section"><p>在（10）步，.com 顶级域名服务器并不会解析域名，而是返回 .imooc.com 域名服务器地址列表；</p>
</div><div class="cl-preview-section"><p>在（11）步，本地域名服务器向 .imooc.com 请求 A 记录；</p>
</div><div class="cl-preview-section"><p>在（12）步，.imooc.com 返回自己的 IP 地址。沿着（13）、（14）步依次返回给浏览器。</p>
</div><div class="cl-preview-section"><p>经过这个漫长的过程，浏览器最终拿到了 IP 地址。本地域名服务器和本地 Resolver 都会缓存此 IP 地址，下一次再次访问就能很快完成。</p>
</div><div class="cl-preview-section"><blockquote>
<p>提示：这里说的 A 记录是指域名解析后获得的 IPv4 地址。</p>
</blockquote>
</div><div class="cl-preview-section"><p>域名解析是通过 DNS 协议完成的，DNS 协议采用 UDP 做为传输层。关于 DNS 协议的细节可以参考 <a href="https://tools.ietf.org/html/rfc6195" title="dns nessage">RFC 6195</a>。<br>
下来我们就了解一下如何在 Socket 编程中使用域名。</p>
</div><div class="cl-preview-section"><h2 id="域名解析编程实践">域名解析编程实践</h2>
</div><div class="cl-preview-section"><p>前面小节已经介绍了 DNS 在 Internet 中的意义，主要是方便人类的使用。在 Socket 编程中，我们更应该基于域名来编程。随着业务规模的不断增长，你的产品所占用的 IP 地址会逐渐增加，再加上一些主客观因素会导致你的服务器进行搬迁，这样会导致 IP 地址发生变化。你的系统不得不做重新部署和修改。如果你采用 IP 地址进行编程，那么这些变化会导致你的程序的维护性变的很差，也可能要做出大量的修改，甚至业务会中断。如果你通过域名进行编程，那么会极大的降低系统的维护成本。</p>
</div><div class="cl-preview-section"><p>域名解析 API 有哪些呢？</p>
</div><div class="cl-preview-section"><h3 id="域名解析-api-介绍">域名解析 API 介绍</h3>
</div><div class="cl-preview-section"><p>在之前的 TCP 和 UDP 编程中，客户端是通过 IP 地址来构造服务器 Socket 地址的。如果你要通过域名进行编程，那么首先需要通过域名解析 API 获取此域名对应的 IP 地址。在早期是通过 gethostbyname() 函数来获取域名所对应的 IP 地址的，通过 gethostbyaddr() 函数获取 IP 地址所对应的域名，如下代码片段。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span>       </span><span class="token comment">/* for AF_INET */</span>

<span class="token comment">// 通过域名获取 IP 地址</span>
<span class="token keyword">struct</span> hostent <span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 IP 地址反向获取域名</span>
<span class="token keyword">struct</span> hostent <span class="token operator">*</span><span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span>socklen_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>然而，由于 gethostbyname() 和 gethostbyaddr() 函数有很多不尽如人意的地方，比如：</p>
</div><div class="cl-preview-section"><ul>
<li>gethostbyname 只能支持 IPv4 地址解析，不能支持 IPv6 地址解析；</li>
<li>gethostbyname 和 gethostbyaddr 所使用的 Socket 地址结构是 struct in_addr 结构，只能保存 IP 地址，并不能获取完整的 Socket 地址结构，比如 struct sockaddr_in 结构。这样一来，当你通过域名获取了 IP 地址以后，还需要再次构造 struct sockaddr_in 结构，用起来非常不方便；</li>
<li>这两函数不是多线程安全的，后来又开发出了线程安全的函数，容易给程序员造成混淆，也不是非常好的选择。</li>
</ul>
</div><div class="cl-preview-section"><p>为此，gethostbyname() 和 gethostbyaddr() 函数已经不推荐大家使用了。现在推荐大家使用的是 getaddrinfo() 和 getnameinfo() 函数。下来我们详细了解一下函数返回值以及各个参数的含义。需要包含的头文件：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p>getaddrinfo 函数的功能是通过用户输入的域名和服务名称（某个知名端口对应的服务）获取 IP 地址，返回的是 IPv4 或者是 IPv6 的 Socket 地址结构，比如是 struct sockaddr_in 或 struct sockaddr_in6。所以，这个结构可以直接用于 connect 函数或者是 bind 函数的地址参数。同时，此函数是多线程安全的。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span>
  <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li>
<p>函数返回值，如果调用成功，则返回 0；否则，返回错误码。错误码的具体取值可以参考<a href="http://man7.org/linux/man-pages/man3/getaddrinfo.3.html" title="getaddrinfo">官方手册</a>。可以通过 gai_strerror 函数获取错误描述信息；</p>
</li>
<li>
<p>node，是字符串类型参数，表示域名，是输入参数；</p>
</li>
<li>
<p>service，是字符串类型参数，表示服务名，是输入参数；</p>
</li>
<li>
<p>hints，是 struct addrinfo 结构类型参数，表示给 getaddrinfo 函数提供一些指导，是输入参数：</p>
<pre class="  language-c"><code class="prism  language-c"><span class="token keyword">struct</span> addrinfo <span class="token punctuation">{</span>
  <span class="token keyword">int</span>              ai_flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span>              ai_family<span class="token punctuation">;</span>
  <span class="token keyword">int</span>              ai_socktype<span class="token punctuation">;</span>
  <span class="token keyword">int</span>              ai_protocol<span class="token punctuation">;</span>
  socklen_t        ai_addrlen<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>
   <span class="token keyword">char</span>            <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>在 hints 参数中，往往需要设置 ai_flags，ai_family，ai_socktype，ai_protocol 几个字段。</p>
<ul>
<li>ai_flags 提供一些标志位字段，比如，AI_PASSIVE、AI_V4MAPPED 、AI_ADDRCONFIG 、 AI_NUMERICHOST 等；</li>
<li>ai_family 取值可以是 AF_INET、AF_INET6、AF_UNSPEC。AF_UNSPEC 表示不区分地址族类型；</li>
<li>ai_socktype 取值可以是 SOCK_STREM、SOCK_DGRAM，也可以是 0。如果是指定 0，表示 getaddrinfo 返回所有 Socket 类型的地址；</li>
<li>ai_protocol 指定协议类型，一般都填 0，表示支持任何协议；</li>
<li>ai_addrlen 表示 IP 地址的长度，比如 IPv4 是 4 字节，IPv6 是 16 字节；</li>
<li>ai_addr 是 getaddrinfo 返回的 Socket 地址结构。通 ai_family 来确定是 IPv4 还是 IPv6 地址结构；</li>
<li>ai_canonname 表示 CNAME；</li>
<li>ai_next 指向下一个 struct addrinfo 地址结构。因为 getaddrinfo 可能会返回多个 Socket 地址结构，比如主机有多个网卡的情况，或者是同时返回 IPv4 和 IPv6 的地址。</li>
</ul>
</li>
<li>
<p>res，是 struct addrinfo 结构类型参数，是一个输出参数，返回 getaddrinfo 的查询结果。</p>
</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：</p>
<ul>
<li>当你进行产品开发的时候，尽量通过 getaddrinfo 来创建 Server 端监听的 Socket 地址和 Client 连接时指定的服务端地址。</li>
<li>对于 Server 端来说，node 参数传入 NULL；service 参数传入监听的端口号；设置hints-&gt;ai_family 为 AF_UNSPEC，表示同时支持 IPV4 和 IPv6；设置 hints-&gt;ai_flag 为 AI_PASSIVE；设置 hints-&gt;ai_flag 为 SOCK_STREAM 或者是 SOCK_DGRAM，根据情况而定。这样 getaddrinfo 会返回一个指向通配符 IP 地址的 Socket 地址结构。</li>
<li>对于 Client 端来说，需要指定 node 参数为服务器域名；指定 service 参数为服务器监听的端口号；将 hints-&gt;ai_flag 设置为 0，其他和服务器的参数一致。</li>
<li>创建服务器监听地址的时候，也可以指定 node 参数为域名，而 service 参数传入 NULL，这样可以动态绑定一个端口，由 getaddrinfo 来指定，避免端口配置的问题。这在服务器集群开发的时候也是常用的方法。</li>
</ul>
</blockquote>
</div><div class="cl-preview-section"><blockquote>
<p>注意：<br>
尽管 node 和 service 参数可以传入 NULL，但是不能同时传入 NULL。</p>
</blockquote>
</div><div class="cl-preview-section"><p>调用 getaddrinfo 返回的地址结构，必须调用 freeaddrinfo 函数释放 res 内存。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>getnameinfo 完成的功能和 getaddrinfo 刚好相反，通过 IP 地址获取域名和服务端口信息，支持多线程重入，可以同时支持 IPv4 和 IPv6。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span>
  socklen_t addrlen<span class="token punctuation">,</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span>
  socklen_t hostlen<span class="token punctuation">,</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>serv<span class="token punctuation">,</span>
  socklen_t servlen<span class="token punctuation">,</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li>函数返回值，如果调用成功，则返回 0；否则，返回错误码。错误码的具体取值可以参考<a href="http://man7.org/linux/man-pages/man3/getnameinfo.3.html" title="getnameinfo">官方手册</a>。可以通过 gai_strerror 函数获取错误描述信息；</li>
<li>addr，是一个通用 Socket 地址类型，真实类型可以是 IPv4 的 struct sockaddr_in 结构，也可以是 IPv6 的 struct sockaddr_in6 结构；</li>
<li>addrlen，是 Socket 地址的长度；</li>
<li>host，是一个输出参数，用于返回域名，内存空间由调用者提供；</li>
<li>hostlen, 是 host 参数指向的内存空间的大小；</li>
<li>serv, 是一个输出参数，用于返回服务类型，内存空间由调用者提供；</li>
<li>servlen，是 serv 指向的内存空间的大小；</li>
<li>flags，用于设置 getnameinfo 的具体行为。标记有很多，可以参考<a href="http://man7.org/linux/man-pages/man3/getnameinfo.3.html" title="getnameinfo">帮助</a>。</li>
</ul>
</div><div class="cl-preview-section"><p>函数调用失败后，返回错误描述信息。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> errcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>我们没有分析 gethostbyname 的参数细节，但是提供了 gethostbyname 和 gethostbyaddr 的样例代码；当然也提供了 getaddrinfo 和 getnameinfo 的样例代码，完整代码保存在“imooc-sock-core-tech\03-15_通过域名进行编程”目录下。</p>
</div><div class="cl-preview-section"><p>样例代码比较简单，我们就不再一一分析了，你看一下完整代码即可。下来我们分析一下 getaddrinfo 的细节。</p>
</div><div class="cl-preview-section"><h3 id="getaddrinfo-实现原理">getaddrinfo 实现原理</h3>
</div><div class="cl-preview-section"><p>首先需要说明的是 getaddrinfo 是一个 Socket API，具体实现是在 glibc 中完成的。关于 getaddrinfo 的使用，我们提供了完整的样例代码，在 <a href="http://man7.org/linux/man-pages/man3/getaddrinfo.3.html" title="getaddrinfo">Linux 帮助文档</a>也提供了完整的样例代码。由于前面小节详细介绍了 getaddrinfo 的各个参数，并且代码比较简单，所以不再分析代码片段了。</p>
</div><div class="cl-preview-section"><p>下来我们以 Ubuntu 18.04 为例，分析一下 getaddrinfo 的工作原理。我们所采用的方法很简单，就是通过 strace 工具跟踪程序的系统调用过程。strace 是 Linux 下面一个跟踪系统调用的工具，功能非常强大，经常用来分析一些复杂的系统问题。关于 strace 的资料很多，你有兴趣可以���行学习一下。</p>
</div><div class="cl-preview-section"><p>我们编译本文的样例程序，生成的可执行文件名是 name，所以在命令行输入如下命令：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">ubuntu@<span class="token number">10</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>imooc<span class="token operator">-</span>sock<span class="token operator">-</span>core<span class="token operator">-</span>tech<span class="token operator">/</span><span class="token number">03</span><span class="token operator">-</span>15_通过域名进行编程$ strace <span class="token punctuation">.</span><span class="token operator">/</span>name
</code></pre>
</div><div class="cl-preview-section"><p>这个命令很简单吧？然而，输出信息会很多，这些信息包含了 name 程序执行过程中的所有系统调用。比如，程序的加载、共享库的加载，而我们仅需要关注 DNS 解析部分，所以我将输出结果进行梳理，展示如下。</p>
</div><div class="cl-preview-section"><ol>
<li>从本地 DNS 缓存 nscd 查询 hosts。</li>
</ol>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 创建的是一个流式 UNIX 域套接字，还有映像吧？</span>
<span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token operator">|</span>SOCK_CLOEXEC<span class="token operator">|</span>SOCK_NONBLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token comment">// UNIX 域的文件路径是 /var/run/nscd/socket</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_UNIX<span class="token punctuation">,</span> sun_path<span class="token operator">=</span><span class="token string">"/var/run/nscd/socket"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// hosts 文件查询</span>
<span class="token function">sendto</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"\2\0\0\0\r\0\0\0\6\0\0\0hosts\0"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">18</span>
<span class="token comment">// 事件等待</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> events<span class="token operator">=</span>POLLIN<span class="token operator">|</span>POLLERR<span class="token operator">|</span>POLLHUP<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> revents<span class="token operator">=</span>POLLIN<span class="token operator">|</span>POLLHUP<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 接收结果</span>
<span class="token function">recvmsg</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>msg_name<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> msg_namelen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> msg_iov<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>iov_base<span class="token operator">=</span><span class="token string">"hosts\0"</span><span class="token punctuation">,</span> iov_len<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>iov_base<span class="token operator">=</span><span class="token string">"\310O\3\0\0\0\0\0"</span><span class="token punctuation">,</span> iov_len<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg_iovlen<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> msg_control<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>cmsg_len<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> cmsg_level<span class="token operator">=</span>SOL_SOCKET<span class="token punctuation">,</span> cmsg_type<span class="token operator">=</span>SCM_RIGHTS<span class="token punctuation">,</span> cmsg_data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg_controllen<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> msg_flags<span class="token operator">=</span>MSG_CMSG_CLOEXEC<span class="token punctuation">}</span><span class="token punctuation">,</span> MSG_CMSG_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">14</span>
</code></pre>
</div><div class="cl-preview-section"><ol start="2">
<li>从本地 DNS 缓存 nscd 查询域名 <a href="http://www.imooc.com">www.imooc.com</a>。同样是通过 UNIX 域套接字访问 nscd。</li>
</ol>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token operator">|</span>SOCK_CLOEXEC<span class="token operator">|</span>SOCK_NONBLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>

<span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_UNIX<span class="token punctuation">,</span> sun_path<span class="token operator">=</span><span class="token string">"/var/run/nscd/socket"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>

<span class="token function">sendto</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"\2\0\0\0\16\0\0\0\16\0\0\0www.imooc.com\0"</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">26</span>

<span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> events<span class="token operator">=</span>POLLIN<span class="token operator">|</span>POLLERR<span class="token operator">|</span>POLLHUP<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> revents<span class="token operator">=</span>POLLIN<span class="token operator">|</span>POLLHUP<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"\2\0\0\0\1\0\0\0\7\0\0\0\34\0\0\0\16\0\0\0\0\0\0\0"</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">24</span>

<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"uye\206s\266)\243uye\220s\266)guye)uye(s\266)\264\2\2\2\2"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">49</span>
</code></pre>
</div><div class="cl-preview-section"><p>通过上面展示的 getaddrinfo 执行过程来看，当我们执行 name 程序进行域名解析时，getaddrinfo 首先是在 <a href="http://www.man7.org/linux/man-pages/man8/nscd.8.html" title="nscd">nscd</a> 中查询。由于 nscd 缓存了 <a href="http://www.imooc.com">www.imooc.com</a> 的 A 记录，所以直接返回结果，我们并没有看到向 DNS 服务器发起请求的过程。</p>
</div><div class="cl-preview-section"><p><a href="http://www.man7.org/linux/man-pages/man8/nscd.8.html" title="nscd">nscd</a> 是 Linux 系统启动的一个服务程序，提供本地 DNS 缓存机制。getaddrinfo 是通过 UNIX 域套接字和 nscd 实现进程间通信的。</p>
</div><div class="cl-preview-section"><p>如果要想看到 getaddrinfo 向 DNS 服务器发起请求的过程，我们可以停止 nscd 服务，具体命令如下：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">ubuntu@<span class="token number">10</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>imooc<span class="token operator">-</span>sock<span class="token operator">-</span>core<span class="token operator">-</span>tech<span class="token operator">/</span><span class="token number">03</span><span class="token operator">-</span>15_通过域名进行编程$ sudo <span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>nscd stop
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> ubuntu<span class="token punctuation">:</span>
<span class="token punctuation">[</span> ok <span class="token punctuation">]</span> Stopping <span class="token function">nscd</span> <span class="token punctuation">(</span>via systemctl<span class="token punctuation">)</span><span class="token punctuation">:</span> nscd<span class="token punctuation">.</span>service<span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><p>再次执行 name 程序，通过 strace 观察域名解析过程。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">ubuntu@<span class="token number">10</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>imooc<span class="token operator">-</span>sock<span class="token operator">-</span>core<span class="token operator">-</span>tech<span class="token operator">/</span><span class="token number">03</span><span class="token operator">-</span>15_通过域名进行编程$ strace <span class="token punctuation">.</span><span class="token operator">/</span>name
</code></pre>
</div><div class="cl-preview-section"><p><strong>1.</strong> 首先是向本地 DNS 缓存查询域名信息，但是域名服务被停止，所以两次请求都失败。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token operator">|</span>SOCK_CLOEXEC<span class="token operator">|</span>SOCK_NONBLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_UNIX<span class="token punctuation">,</span> sun_path<span class="token operator">=</span><span class="token string">"/var/run/nscd/socket"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token function">ENOENT</span> <span class="token punctuation">(</span>No such file or directory<span class="token punctuation">)</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>

<span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token operator">|</span>SOCK_CLOEXEC<span class="token operator">|</span>SOCK_NONBLOCK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_UNIX<span class="token punctuation">,</span> sun_path<span class="token operator">=</span><span class="token string">"/var/run/nscd/socket"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token function">ENOENT</span> <span class="token punctuation">(</span>No such file or directory<span class="token punctuation">)</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
</div><div class="cl-preview-section"><p><strong>2.</strong> 读取 /etc/nsswitch.conf 文件，此文件定义了 DNS 解析的顺序。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">openat</span><span class="token punctuation">(</span>AT_FDCWD<span class="token punctuation">,</span> <span class="token string">"/etc/nsswitch.conf"</span><span class="token punctuation">,</span> O_RDONLY<span class="token operator">|</span>O_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">fstat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>st_mode<span class="token operator">=</span>S_IFREG<span class="token operator">|</span><span class="token number">0644</span><span class="token punctuation">,</span> st_size<span class="token operator">=</span><span class="token number">513</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"# /etc/nsswitch.conf\n#\n# Example"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">513</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>                       <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
</div><div class="cl-preview-section"><p><strong>3.</strong> 读取 /etc/host.conf 文件，首先在本地 host 文件解析。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">openat</span><span class="token punctuation">(</span>AT_FDCWD<span class="token punctuation">,</span> <span class="token string">"/etc/host.conf"</span><span class="token punctuation">,</span> O_RDONLY<span class="token operator">|</span>O_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">fstat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>st_mode<span class="token operator">=</span>S_IFREG<span class="token operator">|</span><span class="token number">0644</span><span class="token punctuation">,</span> st_size<span class="token operator">=</span><span class="token number">92</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"# The \"order\" line is only used "</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">92</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>                       <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
</div><div class="cl-preview-section"><p><strong>4.</strong> 读取 /etc/resolv.conf 文件，此文件中配置了 DNS 服务器的地址。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">openat</span><span class="token punctuation">(</span>AT_FDCWD<span class="token punctuation">,</span> <span class="token string">"/etc/resolv.conf"</span><span class="token punctuation">,</span> O_RDONLY<span class="token operator">|</span>O_CLOEXEC<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">fstat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>st_mode<span class="token operator">=</span>S_IFREG<span class="token operator">|</span><span class="token number">0644</span><span class="token punctuation">,</span> st_size<span class="token operator">=</span><span class="token number">353</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"# Dynamic resolv.conf(5) file fo"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">353</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>                       <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
</div><div class="cl-preview-section"><p><strong>5.</strong> 向本地 DNS 服务器 10.9.255.1 请求域名解析。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 创建的是 UDP Socket</span>
<span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token operator">|</span>SOCK_CLOEXEC<span class="token operator">|</span>SOCK_NONBLOCK<span class="token punctuation">,</span> IPPROTO_IP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token comment">// 还记得 UDP Socket 调用 connect的含义吗？可以看出我们要访问的 DNS IP 地址是 10.9.255.1，端口号是 53</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET<span class="token punctuation">,</span> sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sin_addr<span class="token operator">=</span><span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"10.9.255.1"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>

<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token punctuation">{</span>tv_sec<span class="token operator">=</span><span class="token number">1578212317</span><span class="token punctuation">,</span> tv_usec<span class="token operator">=</span><span class="token number">462960</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 等待事件</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> events<span class="token operator">=</span>POLLOUT<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token function">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> revents<span class="token operator">=</span>POLLOUT<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 向 DNS 服务发送 DNS 消息。，依稀看到了 www.imooc.com</span>
<span class="token function">sendmmsg</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>msg_hdr<span class="token operator">=</span><span class="token punctuation">{</span>msg_name<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> msg_namelen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> msg_iov<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>iov_base<span class="token operator">=</span><span class="token string">" \327\1\0\0\1\0\0\0\0\0\0\3www\5imooc\3com\0\0\1\0\1"</span><span class="token punctuation">,</span> iov_len<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg_iovlen<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> msg_controllen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> msg_flags<span class="token operator">=</span>MSG_TRUNC<span class="token operator">|</span>MSG_WAITALL<span class="token operator">|</span>MSG_SYN<span class="token operator">|</span>MSG_RST<span class="token operator">|</span>MSG_NOSIGNAL<span class="token operator">|</span>MSG_WAITFORONE<span class="token operator">|</span>MSG_ZEROCOPY<span class="token operator">|</span>MSG_FASTOPEN<span class="token operator">|</span>MSG_CMSG_CLOEXEC<span class="token operator">|</span><span class="token number">0x91c20010</span><span class="token punctuation">}</span><span class="token punctuation">,</span> msg_len<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>msg_hdr<span class="token operator">=</span><span class="token punctuation">{</span>msg_name<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">,</span> msg_namelen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> msg_iov<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>iov_base<span class="token operator">=</span><span class="token string">"\334\344\1\0\0\1\0\0\0\0\0\0\3www\5imooc\3com\0\0\34\0\1"</span><span class="token punctuation">,</span> iov_len<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg_iovlen<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> msg_controllen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> msg_flags<span class="token operator">=</span>MSG_DONTWAIT<span class="token operator">|</span>MSG_EOR<span class="token operator">|</span>MSG_WAITALL<span class="token operator">|</span>MSG_SYN<span class="token operator">|</span>MSG_CONFIRM<span class="token operator">|</span>MSG_NOSIGNAL<span class="token operator">|</span>MSG_WAITFORONE<span class="token operator">|</span>MSG_BATCH<span class="token operator">|</span>MSG_ZEROCOPY<span class="token operator">|</span><span class="token number">0x1880000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> msg_len<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">// 等待事件</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> events<span class="token operator">=</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token function">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> revents<span class="token operator">=</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> FIONREAD<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">354</span><span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 读取响应消息</span>
<span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">" \327\201\200\0\1\0\7\0\r\0\0\3www\5imooc\3com\0\0\1\0\1\300"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET<span class="token punctuation">,</span> sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sin_addr<span class="token operator">=</span><span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"10.9.255.1"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token operator">-&gt;</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">354</span>
<span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token punctuation">{</span>tv_sec<span class="token operator">=</span><span class="token number">1578212317</span><span class="token punctuation">,</span> tv_usec<span class="token operator">=</span><span class="token number">467974</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> events<span class="token operator">=</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4994</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token function">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> revents<span class="token operator">=</span>POLLIN<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> FIONREAD<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 读取响应消息</span>
<span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"\334\344\201\200\0\1\0\0\0\1\0\0\3www\5imooc\3com\0\0\34\0\1\300"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">65536</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET<span class="token punctuation">,</span> sin_port<span class="token operator">=</span><span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sin_addr<span class="token operator">=</span><span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"10.9.255.1"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token operator">-&gt;</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">104</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
</div><div class="cl-preview-section"><p>到此，getaddrinfo 的执行过程分析完了，在实际编程中我们是不需要这么麻烦的，直接使用就行，做这样的剖析是为了加深理解。</p>
</div><div class="cl-preview-section"><h2 id="总结">总结</h2>
</div><div class="cl-preview-section"><p>我们以访问慕课网为例，介绍了域名的名字空间，域名的命名方式，以及域名的解析流程。最后又分析了 getaddrinfo 的域名解析过程。我们也提供了 getaddrinfo 和 getnameinfo 的样例代码，由于代码简单，所以没有再展开讲解。</p>
</div><div class="cl-preview-section"><p>域名工作原理比较容易理解，但是域名在产品构建中是非常重要的，在从事 Socket 编程的过程中，一定要通过域名访问服务器，这会让你的系统更灵活、可维护性更好。</p>
</div><div class="cl-preview-section"><h2 id="思考时间">思考时间</h2>
</div><div class="cl-preview-section"><ol>
<li>请修改 nwchecker Client/Server 程序，Client 支持通过域名访问服务器，并且服务端需要同时能监听 IPv4 和 IPv6 的地址。</li>
</ol>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img1.mukewang.com/5ed9fd44000109e706700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥58.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=80">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '16 域名解析：一定要基于域名进行 Socket 编程',
					'CID': '2105',
					'Teacher': '陈子兴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "16 域名解析：一定要基于域名进行 Socket 编程",
                    desc: "学好通用知识，提升技术竞争力",
                    imgUrl: 'https:https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    otherImgUrl: 'https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/80',
                    link: 'https://m.imooc.com/read/80'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
