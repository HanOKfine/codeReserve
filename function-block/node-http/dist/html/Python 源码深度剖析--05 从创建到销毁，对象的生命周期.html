<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>05 从创建到销毁，对象的生命周期</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="突破技术瓶颈，迈向更高岗位">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "13";
	var chapter_id = "1901";
	var chapter_title = "05 从创建到销毁，对象的生命周期";
	var aid = "76";
	var a_name = "Python 源码深度剖析";
	var a_price = "68.00";
	var a_pic = "https://img2.mukewang.com/5eb68ab400017cda05400720.jpg";
	var userId = 0;

	var column_id = '76';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-08-03&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			05 从创建到销毁，对象的生命周期
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img2.mukewang.com/5eba84590001962206400426.jpg')"></div>
	
	
		<a href="/read/76">
			<div class="course-entry">
				<img src="https://img3.mukewang.com/5e4a3ec90001ef8d04000400-40-40.jpg" alt="fasionchan">
				<h3>Python 源码深度剖析</h3>
				<p>fasionchan · 资深 Python 研发工程师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">不经一翻彻骨寒，怎得梅花扑鼻香。<p class="author">——宋帆</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h1 id="从创建到销毁，对象的生命周期">从创建到销毁，对象的生命周期</h1>
</div><div class="cl-preview-section"><p>当我们在控制台敲下这个语句， <em>Python</em> 内部是如何从无到有创建一个浮点对象的？</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token number">3.14</span>
</code></pre>
</div><div class="cl-preview-section"><p>另外，<em>Python</em> 又是怎么知道该如何将它打印到屏幕上的呢？</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>
<span class="token number">3.14</span>
</code></pre>
</div><div class="cl-preview-section"><p>对象使用完毕， <em>Python</em> 必须将其销毁，销毁的时机又该如何确定呢？ 带着这些问题，接着考察对象在从创建到销毁整个生命周期中的行为表现，从中探寻答案。</p>
</div><div class="cl-preview-section"><p>以下讨论以一个足够简单的类型 <em>float</em> 为例，对应的 <em>C</em> 实体是 <em>PyFloat_Type</em> 。</p>
</div><div class="cl-preview-section"><h2 id="c-api">C API</h2>
</div><div class="cl-preview-section"><p>开始讨论对象创建前，先介绍 <em>Python</em> 提供的 <em>C API</em> 。</p>
</div><div class="cl-preview-section"><p><em>Python</em> 是用 <em>C</em> 写成的，对外提供了 <em>C API</em> ，让用户可以从 <em>C</em> 环境中与其交互。 <em>Python</em> 内部也大量使用这些 <em>API</em> ，为了更好研读源码，先系统了解 <em>API</em> 组成结构很有必要。 <em>C API</em> 分为两类： <strong>泛型 API</strong> 以及 <strong>特型 API</strong> 。</p>
</div><div class="cl-preview-section"><h3 id="泛型api">泛型 API</h3>
</div><div class="cl-preview-section"><p><strong>泛型 API</strong> 与类型无关，属于 <strong>抽象对象层</strong> ( <em>Abstract Object Layer</em> )，简称 <em>AOL</em> 。 这类 API 参数是 <em>PyObject</em>* ，可处理任意类型的对象， <em>API</em> 内部根据对象类型区别处理。</p>
</div><div class="cl-preview-section"><p>以对象打印函数为例：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">int</span>
<span class="token function">PyObject_Print</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>op<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>接口第一个参数为待打印对象，可以是任意类型的对象，因此参数类型是 <em>PyObject</em>* 。 <em>Python</em> 内部一般都是通过 <em>PyObject</em>* 引用对象，以达到泛型化的目的。</p>
</div><div class="cl-preview-section"><p>对于任意类型的对象，均可调用 <em>PyObject_Print</em> 将其打印出来：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token comment">// 打印浮点对象</span>
PyObject <span class="token operator">*</span>fo <span class="token operator">=</span> <span class="token function">PyFloatObject_FromDouble</span><span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyObject_Print</span><span class="token punctuation">(</span>fo<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印整数对象</span>
PyObject <span class="token operator">*</span>lo <span class="token operator">=</span> <span class="token function">PyFloatObject_FromLong</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyObject_Print</span><span class="token punctuation">(</span>lo<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>PyObject_Print</em> 接口内部根据对象类型，决定如何输出对象。</p>
</div><div class="cl-preview-section"><h3 id="特型api">特型 API</h3>
</div><div class="cl-preview-section"><p><strong>特型 API</strong> 与类型相关，属于 <strong>具体对象层</strong> ( <em>Concrete Object Layer</em> )，简称 <em>COL</em> 。 这类 <em>API</em> 只能作用于某种类型的对象，例如浮点对象 <em>PyFloatObject</em> 。 <em>Python</em> 内部为每一种内置对象提供了这样一组 <em>API</em> ，举例如下：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyObject <span class="token operator">*</span>
<span class="token function">PyFloat_FromDouble</span><span class="token punctuation">(</span><span class="token keyword">double</span> fval<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>PyFloat_FromDouble</em> 创建一个浮点对象，并将它初始化为给定值 <em>fval</em> 。</p>
</div><div class="cl-preview-section"><h2 id="对象的创建">对象的创建</h2>
</div><div class="cl-preview-section"><p>经过前面的理论学习，我们知道对象的 <strong>元数据</strong> 保存在对应的 <strong>类型对象</strong> 中，元数据当然也包括 <strong>对象如何创建</strong> 的信息。 因此，有理由相信 <strong>实例对象</strong> 由 <strong>类型对象</strong> 创建。</p>
</div><div class="cl-preview-section"><p>不管创建对象的流程如何，最终的关键步骤都是 <strong>分配内存</strong> 。 <em>Python</em> 对 <strong>内建对象</strong> 是无所不知的，因此可以提供 <em>C API</em> ，直接分配内存并执行初始化。 以 <em>PyFloat_FromDouble</em> 为例，在接口内部为 <em>PyFloatObject</em> 结构体分配内存，并初始化相关字段即可。</p>
</div><div class="cl-preview-section"><p>对于用户自定义的类型 <em>class Dog(object)</em> ， <em>Python</em> 就无法事先提供 <em>PyDog_New</em> 这样的 <em>C API</em> 了。 这种情况下，就只能通过 <em>Dog</em> 所对应的类型对象创建实例对象了。 至于需要分配多少内存，如何进行初始化，答案就需要在 <strong>类型对象</strong> 中找了。</p>
</div><div class="cl-preview-section"><p>总结起来，<em>Python</em> 内部一般通过这两种方法创建对象：</p>
</div><div class="cl-preview-section"><ul>
<li>通过 <em>C API</em> ，例如 <em>PyFloat_FromDouble</em> ，多用于内建类型；</li>
<li>通过类型对象，例如 <em>Dog</em> ，多用于自定义类型；</li>
</ul>
</div><div class="cl-preview-section"><p>通过类型对象创建实例对象，是一个更通用的流程，同时支持内置类型和自定义类型。 以创建浮点对象为例，我们还可以通过浮点类型 <em>PyFloat_Type</em> 来创建：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'3.14'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> pi
<span class="token number">3.14</span>
</code></pre>
</div><div class="cl-preview-section"><p>例子中我们通过调用类型对象 <em>float</em> ，实例化了一个浮点实例 <em>pi</em> ，对象居然还可以调用！在 <em>Python</em> 中，可以被调用的对象就是 <strong> 可调用对象</strong> 。</p>
</div><div class="cl-preview-section"><p>问题来了，可调用对象被调用时，执行什么函数呢？ 由于类型对象保存着实例对象的元信息， <em>float</em> 类型对象的类型是 <em>type</em> ，因此秘密应该就隐藏在 <em>type</em> 中。</p>
</div><div class="cl-preview-section"><p>再次考察 <em>PyType_Type</em> ，我们找到了 <em>tp_call</em> 字段，这是一个函数指针：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyTypeObject PyType_Type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyType_Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">"type"</span><span class="token punctuation">,</span>                                     <span class="token comment">/* tp_name */</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyHeapTypeObject<span class="token punctuation">)</span><span class="token punctuation">,</span>                   <span class="token comment">/* tp_basicsize */</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyMemberDef<span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token comment">/* tp_itemsize */</span>

    <span class="token comment">// ...</span>
    <span class="token punctuation">(</span>ternaryfunc<span class="token punctuation">)</span>type_call<span class="token punctuation">,</span>                     <span class="token comment">/* tp_call */</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>当实例对象被调用时，便执行 <em>tp_call</em> 字段保存的处理函数。</p>
</div><div class="cl-preview-section"><p>因此， <em>float(‘3.14’)</em> 在 <em>C</em> 层面等价于：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyFloat_Type<span class="token punctuation">.</span>ob_type<span class="token punctuation">.</span><span class="token function">tp_call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyFloat_Type<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>即：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyType_Type<span class="token punctuation">.</span><span class="token function">tp_call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyFloat_Type<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>最终执行， type_call 函数：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token function">type_call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyFloat_Type<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>调用参数通过 <em>args</em> 和 <em>kwargs</em> 两个对象传递，先不展开，留到函数机制中详细介绍。</p>
</div><div class="cl-preview-section"><p>接着围观 <em>type_call</em> 函数，定义于 <em>Include/typeobject.c</em> ，关键代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> PyObject <span class="token operator">*</span>
<span class="token function">type_call</span><span class="token punctuation">(</span>PyTypeObject <span class="token operator">*</span>type<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>kwds<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyObject <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
    obj <span class="token operator">=</span> type<span class="token operator">-&gt;</span><span class="token function">tp_new</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj <span class="token operator">=</span> <span class="token function">_Py_CheckFunctionResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PyObject<span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
    type <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token operator">-&gt;</span>tp_init <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> type<span class="token operator">-&gt;</span><span class="token function">tp_init</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            obj <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>可以看到，关键的步骤有两个：</p>
</div><div class="cl-preview-section"><ol>
<li>调用类型对象 <em>tp_new</em> 函数指针 <strong>申请内存</strong> (第 <em>7</em> 行)；</li>
<li>必要时调用类型对象 <em>tp_init</em> 函数指针对对象进行 <strong>初始化</strong> (第 <em>15</em> 行)；</li>
</ol>
</div><div class="cl-preview-section"><p>至此，对象的创建过程已经非常清晰了：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5eba86170001db7f11440939.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>总结一下，<em>float</em> 类型对象是 <strong>可调用对象</strong> ，调用 <em>float</em> 即可创建实例对象：</p>
</div><div class="cl-preview-section"><ol>
<li>调用 <em>float</em> ， <em>Python</em> 最终执行其类型对象 <em>type</em> 的 <em>tp_call</em> 函数；</li>
<li><em>tp_call</em> 函数调用 <em>float</em> 的 <em>tp_new</em> 函数为实例对象分配 <strong>内存空间</strong> ；</li>
<li><em>tp_call</em> 函数必要时进一步调用 <em>tp_init</em> 函数对实例对象进行 <strong>初始化</strong> ；</li>
</ol>
</div><div class="cl-preview-section"><h2 id="对象的多态性">对象的多态性</h2>
</div><div class="cl-preview-section"><p><em>Python</em> 创建一个对象，比如 <em>PyFloatObject</em> ，会分配内存，并进行初始化。 此后， <em>Python</em> 内部统一通过一个 <em>PyObject</em>* 变量来保存和维护这个对象，而不是通过 <em>PyFloatObject</em>* 变量。</p>
</div><div class="cl-preview-section"><p>通过 <em>PyObject</em>* 变量保存和维护对象，可以实现更抽象的上层逻辑，而不用关心对象的实际类型和实现细节。 以对象哈希值计算为例，假设有这样一个函数接口：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">Py_hash_t
<span class="token function">PyObject_Hash</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>该函数可以计算任意对象的哈希值，不管对象类型是啥。 例如，计算浮点对象哈希值：</p>
</div><div class="cl-preview-section"><pre class=" language-c"><code class="prism  language-c">PyObject <span class="token operator">*</span>fo <span class="token operator">=</span> <span class="token function">PyFloatObject_FromDouble</span><span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyObject_Hash</span><span class="token punctuation">(</span>fo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>对于其他类型，例如整数对象，也是一样的：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">PyObject <span class="token operator">*</span>lo <span class="token operator">=</span> <span class="token function">PyLongObject_FromLong</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyObject_Hash</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>然而，对象类型不同，其行为也千差万别，哈希值计算方法便是如此。 <em>PyObject_Hash</em> 函数如何解决这个问题呢？ 到 <em>Object/object.c</em> 中寻找答案：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c">Py_hash_t
<span class="token function">PyObject_Hash</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_hash <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-&gt;</span>tp_hash<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* To keep to the general practice that inheriting
    * solely from object in C code should work without
    * an explicit call to PyType_Ready, we implicitly call
    * PyType_Ready here and then check the tp_hash slot again
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-&gt;</span>tp_hash <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-&gt;</span>tp_hash<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Otherwise, the object can't be hashed */</span>
    <span class="token keyword">return</span> <span class="token function">PyObject_HashNotImplemented</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p>函数先通过 <em>ob_type</em> 指针找到对象的类型 (第 <em>4</em> 行)； 然后通过类型对象的 <em>tp_hash</em> 函数指针，调用对应的哈希值计算函数 (第 <em>6</em> 行)。 换句话讲， <em>PyObject_Hash</em> 根据对象的类型，调用不同的函数版本。 这不就是 <strong> 多态</strong> 吗？</p>
</div><div class="cl-preview-section"><p>通过 <em>ob_type</em> 字段， <em>Python</em> 在 <em>C</em> 语言层面实现了对象的 <strong>多态</strong> 特性， 思路跟 <em>C++</em> 中的 <strong>虚表指针</strong> 有异曲同工之妙。</p>
</div><div class="cl-preview-section"><h2 id="对象的行为">对象的行为</h2>
</div><div class="cl-preview-section"><p>不同对象的行为不同，比如哈希值计算方法就不同，由类型对象中 <em>tp_hash</em> 字段决定。 除了 <em>tp_hash</em> ，我们看到 <em>PyTypeObject</em> 结构体还定义了很多函数指针，这些指针最终都会指向某个函数，或者为空。 这些函数指针可以看做是 <strong>类型对象</strong> 中定义的 <strong>操作</strong> ，这些操作决定对应 <strong>实例对象</strong> 在运行时的 <strong>行为</strong> 。</p>
</div><div class="cl-preview-section"><p>尽管如此，不同对象也有一些共性。 举个例子，<strong>整数对象</strong> 和 <strong>浮点对象</strong> 都支持加减乘除等 <strong>数值型操作</strong> ：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span>
<span class="token number">3</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">3.14</span> <span class="token operator">*</span> <span class="token number">3.14</span>
<span class="token number">9.8596</span>
</code></pre>
</div><div class="cl-preview-section"><p><strong>元组对象</strong> <em> tuple</em> 和 <strong>列表对象</strong> <em> list</em> 都支持下标操作：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'car'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token string">'dog'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'alpha'</span><span class="token punctuation">,</span> <span class="token string">'beta'</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token string">'beta'</span>
</code></pre>
</div><div class="cl-preview-section"><p>因此，以对象行为为依据，可以对对象进行分类：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5eba86080001a71a03740288.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p><em>Python</em> 便以此为依据，为每个类别都定义了一个 <strong>标准操作集</strong> ：</p>
</div><div class="cl-preview-section"><ul>
<li><em>PyNumberMethods</em> 结构体定义了 <strong>数值型</strong> 操作；</li>
<li><em>PySequenceMethods</em> 结构体定义了 <strong>序列型</strong> 操作；</li>
<li><em>PyMappingMethods</em> 结构体定义了 <strong>关联型</strong> 操作；</li>
</ul>
</div><div class="cl-preview-section"><p>只要 <strong>类型对象</strong> 提供相关 <strong>操作集</strong> ， <strong>实例对象</strong> 便具备对应的 <strong>行为</strong> 。 操作集字段如下：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _typeobject <span class="token punctuation">{</span>
    PyObject_VAR_HEAD
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tp_name<span class="token punctuation">;</span> <span class="token comment">/* For printing, in format "&lt;module&gt;.&lt;name&gt;" */</span>
    Py_ssize_t tp_basicsize<span class="token punctuation">,</span> tp_itemsize<span class="token punctuation">;</span> <span class="token comment">/* For allocation */</span>

    <span class="token comment">// ...</span>
    <span class="token comment">/* Method suites for standard classes */</span>

    PyNumberMethods <span class="token operator">*</span>tp_as_number<span class="token punctuation">;</span>
    PySequenceMethods <span class="token operator">*</span>tp_as_sequence<span class="token punctuation">;</span>
    PyMappingMethods <span class="token operator">*</span>tp_as_mapping<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
    <span class="token comment">/* Functions to access object as input/output buffer */</span>
    PyBufferProcs <span class="token operator">*</span>tp_as_buffer<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> PyTypeObject<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p>以 <em>float</em> 为例，类型对象 <em>PyFloat_Type</em> 相关字段是这样初始化的：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token keyword">static</span> PyNumberMethods float_as_number <span class="token operator">=</span> <span class="token punctuation">{</span>
    float_add<span class="token punctuation">,</span>          <span class="token comment">/* nb_add */</span>
    float_sub<span class="token punctuation">,</span>          <span class="token comment">/* nb_subtract */</span>
    float_mul<span class="token punctuation">,</span>          <span class="token comment">/* nb_multiply */</span>
    float_rem<span class="token punctuation">,</span>          <span class="token comment">/* nb_remainder */</span>
    float_divmod<span class="token punctuation">,</span>       <span class="token comment">/* nb_divmod */</span>
    float_pow<span class="token punctuation">,</span>          <span class="token comment">/* nb_power */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

PyTypeObject PyFloat_Type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyType_Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token string">"float"</span><span class="token punctuation">,</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyFloatObject<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// ...</span>
    <span class="token operator">&amp;</span>float_as_number<span class="token punctuation">,</span>                           <span class="token comment">/* tp_as_number */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_sequence */</span>
    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_mapping */</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li>字段 <em>tp_as_number</em> 非空，因此 <em>float</em> 对象 <strong>支持数值型操作</strong> ；</li>
<li>字段 <em>tp_as_sequence</em> 为空，因此 <em>float</em> 对象 <strong>不支持序列型操作</strong> ；</li>
<li>字段 <em>tp_as_mapping</em> 为空，因此 <em>float</em> 对象 <strong>不支持关联型操作</strong> ；</li>
</ul>
</div><div class="cl-preview-section"><p>注意到， <em>float_as_number</em> 变量中相关函数指针都初始化为对应的 <em>float</em> 版本操作函数。 由于篇幅有限，这里先不深入展开。</p>
</div><div class="cl-preview-section"><h2 id="引用计数">引用计数</h2>
</div><div class="cl-preview-section"><p><em>C/C++</em> 赋予程序员极大的自由，可以任意申请内存，并按自己的意图灵活管理。 然而，权利的另一面则对应着 <strong>责任</strong> ，一旦内存不再使用，程序员必须将其释放。 这给程序员带来极大的 <strong>工作负担</strong> ，并导致大量问题： <strong>内存泄露</strong> 、 <strong>野指针</strong> 、 <strong>越界访问</strong> 等。</p>
</div><div class="cl-preview-section"><p>许多后来兴起的开发语言，如 <em>Java</em> 、 <em>Golang</em> 等，选择 <strong>由语言本身负责内存的管理</strong> 。 <strong>垃圾回收机制</strong> 的引入，程序员摆脱了内存管理的噩梦，可以更专注于业务逻辑。 于此同时，开发人员失去了灵活使用内存的机会，也牺牲了一定的执行效率。</p>
</div><div class="cl-preview-section"><p>随着垃圾回收机制日益完善，可在大部分对性能要求不苛刻的场景中引入，利大于弊。 <em>Python</em> 也采用垃圾回收机制，代替程序员进行繁重的内存管理，<strong>提升开发效率</strong> 的同时，降低 <em>bug</em> 发生的几率。</p>
</div><div class="cl-preview-section"><p><em>Python</em> 垃圾回收机制的关键是对象的 <strong>引用计数</strong> ，它决定了一个对象的生死。 我们知道每个 <em>Python</em> 对象都有一个 <em>ob_refcnt</em> 字段，记录着对象当前的引用计数。 当对象被其他地方引用时， <em>ob_refcnt</em> 加一； 当引用解除时， <em>ob_refcnt</em> 减一。 当 <em>ob_refcnt</em> 为零，说明对象已经没有任何引用了，这时便可将其回收。</p>
</div><div class="cl-preview-section"><p><em>Python</em> 对象创建后，���用计数设为 <em>1</em> ：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token number">3.14</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>咦？这里引用计数为啥是 <em>2</em> 呢？</p>
</div><div class="cl-preview-section"><p>对象作为函数参数传递，需要将引用计数加一，避免对象被提前销毁；函数返回时，再将引用计数减一。 因此，例子中 <em>getrefcount</em> 函数看到的对象引用计数为 <em>2</em> 。</p>
</div><div class="cl-preview-section"><p>接着，变量赋值让对象多了一个引用，这很好理解：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> a
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">3</span>
</code></pre>
</div><div class="cl-preview-section"><p>将对象放在容器对象中，引用计数也增加了，符合预期：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l
<span class="token punctuation">[</span><span class="token number">3.14</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">4</span>
</code></pre>
</div><div class="cl-preview-section"><p>我们将 <em>b</em> 变量删除，引用计数减少了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">del</span> b
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">3</span>
</code></pre>
</div><div class="cl-preview-section"><p>接着，将列表清空，引用计数进一步下降：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">2</span>
</code></pre>
</div><div class="cl-preview-section"><p>最后，将变量 <em>a</em> 删除后，引用计数降为 <em>0</em> ，便不复存在了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">del</span> a
</code></pre>
</div><div class="cl-preview-section"><p>在 <em>Python</em> 中，很多场景都涉及引用计数的调整，例如：</p>
</div><div class="cl-preview-section"><ul>
<li>容器操作；</li>
<li>变量赋值；</li>
<li>函数参数传递；</li>
<li>属性操作；</li>
</ul>
</div><div class="cl-preview-section"><p>为此， <em>Python</em> 定义了两个非常重要的宏，用于维护对象应用计数。 其中， <em>Py_INCREF</em> 将对象应用计数加一 ( <em>3</em> 行)：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> Py_INCREF(op) (                         \
    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA       \
    ((PyObject *)(op))-&gt;ob_refcnt++)</span>
</code></pre>
</div><div class="cl-preview-section"><p><em>Py_DECREF</em> 将引用计数减一 ( <em>5</em> 行)，并在引用计数为 <em>0</em> 是回收对象 ( <em>8</em> 行)：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">define</span> Py_DECREF(op)                                   \
    do {                                                \
        PyObject *_py_decref_tmp = (PyObject *)(op);    \
        if (_Py_DEC_REFTOTAL  _Py_REF_DEBUG_COMMA       \
        --(_py_decref_tmp)-&gt;ob_refcnt != 0)             \
            _Py_CHECK_REFCNT(_py_decref_tmp)            \
        else                                            \
            _Py_Dealloc(_py_decref_tmp);                \
    } while (0)</span>
</code></pre>
</div><div class="cl-preview-section"><p>当一个对象引用计数为 <em>0</em> ， <em>Python</em> 便调用对象对应的析构函数销毁对象，但这并不意味着对象内存一定会回收。 为了提高内存分配效率， <em>Python</em> 为一些常用对象维护了内存池， 对象回收后内存进入内存池中，以便下次使用，由此 <strong>避免频繁申请、释放内存</strong> 。</p>
</div><div class="cl-preview-section"><p><strong>内存池</strong> 技术作为程序开发的高级话题，需要更大的篇幅，放在后续章节中介绍。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img.mukewang.com/5eba845d00011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<ul class="comment-content">
				
				<li class="item">
					<a href="/read/commentdetail/6683">
						<img src="https://img.mukewang.com/598428590001910101000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">qq_泡沫_40</h4>
						<div class="comment-text">“
再次考察 PyType_Type ，我们找到了 tp_call 字段，这是一个函数指针：
当实例对象被调用时，便执行 tp_call 字段保存的处理函数。
”
这里应该是当类型对象被调用吧？</div>
						<div>
							
								<div class="reply">讲师回复：当(实例)对象被调用时，便执行其类型对象tp_call字段保存的处理函数。float既是类型对象，也是实例对象，它是type的实例。当float被调用时，Python执行其类型对象type的tp_call函数，即PyType_Type.tp_call。因此，这里看问题的角度是：float作为type的实例对象被调用。这也是专栏开篇就讨论对象模型的原因，明确每个对象在对象关系网络中的位置很重要。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-08-31</span>
						<a href="/read/commentdetail/6683">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="6683" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6306">
						<img src="https://img1.mukewang.com/images/unknow-160.png" alt="" class="avatar">
						<h4 class="nickname">郭海林352851</h4>
						<div class="comment-text">Py_hash_t
PyObject_Hash(PyObject *v)
{
    PyTypeObject *tp = Py_TYPE(v);
    if (tp-&gt;tp_hash != NULL)
        return (*tp-&gt;tp_hash)(v);
    /* To keep to the general practice that inheriting
    * solely from object in C code should work without
    * an explicit call to PyType_Ready, we implicitly call
    * PyType_Ready here and then check the tp_hash slot again
    */
    if (tp-&gt;tp_dict == NULL) {
        if (PyType_Ready(tp) &lt; 0)
            return -1;
        if (tp-&gt;tp_hash != NULL)
            return (*tp-&gt;tp_hash)(v);
    }
    /* Otherwise, the object can't be hashed */
    return PyObject_HashNotImplemented(v);
}

这段代码第五行已经判断了 tp-&gt;tp_hash 不为空，为什么第15行还要判断，根本就走不到第15行这个分支吧</div>
						<div>
							
								<div class="reply">讲师回复：而tp_dict为空，是类型对象未初始化的重要特征。其实，这段代码还可以这么写：①先判断tp_dict，如果发现类型对象未初始化，则调用PyType_Ready对它进行初始化；②（执行到这一步可以保证类型对象已初始化）判断tp_hash，看它是否支持哈希计算。这种写法更加清晰，但在类型对象已初始化的场景，比源码多了一次对tp_dict的if判断，效率不如源码。除此之外，Python源码中还有很多其他快分支。快分支的特点是，命中率极高，因此尽早判断尽早处理。回到当前这个场景，只有在类型对象未初始化时，快分支不命中，其余情况均命中。也就是说快分支最多只有在第一次调用时未命中，其他情况都是命中，比例是1:n-1，命中率极高。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-26</span>
						<a href="/read/commentdetail/6306">
							<span class="icon r"><i class="imwap-comment"></i><em>3</em></span>
						</a>
						<span data-cid="6306" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6305">
						<img src="https://img.mukewang.com/images/unknow-160.png" alt="" class="avatar">
						<h4 class="nickname">郭海林352851</h4>
						<div class="comment-text">PyObject *lo = PyFloatObject_FromDouble(3.14);
PyObject_Hash(fo);

这段代码 lo 写错了吧，应该是fo</div>
						<div>
							
								<div class="reply">讲师回复：收到~</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-26</span>
						<a href="/read/commentdetail/6305">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6305" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6282">
						<img src="https://img4.mukewang.com/545868330001e54e02200220-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">慕仙7591463</h4>
						<div class="comment-text">建议老师给购买课程的同学创建一个群，一方面方便大家交流，另外一方面培养您的忠实粉丝，一路追随！</div>
						<div>
							
								<div class="reply">讲师回复：说干就干哈哈：278378402</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-23</span>
						<a href="/read/commentdetail/6282">
							<span class="icon r"><i class="imwap-comment"></i><em>3</em></span>
						</a>
						<span data-cid="6282" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6240">
						<img src="https://img1.mukewang.com/533e4cc800016ffd02200220-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">慕粉2100464607</h4>
						<div class="comment-text">&gt;&gt;&gt; m=34555
&gt;&gt;&gt; sys.getrefcount(m)
2
&gt;&gt;&gt; m="p"
&gt;&gt;&gt; sys.getrefcount(m)
15
&gt;&gt;&gt;这是怎么回事呢？赋值不一样会影响引用次数？</div>
						<div>
							
								<div class="reply">讲师回复：&amp;gt;&amp;gt;&amp;gt; m=&quot;p&quot; &amp;gt;&amp;gt;&amp;gt; sys.getrefcount(m) 是查看字符串&quot;p&quot;这个对象的引用次数。在后续介绍字符串对象的章节中，你会发现Python将单字符对象作为静态对象实现，你可以把它理解成单例模式。换句话讲，不管你在什么时候创建字符对象&quot;p&quot;，Python都返回全局唯一的实例对象。而Python虚拟机内部也可能会引用这些单字符对象，因此你看到的引用计数可能会比预想的大。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-21</span>
						<a href="/read/commentdetail/6240">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="6240" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/6205">
						<img src="https://img2.mukewang.com/5b8cef070001f24302000200-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">weixin_慕后端5555028</h4>
						<div class="comment-text">老师，请问您还有其他专栏吗？讲的特别好，如果有其他课程能麻烦您发一下链接吗</div>
						<div>
							
								<div class="reply">讲师回复：多谢支持！这是我第一个专栏，花的时间精力比预想的多，目前还在收尾阶段。后续计划写网络协议、网络编程或者大规模分布式系统设计主题，具体待定。我有一个博客 https://fasionchan.com/ ，上面会写一些比较零散的东西，也有一些不太完整的主题，例如网络编程：https://network.fasionchan.com/ ，可以先凑合着看看。哈哈~</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-07-19</span>
						<a href="/read/commentdetail/6205">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="6205" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5825">
						<img src="https://img2.mukewang.com/5f02eed50001d9e104000400-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">Python源码</h4>
						<div class="comment-text">老师，当内置类型通过类型对象创建实例对象的时候有一点微妙，比如a＝float（3.14），实际上3.14本身就是对象，从3.14这个对象中抽出3.14的值来创建对象，有点绕。但是从高层来看这提供了一种统一感。是这样子吗？</div>
						<div>
							
								<div class="reply">讲师回复：从底层上看，由于float是不可变对象，因此float(3.14)只需将3.14这个对象直接返回即可。你说很对，从高层上看，float(3.14)与float('3.14')还有其他float(xxxx)形式高度统一。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-06-13</span>
						<a href="/read/commentdetail/5825">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="5825" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5596">
						<img src="https://img2.mukewang.com/5333a0350001692e02200220-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">慕码人3179062</h4>
						<div class="comment-text">提个小小小建议，代码看不到行号，文章里有引用了行号，看着比较麻烦</div>
						<div>
							
								<div class="reply">讲师回复：嗯嗯，我把建议转给平台研发了，程序哥哥们正迭代优化中，敬请期待~</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-25</span>
						<a href="/read/commentdetail/5596">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="5596" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>1</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5592">
						<img src="https://img.mukewang.com/56a34ce5000116bc01000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">妄言九天</h4>
						<div class="comment-text">#define Py_DECREF(op)                                   \
    do {                                                \
        PyObject *_py_decref_tmp = (PyObject *)(op);    \
        if (_Py_DEC_REFTOTAL  _Py_REF_DEBUG_COMMA       \
        --(_py_decref_tmp)->ob_refcnt != 0)             \
            _Py_CHECK_REFCNT(_py_decref_tmp)            \
        else                                            \
            _Py_Dealloc(_py_decref_tmp);                \
    } while (0)
老师对于这段里，为什么使用do{}while(0)有点不理解,while(0)应该循环稳定只执行一次，那么为什么不直接写里面代码，而是要加上while呢？</div>
						<div>
							
								<div class="reply">讲师回复：这是C宏定义的实现技巧，让Py_DECREF更像一个函数，兼容性更好。由于C语言不是本专栏的重点，这里没有过多展开。你如果对C语言有兴趣的话鼓励深入学习一下，对了解底层原理很有帮助。</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-25</span>
						<a href="/read/commentdetail/5592">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="5592" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5581">
						<img src="https://img.mukewang.com/56a34ce5000116bc01000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">妄言九天</h4>
						<div class="comment-text">PyObject *fo = PyFloatObject_FromDouble(3.14);
PyObject_Print(fo, stdout, 0);

// 打印整数对象
PyObject *lo = PyFloatObject_FromDouble(100);
PyObject_Print(lo, stdout, 0);

这里的打印整数对象实例化的类是写错了吗？为什么也是PyFloatObject_FromDouble</div>
						<div>
							
								<div class="reply">讲师回复：此处是笔误，多谢指出，我们马上进行修正。你看得很认真哦，赞一个?</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-23</span>
						<a href="/read/commentdetail/5581">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="5581" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>1</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5454">
						<img src="https://img1.mukewang.com/5dee30470001fa4702400240-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">技能锦囊</h4>
						<div class="comment-text">哇</div>
						<div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-13</span>
						<a href="/read/commentdetail/5454">
							<span class="icon r"><i class="imwap-comment"></i><em>2</em></span>
						</a>
						<span data-cid="5454" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>0</em></span>
					</p>
				</li>
				
				<li class="item">
					<a href="/read/commentdetail/5453">
						<img src="https://img3.mukewang.com/5eecf1fd00011cc308990899-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">楊唯希</h4>
						<div class="comment-text">期待尽快更新</div>
						<div>
							
								<div class="reply">讲师回复：多谢支持。马不停蹄创作中，敬请期待~</div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-05-13</span>
						<a href="/read/commentdetail/5453">
							<span class="icon r"><i class="imwap-comment"></i><em>1</em></span>
						</a>
						<span data-cid="5453" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>2</em></span>
					</p>
				</li>
				
			</ul>
			
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥68.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=76">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '05 从创建到销毁，对象的生命周期',
					'CID': '1901',
					'Teacher': 'fasionchan'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "05 从创建到销毁，对象的生命周期",
                    desc: "突破技术瓶颈，迈向更高岗位",
                    imgUrl: 'https:https://img2.mukewang.com/5eb68ab400017cda05400720.jpg',
                    otherImgUrl: 'https://img2.mukewang.com/5eb68ab400017cda05400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/76',
                    link: 'https://m.imooc.com/read/76'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
