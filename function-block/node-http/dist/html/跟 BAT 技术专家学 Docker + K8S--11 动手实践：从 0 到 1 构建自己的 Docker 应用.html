<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>11 动手实践：从 0 到 1 构建自己的 Docker 应用</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="系统学懂学透容器技术，实战无忧">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "2";
	var chapter_id = "2243";
	var chapter_title = "11 动手实践：从 0 到 1 构建自己的 Docker 应用";
	var aid = "84";
	var a_name = "跟 BAT 技术专家学 Docker + K8S";
	var a_price = "68.00";
	var a_pic = "https://img3.mukewang.com/5f18f1b00001f3f605400720.jpg";
	var userId = 0;

	var column_id = '84';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-07-29&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			11 动手实践：从 0 到 1 构建自己的 Docker 应用
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img2.mukewang.com/5f16cee40001861c06400426.jpg')"></div>
	
	
		<a href="/read/84">
			<div class="course-entry">
				<img src="https://img.mukewang.com/5f1e7dc1000152f304400440-40-40.jpg" alt="legendtkl">
				<h3>跟 BAT 技术专家学 Docker + K8S</h3>
				<p>legendtkl · BAT 资深技术专家</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">不要问你的国家能够为你做些什么，而要问你可以为国家做些什么。<p class="author">——林肯</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><p>在前面的第 5 小节《Docker 镜像介绍》中，我们简单构建了一个 Golang 的 http server 的 Docker 应用。在日常开发或者生产环境中，很多情况下，我们的系统都不是一个应用可以搞定的，而是由很多个部分组成，比如 webapp，数据库，缓存等。所以这一章的例子，我们就以一个 web 应用 + 缓存 redis 作为例子构建一个稍微复杂点的应用。</p>
</div><div class="cl-preview-section"><p>使用的语言和应用的版本如下：Python 3.8.1，Flask库 1.1.1，Redis库 3.4.1。</p>
</div><div class="cl-preview-section"><h2 id="web-应用">1. web 应用</h2>
</div><div class="cl-preview-section"><p>这次我们使用 Python 来编写我们的 web 应用，上一次我们使用的是 Go 语言。由于 Go 语言部署直接使用二进制文件，Dockerfile 会极其的简单，为了让大家熟悉一下 Dockerfile 的应用，所以这里我们使用 Python 语言里编写我们的 web 应用。</p>
</div><div class="cl-preview-section"><p>Python 语言相信大家都很熟悉，不熟悉也没有关系，代码都很简单。基于 Python 的 web 网络应用框架比较出名的有 Django，Tornado，Flask 等。我们这里使用 Flask 来构建我们的应用，因为 Flask 是一种极其轻量的框架，正如作者所说：</p>
</div><div class="cl-preview-section"><blockquote>
<p>Flask is a lightweight <a href="https://wsgi.readthedocs.io/">WSGI</a> web application framework. It is designed to make getting started quick and easy, with the ability to scale up to complex applications. It began as a simple wrapper around <a href="https://www.palletsprojects.com/p/werkzeug/">Werkzeug</a> and <a href="https://www.palletsprojects.com/p/jinja/">Jinja</a> and has become one of the most popular Python web application frameworks.</p>
<p>Flask offers suggestions, but doesn’t enforce any dependencies or project layout. It is up to the developer to choose the tools and libraries they want to use. There are many extensions provided by the community that make adding new functionality easy.</p>
</blockquote>
</div><div class="cl-preview-section"><p>关于 Flask 的更多信息，可以参考 <a href="https://flask.palletsprojects.com">Flask 的官方网站</a>或者 <a href="https://github.com/pallets/flask">Github 主页</a>。</p>
</div><div class="cl-preview-section"><h3 id="flask-安装">1.1 Flask 安装</h3>
</div><div class="cl-preview-section"><p>Flask 安装很简单，和其他 Python 依赖安装基本没有区别。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">pip <span class="token function">install</span> flask
</code></pre>
</div><div class="cl-preview-section"><h3 id="flask-demo">1.2 Flask demo</h3>
</div><div class="cl-preview-section"><p>我们前面说了 Flask 是一个非常轻量的 web 框架，那么有多轻量呢？轻量到我们使用下面几行代码就可以构建出来一个简单的 web 应用。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello, Flask'</span>
</code></pre>
</div><div class="cl-preview-section"><p>启动应用。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">$ <span class="token function">env</span> FLASK_APP<span class="token operator">=</span>hello.py flask run
 * Serving Flask app <span class="token string">"hello"</span>
 * Running on http://127.0.0.1:5000/ <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>应用默认启动在 5000 端口，我们可以通过 <code>-p</code> 参数指定引用的启动端口。当然 Flask 还支持其他参数，我们可以通过 <code>flask run --help</code> 进行查看。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">root@a36d1df88169:/<span class="token comment"># flask run --help</span>
Usage: flask run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

  Run a local development server.

  This server is <span class="token keyword">for</span> development purposes only. It does not provide the
  stability, security, or performance of production WSGI servers.

  The reloader and debugger are enabled by default <span class="token keyword">if</span> FLASK_ENV<span class="token operator">=</span>development
  or FLASK_DEBUG<span class="token operator">=</span>1.

Options:
  -h, --host TEXT                 The interface to bind to.
  -p, --port INTEGER              The port to bind to.
  --cert PATH                     Specify a certificate <span class="token function">file</span> to use HTTPS.
  --key FILE                      The key <span class="token function">file</span> to use when specifying a
                                  certificate.
  --reload / --no-reload          Enable or disable the reloader. By default
                                  the reloader is active <span class="token keyword">if</span> debug is enabled.
  --debugger / --no-debugger      Enable or disable the debugger. By default
                                  the debugger is active <span class="token keyword">if</span> debug is enabled.
  --eager-loading / --lazy-loader
                                  Enable or disable eager loading. By default
                                  eager loading is enabled <span class="token keyword">if</span> the reloader is
                                  disabled.
  --with-threads / --without-threads
                                  Enable or disable multithreading.
  --extra-files PATH              Extra files that trigger a reload on change.
                                  Multiple paths are separated by <span class="token string">':'</span><span class="token keyword">.</span>
  --help                          Show this message and exit.
</code></pre>
</div><div class="cl-preview-section"><p>应用启动了之后，我们可以访问 5000 端口来验证应用是不是正常的。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># curl localhost:5000</span>
Hello, Flask
</code></pre>
</div><div class="cl-preview-section"><h3 id="flask-使用">1.3 Flask 使用</h3>
</div><div class="cl-preview-section"><p>上面介绍了 Flask 最简单的使用 demo，下面我们使用 Flask 来编写我们应用和 Redis 进行交互。首先我们也要先安装 Python 依赖库：redis。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">pip <span class="token function">install</span> redis
</code></pre>
</div><div class="cl-preview-section"><p>我们主要要实现三个功能：</p>
</div><div class="cl-preview-section"><ol>
<li>redis 连接</li>
<li>提供一个 route set 实现对 redis 中的值进行设置</li>
<li>提供一个 route get 实现对 redis 中的值进行查询</li>
</ol>
</div><div class="cl-preview-section"><h5 id="redis-连接">redis 连接</h5>
</div><div class="cl-preview-section"><p>redis 连接，我们直接使用 Python 的依赖库 Redis。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">import</span> redis

redis_client <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span>redis_host<span class="token punctuation">,</span> port<span class="token operator">=</span>redis_port<span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p>其中连接 Redis 需要使用三个参数：</p>
</div><div class="cl-preview-section"><ul>
<li>host: redis 的 host</li>
<li>port: redis 的端口</li>
<li>db：redis 中的数据库，我们使用 db = 0 即可。</li>
</ul>
</div><div class="cl-preview-section"><p>这里的一个核心问题是 redis 运行在另外一个 Docker 中，那我们在应用的 Docker 中如何连接 redis 实例呢？也就是如何发现redis 的 host 和 port 呢？</p>
</div><div class="cl-preview-section"><p>在 Docker 技术中我们可以在启动 Docker 的时候指定参数 --link 将两个 Docker 的网络进行打通。在下面部署的时候我们再细说。</p>
</div><div class="cl-preview-section"><h5 id="set-route">set route</h5>
</div><div class="cl-preview-section"><p>编写一个 route，可以对 redis 进行写入。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/set'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span>
    value <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span>
    redis_client<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'OK. We have set '</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">' to be '</span> <span class="token operator">+</span> value
</code></pre>
</div><div class="cl-preview-section"><p>其中 request.args 中可以获取到 url 中的参数。但是上面的代码没有做参数校验，key 和 value 可能是空，我们加一个参数校验的逻辑。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/set'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span>
    value <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'OOps, the key or value is NULL'</span>
    redis_client<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'OK. We have set '</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">' to be '</span> <span class="token operator">+</span> value
</code></pre>
</div><div class="cl-preview-section"><h5 id="get-route">get route</h5>
</div><div class="cl-preview-section"><p>编写一个 route 对 redis 中的值查询</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'OOps, the key is null'</span>
    value <span class="token operator">=</span> redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> value
</code></pre>
</div><div class="cl-preview-section"><p>至此，我们的 web 应用代码编写完成，完整的代码如下，其中 redis-host 现在还是一个占位符，我们部署的时候会把这个变量注入进来。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> redis

redis_client <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'redis-host'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/set'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
    value <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'OOps, the key or value is NULL'</span>
    redis_client<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'OK. We have set '</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">' to be '</span> <span class="token operator">+</span> value

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'OOps, the key is null'</span>
    value <span class="token operator">=</span> redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> value
</code></pre>
</div><div class="cl-preview-section"><h2 id="dockerfile">2. Dockerfile</h2>
</div><div class="cl-preview-section"><p>下面开始编写我们的 Dockerfile。回忆一下我们上面编写 web 应用过程中，主要安装了依赖 flask 和 redis 依赖。我们可以很简单写出来我们的 Dockerfile 如下，并命名为 Dockerfile。</p>
</div><div class="cl-preview-section"><pre class="  language-dockerfile"><code class="prism  language-dockerfile"><span class="token keyword">from</span> python<span class="token punctuation">:</span>3

<span class="token keyword">RUN</span> pip install flask
<span class="token keyword">RUN</span> pip install redis
<span class="token keyword">RUN</span> mkdir /data

<span class="token keyword">COPY</span> hello.py /data/
<span class="token keyword">WORKDIR</span> /data

<span class="token keyword">EXPOSE</span> 5000
<span class="token keyword">ENV</span> FLASK_APP=/data/hello.py
<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"flask"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p>我们对这个 Dockerfile 进行一个简单解释：</p>
</div><div class="cl-preview-section"><ul>
<li>from：表示基础镜像是 python:3；</li>
<li>RUN：表示在 docker build 的时候会执行后面的几个命令；</li>
<li>COPY：拷贝文件或者目录都可以；</li>
<li>WORKDIR：表示启动容器之后，当前的工作目录；</li>
<li>EXPOSE：表示容器要暴露 5000 端口；</li>
<li>ENV：环境变量；</li>
<li>ENTRYPOINT：表示 Docker 容器的启动进程。这里 entrypoint 中的 flask run 我们增加了参数 -h 0.0.0.0。如果不加这个参数的话，进程默认绑定到 127.0.0.1，外面是没有办法访问的。</li>
</ul>
</div><div class="cl-preview-section"><p>通过该 dockerfile 来构建镜像。基本每一个命令都会对应一个 step，如下。</p>
</div><div class="cl-preview-section"><pre class="  language-dockerfile"><code class="prism  language-dockerfile"><span class="token punctuation">[</span>root@docker web<span class="token punctuation">]</span><span class="token comment"># docker build -t web:v1 .</span>
Sending build context to Docker daemon  3.584kB
Step 1/8 <span class="token punctuation">:</span> from python<span class="token punctuation">:</span>3
 <span class="token punctuation">---</span><span class="token punctuation">&gt;</span> efdecc2e377a
Step 2/8 <span class="token punctuation">:</span> RUN pip install flask
 <span class="token punctuation">---</span><span class="token punctuation">&gt;</span> Running in c4dfe7b3e466
Collecting flask
  Downloading Flask<span class="token punctuation">-</span>1.1.1<span class="token punctuation">-</span>py2.py3<span class="token punctuation">-</span>none<span class="token punctuation">-</span>any.whl (94 kB)
Collecting itsdangerous<span class="token punctuation">&gt;</span>=0.24
  Downloading itsdangerous<span class="token punctuation">-</span>1.1.0<span class="token punctuation">-</span>py2.py3<span class="token punctuation">-</span>none<span class="token punctuation">-</span>any.whl (16 kB)
Collecting Jinja2<span class="token punctuation">&gt;</span>=2.10.1
  Downloading Jinja2<span class="token punctuation">-</span>2.11.1<span class="token punctuation">-</span>py2.py3<span class="token punctuation">-</span>none<span class="token punctuation">-</span>any.whl (126 kB)
Collecting Werkzeug<span class="token punctuation">&gt;</span>=0.15
  Downloading Werkzeug<span class="token punctuation">-</span>1.0.0<span class="token punctuation">-</span>py2.py3<span class="token punctuation">-</span>none<span class="token punctuation">-</span>any.whl (298 kB)
  <span class="token punctuation">...</span><span class="token punctuation">...</span>.
Step 8/8 <span class="token punctuation">:</span> ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"flask"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">]</span>
 <span class="token punctuation">---</span><span class="token punctuation">&gt;</span> Running in 25594e1de72f
Removing intermediate container 25594e1de72f
 <span class="token punctuation">---</span><span class="token punctuation">&gt;</span> d18b55e4d1fd
Successfully built d18b55e4d1fd
Successfully tagged web<span class="token punctuation">:</span>v1
</code></pre>
</div><div class="cl-preview-section"><p>构建成功之后，我们可以通过 <code>docker images</code> 查看到我们刚才 build 出来的镜像 web。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker demo<span class="token punctuation">]</span><span class="token comment"># docker images | grep web</span>
web                 v1                  02cc264143dc        6 minutes ago       943MB
</code></pre>
</div><div class="cl-preview-section"><h2 id="部署">3. 部署</h2>
</div><div class="cl-preview-section"><p>我们先来部署一个 Redis Docker，<code>-d</code> 参数表示以 daemon 的方式运行。<code>-p</code> 表示端口映射。<code>-name</code> 表示 Docker 容器的名字叫 redis-test。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">docker run --name redis-test -p 6379:6379 -d redis:latest
</code></pre>
</div><div class="cl-preview-section"><p>下面部署我们的 web 应用。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># docker run -p 5000:5000 --link redis-test:redis-host -d --name web web:v1</span>
64eef1f67c3934b6257510f47b587c59cee635188a4043b749966e71d2bc8c08
<span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
64eef1f67c39        web:v1              <span class="token string">"flask run -h 0.0.0.0"</span>   2 seconds ago       Up 1 second         0.0.0.0:5000-<span class="token operator">&gt;</span>5000/tcp   web
</code></pre>
</div><div class="cl-preview-section"><p>其中有一个运行参数需要进行简单说明，也就是 --link。link 后面跟一对映射的值，左侧的为已经存在的 Docker 容器，右侧的为该容器映射到我们启动的 Docker 应用中的 host 名字，这里也就是 web 这个 Docker 容器。我们下面通过 <code>docker exec</code> 进入到容器中看一下 link 是怎么做的。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># docker exec -ti 64eef1f67c39 /bin/bash</span>
root@64eef1f67c39:/data<span class="token comment">#</span>
</code></pre>
</div><div class="cl-preview-section"><p>我们查看一下 hosts 文件。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash">root@64eef1f67c39:/data<span class="token comment"># cat /etc/hosts</span>
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.17.0.5	redis-host 0d748e8ce766 redis-test
172.17.0.6	64eef1f67c39
</code></pre>
</div><div class="cl-preview-section"><p>我们可以看到 redis-host 已经被写到 hosts 中，所以我们在 web 这个 Docker 容器中就可以通过 redis-host 这个主机名访问到 Redis 容器了，这也是我们的应用代码的写法。</p>
</div><div class="cl-preview-section"><h2 id="验证">4. 验证</h2>
</div><div class="cl-preview-section"><p>部署完成，我们下面进行一个简单的验证。在宿主机上执行下面命令去设置一对 kv: &lt;imooc, <a href="http://imooc.com">imooc.com</a>&gt; 写入到 Redis 中。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># curl "localhost:5000/set?key=imooc&amp;value=imooc.com"</span>
OK. We have <span class="token keyword">set</span> imooc to be imooc.com
</code></pre>
</div><div class="cl-preview-section"><p>第二个请求去读取该值，如下。</p>
</div><div class="cl-preview-section"><pre class="  language-bash"><code class="prism  language-bash"><span class="token punctuation">[</span>root@docker ~<span class="token punctuation">]</span><span class="token comment"># curl "localhost:5000/get?key=imooc"</span>
imooc.com
</code></pre>
</div><div class="cl-preview-section"><h2 id="总结">5. 总结</h2>
</div><div class="cl-preview-section"><p>至此，我们第一个动手实践的 Docker 应用已经完成。本来想弄一个更复杂的应用，但是限于篇幅，只能做了一下取舍。虽然简单，还是建议各位同学进行动手实践。毕竟纸上得来终觉浅，绝知此事要躬行。</p>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img1.mukewang.com/5f16ceea00011d7f06700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<ul class="comment-content">
				
				<li class="item">
					<a href="/read/commentdetail/6708">
						<img src="https://img1.mukewang.com/56933f5d0001aa2001000100-100-100.jpg" alt="" class="avatar">
						<h4 class="nickname">qq87231880</h4>
						<div class="comment-text">终于成功了！
curl "localhost:5000/set?key=test&amp;value=test.com"
OK. We have set test to be test.com[root@VM-0-13-centos web]#

[root@VM-0-13-centos web]# curl "localhost:5000/get?key=test"
test.com[root@VM-0-13-centos web]#

部署redis容器时候发现一个问题：
docker 如果出现此错误：
Error response from daemon: Conflict. The container name "/redis-test" is already in use by container a666           e30ccb0dda354f116fe320855070b75e2942eff4502bc88289fbd27afc7c. You have to remove (or rename) that container to be able to reuse that name..
那么可以通过 docker ps -a | grep redis  把已经存在的容器id找出来，然后 
docker rm 容器ID
这样就可以部署redis容器：  docker run --name redis-test -p 6379:6379 -d redis:latest</div>
						<div>
							
						</div>
					</a>
					<p class="bottom">
						<span class="l">2020-09-02</span>
						<a href="/read/commentdetail/6708">
							<span class="icon r"><i class="imwap-comment"></i><em>0</em></span>
						</a>
						<span data-cid="6708" class="icon r js-comment-upvote "><i class="imwap-thumb_up"></i><em>1</em></span>
					</p>
				</li>
				
			</ul>
			
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥68.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=84">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '11 动手实践：从 0 到 1 构建自己的 Docker 应用',
					'CID': '2243',
					'Teacher': 'legendtkl'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "11 动手实践：从 0 到 1 构建自己的 Docker 应用",
                    desc: "系统学懂学透容器技术，实战无忧",
                    imgUrl: 'https:https://img3.mukewang.com/5f18f1b00001f3f605400720.jpg',
                    otherImgUrl: 'https://img3.mukewang.com/5f18f1b00001f3f605400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/84',
                    link: 'https://m.imooc.com/read/84'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
