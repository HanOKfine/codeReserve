<!doctype html>
<html lang="zh_CN">

    

    

    
    
    
    <head>
        
        <title>03 素昧平生：初识网络协议大家族</title>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="学好通用知识，提升技术竞争力">
        <meta name="keywords" content="慕课网">
        <meta name="author" content="">
        <meta name = "format-detection" content="telephone=no">
        <meta http-equiv="Cache-Control" content="no-transform " />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="shortcut icon" href="https://m.imooc.com/static/wap/static/favicon.ico" />
        
        
        
        <script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/flexible.js"></script>
        
        <script type="text/javascript">
            var userInfo = "";
            
                var isApp = 0;
            
        </script>
         
<!-- 专栏首页列表模板 -->
<script type="text/template" id="index-list-tpl">
<ul class="list-con">
    {@each data.data as item}
        <li>
            <a href="/read/${item.id}" class="item clearfix">
                <div class="img l" style="background-image: url(${item.app_pic1})">
                    {@if item.is_new }
                        <div class="icon new">
                            上新
                        </div>
                    {@else if item.is_marking} 
                        <div class="icon">
                            经典
                        </div>
                    {@/if} 
                </div>
                <div class="text-con l">
                    <div class="title">
                        ${item.title}
                    </div>
                    <div class="desc">
                        ${item.chapter_num}节 · ${item.description}
                    </div>
                     <div class="user-info">
                        ${item.nickname}
                        {@if item.author_title }
                        <span class="dot">
                            ·
                        </span>
                        ${item.author_title}
                        {@/if}
                    </div>
                    <div class="info clearfix">
                    {@if !item.isBuy } 
                        <!-- 未购买才显示 -->
                        <div class="price-con l">
                        {@if item.open_discount == "1" }
                            <span class="now">￥${item.pay_price}</span>
                            <span class="ori">￥${item.price}</span>
                            <p class="sale">${item.discount_name}</p>
                        {@else}
                            <span class="now">￥${item.price}</span>
                        {@/if}
                        </div>
                    {@/if}
                        <div class="taste-con r">
                            <span>${item.numbers}人订阅</span>
                            {@if !item.isBuy }
                                <span class="gotaste">试读</span>
                            {@else}
                                <span class="gotaste">学习</span>
                            {@/if}
                        </div>
                    </div>
                </div>
            </a>
        </li>
    {@/each}
</ul>
</script>



<!-- 专栏目录 买后目录页、 -->
<script type="text/template" id="detail-catalog-tpl">
<ul class="catalog-list">
{@each data.list as item}
    <li class="zhang">
        {@if data.structure_mode == "1" }
            <!--章节模式-->
            <div class="zhang-title">
                ${item.title}（${item.count}节）
            </div>
            <div class="zhang-sub-title">
                ${item.short_introduce}
            </div>
        {@/if}  
        <ul class="zhang-detail">
            {@each item.list as it,i}
                <li class="jie">
                    {@if data.isLogin }
                        <!-- 购买了  -->
                        {@if data.isBuy }
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read">
                        {@else}
                        <a href="javascript:;" data-link="/read/${data.column_id}/article/${it.id}" class="js-go-read" >
                        {@/if}
                    {@else}
                        <!-- 未登录  -->
                        {@if data.isApp }
                            <a href="javascript:;" onclick="window.nativeSupport.login();">
                        {@else}
                            <a href="//m.imooc.com/account/login?backurl=/read/${data.column_id}">
                        {@/if}
                    {@/if}
                        <div class="jie-con {@if data.last_chapter == it.id }recent{@/if}">
                            
                            <div class="text-con">
                                <div class="jie-title">
                                    ${it.title}
                                </div>
                                <div class="jie-status">
                                    {@if it.is_open == "0" }
                                        <span class="update-time" >${it.open_time_fmt}</span>
                                    {@/if}
                                    {@if it.view_num > 100 }
                                    <div class="learn-num">
                                        <i class="imwap-set-sns"></i>
                                        <span>${it.view_num}</span>
                                    </div>
                                    {@/if}
                                    {@if it.in_24hours == "1" }
                                        <span class="update-recent">最近更新</span>
                                    {@/if}
                                </div>
                            </div>
                        </div>
                        {@if it.is_learned }
                            <div class="jie-right haslearn is_learned js-learn" data-type="1">
                                已学
                            </div>
                        {@else}
                            <!-- 购买了  -->
                            {@if data.isBuy }
                                <div class="jie-right learn js-learn" data-type="1">
                                    学习
                                </div>
                            {@else}
                                {@if it.is_pay == "0" }
                                <!--免费小节 不占用试读次数  -->
                                    <div class="jie-right learn js-learn" data-type="1">
                                        免费
                                    </div>
                                {@else}
                                    <div class="jie-right learn js-learn" data-type="0">
                                        学习
                                    </div>
                                {@/if}
                            {@/if}
                            
                            
                        {@/if}
                    </a>
                </li>
            {@/each}
        </ul>
    </li>
{@/each}
</ul>
</script> 

<!-- 阅读页 阅读页   专栏目录  -->
<script type="text/template" id="catalog-tpl">
<div>
    <h2 class="article-title">${data.a_name}</h2>
    <ul class="catalog">
    {@each data.list as item}
        <li class="zhang">
            {@if data.structure_mode == "1" }
                <!--章节模式-->
                <div class="zhang-title">
                    ${item.title}
                    <!-- <div class="num">共${item.count}节</div> -->
                </div>
            {@/if}  
            <ul class="zhang-detail">
                {@each item.list as it,i}
                    <li class="jie">
                        <!--买了且开放的-->
                        <a href="/read/${data.column_id}/article/${it.id}">
                            <div class="jie-title clearfix full">
                                <p>
                                    {@if data.last_chapter == it.id }
                                        <span class="recent">最近阅读</span>
                                    {@/if}
                                    ${it.title}
                                </p>
                            </div>
                        </a>
                    </li>
                {@/each}
            </ul>
        </li>
    {@/each}
    </ul>
</div>
</script>





<script type="text/javascript">
	var isApp = "";
	var clientVersion = "0";
	var count_num = "0";
	var chapter_id = "2092";
	var chapter_title = "03 素昧平生：初识网络协议大家族";
	var aid = "80";
	var a_name = "零基础学透网络编程";
	var a_price = "58.00";
	var a_pic = "https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg";
	var userId = 0;

	var column_id = '80';
	var isLogin = 0;
	

</script>
<!-- 引入字体 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
$youziku.load(".top-con .title, .cl-preview-section h1,.cl-preview-section h2,.cl-preview-section h3,.cl-preview-section h4,.cl-preview-section h5,.cl-preview-section h6", "37af461390fa4d138f5c3d277f7286dc", "SourceHanSerifSC-Heavy"); // 思源宋体heavy
$youziku.load(".lead-motto, .cl-preview-section blockquote", "d9a0d855583142c3b2cc3bf1646a8473", "SourceHanSerifSC-Regular"); // 思源宋体regular
$youziku.load("#article_content, .cl-preview-section pre, .cl-preview-section code, #code-copy", "3d84aabcf9e44b6f8c6fa91c61fa926e", "HYQiHei-55S"); // 汉仪旗黑55s
$youziku.load(".cl-preview-section strong", "fd94fff3a17546a28913a79613bddcec", "HYQiHei-77S"); // 汉仪旗黑70s

$youziku.draw();
</script>

<style type="text/css">
  header{
    display: none!important;
  }
  
  #wrapper{
  	padding-top:0px !important;
  }
  
</style>



    <link rel="stylesheet" href="https://m.imooc.com/static/wap/static/common/css/common_d42b1ef.css" /><link rel="stylesheet" href="https://m.imooc.com/static/wap/static/css/read/7.2.8/article_2d28313.css" /></head>
    <body >
        
          
        

        
          
        

        
          







<header class="directory2">
	<div class="header clearfix">
		
			
				<div class="page-title clearfix">
					<a href="//m.imooc.com" class="imwap-icon-imooc"></a>
					<div class="page-title-name js-page-name">
						<span>专栏</span>
						<i class="imwap-arrow_d"></i>
					</div>
				</div>
			

			
			<div class="drawer-box js-drawer-more">
				<i class="imwap-more_vert"></i>
				<div class="drawer-content js-drawer-content">
					<p class="line-row"></p>
					<a class="drawer-item" href="//m.imooc.com"><i class="imwap-center"></i>回到首页</a>
					<a class="drawer-item" href="//www.imooc.com/m/web/user/usercenter.html"><i class="imwap-peaple"></i>个人中心</a>
					<a class="drawer-item" href="//m.imooc.com/feedback"><i class="imwap-comment"></i>反馈问题</a>
					
					<a class="drawer-item" href="//m.imooc.com/account/login"><i class="imwap-out"></i>注册登录</a>
					
				</div>
			</div>
			

			
				<a id="js-appload" href="Javascript:;" class="app-load"><span>下载APP</span></a>
			

		
	</div>
	
	<div class="page-tab-wrap">
		<div class="page-tab-list">
			<a href="//m.imooc.com" class="page-tab-item">首页</a>
			<a href="//m.imooc.com/course/list" class="page-tab-item">课程</a>
			<a href="//coding.m.imooc.com" class="page-tab-item">实战</a>
			<a href="//class.m.imooc.com" class="page-tab-item">金职位</a>
			<a href="//m.imooc.com/article" class="page-tab-item">手记</a>
			<a href="//m.imooc.com/read" class="page-tab-item active">专栏</a>
			<a href="//m.imooc.com/wenda" class="page-tab-item">猿问</a>
			<a href="//m.imooc.com/wiki" class="page-tab-item">慕课教程</a>
			
		</div>
	</div>
	
</header>


        

        <div id="wrapper">
            <div id="middle" class="container ">

                

                
	
		
	
	<div class="top-con">
		<p class="update-time"><span>2020-06-09&nbsp;&nbsp;&nbsp;更新</span></p>
		<div class="title">
			03 素昧平生：初识网络协议大家族
		</div>
	</div>
	
		<div class="article-img" style="background-image: url('https://img2.mukewang.com/5ed9fbdb0001b1ff06400359.jpg')"></div>
	
	
		<a href="/read/80">
			<div class="course-entry">
				<img src="https://img2.mukewang.com/5458620000018a2602200220-40-40.jpg" alt="陈子兴">
				<h3>零基础学透网络编程</h3>
				<p>陈子兴 · 资深软件架构师</p>
				<i class="imwap-arrow_r"></i>
			</div>
		</a>
	
	
		<div class="lead-motto">
			<div class="content">能够生存下来的物种,并不是那些最强壮的,也不是那些最聪明的,而是那些对变化作出快速反应的。<p class="author">——达尔文</p></div>
		</div>
	
	
		<div class="content" id="article_content">
			
			<div class="cl-preview-section"><h2 id="前言">前言</h2>
</div><div class="cl-preview-section"><p>在《追本溯源：探寻协议栈的发展历程》一文中，我们介绍网络协议栈的分层模型，也介绍了 BSD Socket 的发展历史，我想你一定迫切地想了解 Socket API 是如何应用的吧。不过我们先不要急，因为我们的目标是以 Socket 编程为基础，穿插介绍所有和 Socket 编程相关的网络技术原理、实现细节、网络工具、以及相关历史知识。</p>
</div><div class="cl-preview-section"><p>为此，我们首先要了解一下有关 TCP/IP 标准的知识，提升我们的职业范儿、专业范儿和技术范儿是非常有必要的。在讨论协议 TCP/IP 协议标准时，大家经常把 TCP/IP 协议叫做 Internet 协议，所以碰到这两个不同的表述，要明白他们指的是相同的意思。</p>
</div><div class="cl-preview-section"><h2 id="tcpip-标准化">TCP/IP 标准化</h2>
</div><div class="cl-preview-section"><p>TCP/IP 标准都是以 RFC(Request for Comments)文档出版。RFC 格式诞生于 1969年，是 ARPANET 项目的开创性成果。如今 RFC 已经是 TCP/IP 标准的官方发行渠道。请看下图来了解 RFC 的主要来源机构。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed8a4340001a66b05810329.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><ul>
<li>
<p>互联网工程任务组（<strong>IETF</strong>, Internet Engineering Task Force）是一个开放标准组织，主要工作是开发和推广自愿的 Internet 标准，专注于工程和标准制定的短期问题研究；</p>
</li>
<li>
<p>互联网研究任务组（<strong>IRTF</strong>, Internet Research Task Force) 是一个专注于和 Internet 相关的、长期问题的研究；</p>
</li>
<li>
<p>互联网体系结构委员会（<strong>IAB</strong>，Internet Architecture Board）是 IETF 的委员会，也是 [ISOC][4] 的咨询机构。其职责是对 IETF 活动进行监督；</p>
</li>
<li>
<p>互联网协会（<strong>ISOC</strong>，Internet Society）是成立于 1992 年的美国非营利性组织，领导着互联网标准的推广、教育、政策方面工作。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>RFC 主要是由工程师和计算机科学家以备忘录的形式撰写的。很多 RFC 是实验性的，并不是标准，IETF 会吸收一些 RFC 建议作为标准发布。RFC 标准都是以 “RFC xxx” 的形式发布的，xxx 是编号，比如 RFC 1122。RFC 经过几十年的发展，到写作此文为止，最新编号是 <strong>RFC 8672</strong>。关于 RFC 的索引库，可以参考 <a href="https://www.rfc-editor.org/rfc-index2.html" title="rfc_index">rfc index</a>。我们后续要讲的所有 TCP/IP 协议都可以在此索引库找到。如果你在今后的��习过程中，需要参考标准文献，就来此索引库查找。</p>
</div><div class="cl-preview-section"><p>Internet 的标准化我们了解了，那么 TCP/IP 协议族只是包含 TCP 和 IP 两个协议吗？</p>
</div><div class="cl-preview-section"><h2 id="tcpip-协议族">TCP/IP 协议族</h2>
</div><div class="cl-preview-section"><p>TCP/IP 参考模型尽管只用了其中两个协议来命名，但是整个协议族包含了很多协议。从 RFC 索引库可以看到，最新的 Internet 协议编号是 8672。本文只会讲解最基础、最核心的协议。对于一些行业相关的协议，以后工作需要的时候再去学习也不晚。比如，如果你做音视频传输才会用到 RTP 协议；如果你做电信设备管理才会用到 SNMP 协议。现在我们先看一张大图吧。</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed8a4460001ba6609740613.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p>依据 TCP/IP 参考模型，我们把协议栈从上到下分为 4 层，每一层都有相应的协议。</p>
</div><div class="cl-preview-section"><p><strong>1. 应用层包含很多知名协议，也可以是用户自定义协议：</strong></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong><i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-5">HTTP</i></strong>（Hypertext Transfer Protocol）超文本传输协议，只要你浏览页面就会用到此协议；</p>
</li>
<li>
<p><strong>SMTP</strong>（Simple Mail Transfer Protocol）简单邮件传输协议，用于电子邮件传输；</p>
</li>
<li>
<p><strong>FTP</strong> （File Transfer Protocol）文件传输协议，用于文件的上传和下载。现在 FTP 貌似用的不多了，早期主要是在公司内部、大学等研究机构用的比较多；</p>
</li>
<li>
<p><strong>RTMP</strong>（Real-Time Messaging Protocol）实时消息协议，用于实时流媒体传输，主要用在音视频直播领域，属于 Adobe 公司出品。不过，从 2020 年开始，Adobe 就不再支持 RTMP 协议了；</p>
</li>
<li>
<p><strong>SNMP</strong>（Simple Network Management Protocol）简单网络管理协议，用于电信网络设备的管理。比如，监控设备告警，对设备进行业务配置等。主要是在思科、华为等电信网络设备上用的比较多；</p>
</li>
<li>
<p><strong>RTP</strong>（Real-time Transport Protocol）实时传输协议，主要是用在音视频传输。比如，视频会议，voip 通信等。另外 WebRTC 也是用 RTP 进行音视频传输的；</p>
</li>
<li>
<p><strong>WebRTC</strong> 算是一个实时通信组件，是由 Google 开放的用于浏览器之间的实时通信。WebRTC 除了支持音频、视频传输外，还可以进行数据通信，比如共享屏幕。所以 WebRTC 的数据通道用到了 SCTP 协议。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>由于应用层协议和具体行业相关，本专栏不会做过多的解释，本节提到的每个协议我们都提供了 wiki 连接，你要是感兴趣可以参考相关资料继续学习。</p>
</div><div class="cl-preview-section"><p><strong>2. 传输层</strong></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>TCP</strong>（Transmission Control Protocol）传输控制协议，是面向连接的、可靠的、面向字节流的传输协议。TCP 应用非常广泛，是端到端传输的基石，我们会详细介绍其工作原理；</p>
</li>
<li>
<p><strong>UDP</strong>（User Datagram Protocol）用户数据报协议，是无连接的、不可靠的、面向消息的传输协议。UDP 实时性好，效率高，在音视频传输中有着广泛的应用；</p>
</li>
<li>
<p><strong>SCTP</strong>（Stream Control Transmission Protocol）流式控制传输协议，和 TCP 相似的是面向连接的；和 TCP 不同的是面向消息的。SCTP 的连接叫做 Association，可以关联多个网络接口的 IP 地址；</p>
</li>
</ul>
</div><div class="cl-preview-section"><p><strong>3. 网络层</strong></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>IPv4</strong> （Internet Protocol version 4）此协议主要是用于 IP 分组的路由转发，是路由器主要实现的协议。我们经常说的 IP 地址是指 IPv4 地址，用 32 bit 来表示；</p>
</li>
<li>
<p><strong>IPv6</strong> （Internet Protocol version 6）此协议工作原理类似 IPv4。之所以设计 IPv6 的目的是因为上世纪 90 年代中期，因特网爆炸式的增长，32 位 IPv4 地址不够用了，为此才设计了 128 位的 IPv6 地址；</p>
</li>
<li>
<p><strong>ICMP</strong>（Internet Control Message Protocol）因特网控制消息协议，主要是用于显示网络错误。比如，我们用 ping 的时候，有时会显示“网络不可达”的错误；</p>
</li>
<li>
<p><strong>ICMPv6</strong> （Internet Control Message Protocol Version 6）整合了 ICMP 协议，针对 IPv6 开发的协议；</p>
</li>
<li>
<p><strong>IGMP</strong>（Internet Group Management Protocol）因特网组管理协议，主要是用于 IP Multicast 的场景，比如观看 IP 电视节目。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p><strong>4. 链路层</strong></p>
</div><div class="cl-preview-section"><ul>
<li>
<p><strong>ARP</strong>（Address Resolution Protocol）地址解析协议，主要是用于生成 IP 地址和物理地址（比如以太网 MAC 地址）的映射表，用于数据包的快速转发；</p>
</li>
<li>
<p><strong>RARP</strong>（Reverse Address Resolution Protocol）反向地址解析协议，主要是用于生成物理地址和 IP 地址的映射。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>对于传输层、网络层、链路层的协议，我们在后续的专栏中会详细分析。我相信你已经对 TCP/IP 标准化、协议栈包含的协议，有了宏观的认识了吧，现在是时候学习一下 TCP/IP 协议栈是如何工作的了。</p>
</div><div class="cl-preview-section"><h2 id="nwchecker-clientserver-设计">nwchecker Client/Server 设计</h2>
</div><div class="cl-preview-section"><p>本节我们就尝试编写一个简单的 TCP/IP 应用程序，基本功能就是实现一个 TCP Client 程序和一个 TCP Server 程序，我们把他们分别叫做 nwchecker Client 和 nwchecker Server，nwchecker 是 Network checker 的缩写，表示网络检测器。nwchecker Client 每隔 3 秒向 nwchecker Server 发送 ping 消息请求， nwchecker Server 收到 nwchecker Client 的 ping 请求后发送一个 pong 响应，如此循环执行下去。</p>
</div><div class="cl-preview-section"><p>按照软件工程的开发流程，我们应该遵循 <strong>需求分析</strong>-&gt;<strong>架构设计</strong>-&gt;<strong>编码</strong>-&gt;<strong>测试</strong>-&gt;<strong>交付</strong> 的过程。因为 nwchecker 的功能非常明确，不需要过多分析，我们只需要做一下架构设计和编码，最后做一个简单的测试即可。</p>
</div><div class="cl-preview-section"><p>nwchecker 的架构图如下：</p>
</div><div class="cl-preview-section"><p><img src="https://img.mukewang.com/5ed8a4670001c81206440635.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><blockquote>
<p>提示：在面试中，面试官可能会问“如果要创建一个 TCP Client/Server 程序，请描述 Socket API 的调用流程？”。如果你能画出这张图，就可以很好的回答此问题。</p>
</blockquote>
</div><div class="cl-preview-section"><p>你仔细分析一下这张图，是不是发现 Client 是主动发起方，而 Server 是被动监听方？像不像恋爱前期的男士和女士呢？男士是主动一方，女士是被动一方。当然你要是男神的话，那就另当别论啦。</p>
</div><div class="cl-preview-section"><p>nwchecker Server 是怎么被动接收的呢？</p>
</div><div class="cl-preview-section"><ol>
<li>首先调用 socket() 函数创建一个 Socket，返回值是一个文件描述符（FD，File Description）；</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p>提示：在 Windows 系统，socket() 返回的文件描述符，也叫句柄。在 Unix-like 系统，系统 I/O 资源都抽象成了文件描述符(FD)；在 Windows 系统，系统资源都抽象成句柄(Handle)，但是二者所表达的含义是一致的。</p>
</blockquote>
</div><div class="cl-preview-section"><ol start="2">
<li>
<p>调用 bind() 函数绑定一个服务端口，也可以绑定指定的网络接口（就是网卡）。关于端口和网络接口，后面专栏会详细介绍；</p>
</li>
<li>
<p>调用 listen() 函数开始侦听。侦听就是在那里被动等待客户端的连接；</p>
</li>
<li>
<p>调用 accept() 函数接收客户端的连接请求。accept() 函数返回的是一个新连接的文件描述符（FD，File Description）；</p>
</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p>注意！！！在阻塞式 Socket 模式下，调用 accept 会阻塞执行线程。如果在非阻塞式 Socket 模式下，程序员需要向事件反应器（比如 select）注册 ACCEPT 事件。当客户端的连接建立成功后，反应器（如 select）会通知 ACCEPT 事件，此时调用 accept() 函数，会立即返回，并不会阻塞执行线程。关于阻塞式 Socket 编程，我们在后面专栏会详细讲解。</p>
</blockquote>
</div><div class="cl-preview-section"><ol start="5">
<li>新连接建立成功以后，Server 首先调用 recv() 函数接收数据，然后才是调用 send() 函数发送响应；</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p>提示：服务器都是被动监听的，对于服务器来说首先是调用 recv() 去接收数据，很少有服务器主动给人发数据。女神不能太主动吧！</p>
</blockquote>
</div><div class="cl-preview-section"><ol start="6">
<li>当连接断开后，需要调用 close() 函数释放资源。</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p>注意！！！调用 socket() 函数创建的文件描述符，必须调用 close() 函数释放，否则会造成文件描述符泄漏，随着服务的长期运行，最终会导致文件描述符耗尽、系统无法再继续工作。</p>
</blockquote>
</div><div class="cl-preview-section"><p>分析完 nwchecker Server 的执行流程，再分析 nwchecker Client 的执行流程就会容易很多，只要把 Server 中被动的函数调用换成主动的函数调用即可。</p>
</div><div class="cl-preview-section"><ol>
<li>
<p>首先是调用 socket() 函数创建一个 Socket，返回值是一个文件描述符（FD，File Description）；</p>
</li>
<li>
<p>相比 Server 的执行流程，Client 并不需要调用 bind() 函数和 listen() 函数，而是调用了 connect() 函数。connect() 函数的主要逻辑就是完成 <strong>TCP 三次握手</strong>；</p>
</li>
<li>
<p>Client 主动调用 send() 函数发送消息，然后调用 recv() 函数等待服务器的响应；</p>
</li>
<li>
<p>对于 Client 来说，如果任务完成了就应该调用 close() 函数关闭连接，释放资源。</p>
</li>
</ol>
</div><div class="cl-preview-section"><p>完成了架构的分析设计后，我们该完成编码实现了。</p>
</div><div class="cl-preview-section"><h2 id="nwchecker-clientserver-实现">nwchecker Client/Server 实现</h2>
</div><div class="cl-preview-section"><p>关于本专栏的所有演示代码都托管在 github ：<a href="https://github.com/haska1025/imooc-sock-core-tech">https://github.com/haska1025/imooc-sock-core-tech</a></p>
</div><div class="cl-preview-section"><p>项目名称是 imooc-sock-core-tech。项目代码是按照专栏名称组织的，所以很容易分辨。从 github 获取代码非常容易，执行如下命令即可。</p>
</div><div class="cl-preview-section"><pre><code>git clone https://github.com/haska1025/imooc-sock-core-tech.git
</code></pre>
</div><div class="cl-preview-section"><p>nwchecker Client 完整代码在 imooc-sock-core-tech/02-02_初识网络协议大家族/nwchecker_client.c 文件中，为了方便讲解，我们仅粘贴部分代码片段。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">29</span>     sock_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">30</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>sock_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">31</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Create socket failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">32</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">33</span>     <span class="token punctuation">}</span>
 <span class="token number">34</span>
 <span class="token number">35</span>     <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">36</span>
 <span class="token number">37</span>     serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
 <span class="token number">38</span>     serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">39</span>     serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">40</span>
 <span class="token number">41</span>     rc <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">42</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">43</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Connect server failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">44</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">45</span>     <span class="token punctuation">}</span>
 <span class="token number">46</span>
 <span class="token number">47</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">48</span>         rc <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> ping<span class="token punctuation">,</span> ping_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">49</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">50</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Send ping request failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">51</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">52</span>         <span class="token punctuation">}</span>

 <span class="token number">56</span>         rc <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> recv_buffer<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">57</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">58</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The connection is closed by peer!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">59</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">60</span>         <span class="token punctuation">}</span>
 <span class="token number">61</span>
 <span class="token number">62</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">63</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Receive message failed!errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">64</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">65</span>         <span class="token punctuation">}</span>

 <span class="token number">69</span>         <span class="token comment">// Sleep 3 seconds</span>
 <span class="token number">70</span>         <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">71</span>     <span class="token punctuation">}</span>
 <span class="token number">72</span>
 <span class="token number">73</span>     <span class="token function">close</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li>
<p>所有 Socket API 都是返回 -1 表示函数调用出错，错误码是通过 errno 来体现；</p>
</li>
<li>
<p>29 ~ 33 行是调用 socket() 函数创建 Socket 文件描述符；</p>
</li>
<li>
<p>35 ~ 39 行是构造 server 的 struct sockaddr_in 地址结构。为了更加灵活，我们通过命令行参数传入 IP 地址和端口号，用 argv[1] 表示 IP 地址，用 argv[2] 表示端口号。IP 地址和端口号需要转换成网络字节序；</p>
</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>注意：什么是<strong>网络字节序</strong>呢？难道还有其它字节序吗？</p>
</blockquote>
</div><div class="cl-preview-section"><ul>
<li>
<p>41 ~ 45 行是调用 connect() 函数主动连接服务器；</p>
</li>
<li>
<p>48 ~ 52 行是调用 send() 函数发送“ping”消息；</p>
</li>
<li>
<p>56 ~ 65 行是接收数据逻辑。对于 recv() 函数，返回值 -1 表示出错，返回值 0 表示“连接被对方关闭”；</p>
</li>
<li>
<p>70 行是通过 sleep() 函数实现间隔调用；</p>
</li>
<li>
<p>73 行是通过 close() 函数关闭 Socket。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p>这个逻辑非常重要，一定要牢记！！！</p>
</div><div class="cl-preview-section"><p>nwchecker Server 代码在 imooc-sock-core-tech/02-02_初识网络协议大家族/nwchecker_server.c 文件中。</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"> <span class="token number">31</span>     sock_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">32</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>sock_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">33</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Create socket failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">34</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">35</span>     <span class="token punctuation">}</span>
 <span class="token number">36</span>
 <span class="token number">37</span>     <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">38</span>
 <span class="token number">39</span>     server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
 <span class="token number">40</span>     server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">41</span>     server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
 <span class="token number">42</span>
 <span class="token number">43</span>     rc <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">44</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">45</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Bind server failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">46</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">47</span>     <span class="token punctuation">}</span>
 <span class="token number">48</span>
 <span class="token number">49</span>     rc <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">50</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">51</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Server listen failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">52</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">53</span>     <span class="token punctuation">}</span>
 <span class="token number">54</span>
 <span class="token number">55</span>     client_sock_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">56</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>client_sock_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">57</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Accept connection from client failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">58</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token number">59</span>     <span class="token punctuation">}</span>
 <span class="token number">60</span>
 <span class="token number">61</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">62</span>         rc <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>client_sock_fd<span class="token punctuation">,</span> recv_buffer<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">63</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">64</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The connection is closed by peer!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">65</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">66</span>         <span class="token punctuation">}</span>
 <span class="token number">67</span>
 <span class="token number">68</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">69</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Receive message failed!errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">70</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">71</span>         <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">75</span>         rc <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>client_sock_fd<span class="token punctuation">,</span> pong<span class="token punctuation">,</span> pong_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">76</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token number">77</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Send ping reponse failed! errno(%d)\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">78</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token number">79</span>         <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">83</span>     <span class="token punctuation">}</span>
 <span class="token number">84</span>
 <span class="token number">85</span>     <span class="token function">close</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">86</span>     <span class="token function">close</span><span class="token punctuation">(</span>client_sock_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li>
<p>31 ~ 35 行是调用 socket() 函数创建 Socket 文件描述符；</p>
</li>
<li>
<p>37 ~ 41 行是构造服务器监听的 struct sockaddr_in 地址结构。为了更加灵活，我们用命令行参数 argv[1] 传入服务器监听的端口号。服务器监听的 IP 地址是 “0.0.0.0”；</p>
</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提醒：服务器监听“0.0.0.0”？确定没有搞错吗？</p>
</blockquote>
</div><div class="cl-preview-section"><ul>
<li>
<p>43 ~ 47 行是调用 bind() 函数绑定监听的端口号和 IP 地址；</p>
</li>
<li>
<p>49 ~ 53 行是调用 listen() 函数启动监听；</p>
</li>
<li>
<p>55 ~ 59 行是调用 accept() 函数接收新连接请求。如果函数调用成功会返回新连接的文件描述符；</p>
</li>
<li>
<p>剩下逻辑类似 Client 实现，不再赘述。</p>
</li>
</ul>
</div><div class="cl-preview-section"><blockquote>
<p>提示：</p>
<ul>
<li>struct sockaddr_in 需要通过 bzero 或者 memset 进行初始化，否则可能会出现连接失败的问题。</li>
<li>把 IP 和 Port 转换成网络字节序是非常重要的，否则会导致连接失败。</li>
<li>关于程序包含的头文件、API 的返回值、Socket 地址结构等内容，我们在以后的专栏会逐一详解。本节只是对 nwchecker_client 做一个简单的说明。</li>
</ul>
</blockquote>
</div><div class="cl-preview-section"><h2 id="nwchecker-clientserver-部署和测试">nwchecker Client/Server 部署和测试</h2>
</div><div class="cl-preview-section"><p>现在我们通过 gcc 编译 client 和 server 代码，最终会生成 nwc_client 和 nwc_server 两个可执行程序，命令如下：</p>
</div><div class="cl-preview-section"><pre><code>gcc -o nwc_client nwchecker_client.c
gcc -o nwc_server nwchecker_server.c
</code></pre>
</div><div class="cl-preview-section"><p>我们在 ubuntu 18.04 上做一个测试，Client 和 Server 都在同一台机器部署，服务器监听的是 9820 端口。<br>
分别打开两个 shell 窗口，启动客户端和服务器。</p>
</div><div class="cl-preview-section"><p>nwc_server 执行结果：</p>
</div><div class="cl-preview-section"><pre><code>ubuntu@ip-172-31-3-221:~/imooc-sock-core-tech/02-02_初识网络协议大家族$ sudo ./nwc_server 9820
1573306656 Recv ping from the client
1573306656 Send pong to client !
1573306659 Recv ping from the client
1573306659 Send pong to client !
1573306662 Recv ping from the client
1573306662 Send pong to client !
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p>提示：服务器程序需要监听端口，有时需要绑定网络接口，一般建议通过 sudo 权限启动服务。</p>
</blockquote>
</div><div class="cl-preview-section"><p>nwc_client 执行结果：</p>
</div><div class="cl-preview-section"><pre><code>ubuntu@ip-172-31-3-221:~/imooc-sock-core-tech/02-02_初识网络协议大家族$ ./nwc_client 127.0.0.1 9820
1573306656 Send ping to server!
1573306656 Recv pong from the server
1573306659 Send ping to server!
1573306659 Recv pong from the server
1573306662 Send ping to server!
1573306662 Recv pong from the server
</code></pre>
</div><div class="cl-preview-section"><p>执行结果中最前面的数字是时间，单位是秒。我们可以发现 nwc_client 每隔 3 秒向 nwc_server 发送一个 “ping”，nwc_server 收到此消息后立即回应一个 “pong”。</p>
</div><div class="cl-preview-section"><p>此程序可以作为一个简单的检查网络连通性的小程序。</p>
</div><div class="cl-preview-section"><p>我们如何检查 nwc_server 是否启动成功呢？</p>
</div><div class="cl-preview-section"><h2 id="重要的工具-netstat">重要的工具 netstat</h2>
</div><div class="cl-preview-section"><p>netstat 是做服务器开发必须要掌握的一个工具。比如，我们要想查看 nwc_server 是否启动成功，可以输入如下命令：</p>
</div><div class="cl-preview-section"><pre><code>ubuntu@ip-172-31-3-221:~$ sudo netstat -anp
tcp        0      0 0.0.0.0:9820            0.0.0.0:*               LISTEN      20469/./nwc_server
</code></pre>
</div><div class="cl-preview-section"><p>根据查询结果，我们可以确认 nwc_server 的进程 ID(pid) 是 20469，成功监听了 9820 端口。</p>
</div><div class="cl-preview-section"><p>至于 netstat 的其他用法，我们以后会继续讲解。</p>
</div><div class="cl-preview-section"><h2 id="总结">总结</h2>
</div><div class="cl-preview-section"><p>本文我们首先介绍了 TCP/IP 协议的标准化，我们知道 TCP/IP 协议标准是通过 RFC 来发布的，我们也知道了在哪里查询 RFC 标准文档，这能帮助你少走很多弯路。</p>
</div><div class="cl-preview-section"><p>接着我们通过一张大图展示了 TCP/IP 协议族的重要协议，对于应用层协议也给出了相关参考链接，以便你更进一步的学习。</p>
</div><div class="cl-preview-section"><p>最后我们开发了一个简单网络检测小程序，我们遵循了架构设计、编码实现、安装测试的简单流程。也看到了 ping/pong 消息互相发送的过程。文章结尾顺带介绍了 netstat 工具的最初级应用。</p>
</div><div class="cl-preview-section"><p>对于 nwchecker 中涉及到的很多细节内容我们都没有展开讲解，这是以后专栏的内容。</p>
</div><div class="cl-preview-section"><p>通过本文的学习，我相信你已经入门 Socket 编程了吧？</p>
</div><div class="cl-preview-section"><h2 id="思考时间">思考时间</h2>
</div><div class="cl-preview-section"><ol>
<li>
<p>请从 github 下载源码，仔细分析 nwchecker_server 是否支持多个客户端同时连接？如果不支持该如何改进？</p>
</li>
<li>
<p>nwchecker 的 Client 和 Server 程序对于 recv() 函数的处理逻辑是否有不完善的地方？如果有，请问该如何改造？（提示，如果一个 ping 消息被拆成多个 IP 包会出现什么问题）</p>
</li>
<li>
<p>我们说 Socket API 调用出错后通过 errno 返回错误码，如果要查看错误码代表的错误描述，该如何获取呢？(提示：尽量不用搜索引擎，在系统目录里面寻找。)</p>
</li>
</ol>
</div>
			
		</div>
	
	
	<div class="finish-learn">
		<p class="copyright">©版权归慕课网所有，未经许可不得转载</p>
		
		
		
		<div class="ad_pic">
			<img src="https://img3.mukewang.com/5ed9fbe1000109e706700192.jpg">
		</div>
		
		
		
		
	</div>
	<div class="comment-con">
		<h4 class="title">
			精选留言
			
				<a href="javascript: void(0);" class="add-comment js-comment-click"><i class="imwap-xieliuyan"></i><span>写留言</span></a>
			
		</h4>
		
			<p class="bottom-text empty">暂无精选留言</p>
		
	</div>
	
	

	
		
	
	
	
		<div class="bottom-con">
			
			
				<div class="inner">
					
						<div class="price-con js-price-con">
							<span class="now">￥58.00</span>
						</div>
							
					
					
					<a class="gobuy js-gobuy" href="//m.imooc.com/account/login?backurl=//m.imooc.com/confirmorder?type=30&typeid=80">
					
						立即购买
					</a>  
				</div>
			
		</div>
	
	<div class="layer-catalog js-layer-catalog hide">
		<div class="layer-title clearfix">
			<div class="l">
				课程目录
			</div>
			
		</div>
		<div class="layer-wrap">
			<div class="js-catalog-container">
			</div>
		</div>
	</div>
	<div class="layer-comment">
		<div class="inner">
			<h5>
				<span class="btn l js-cancel-comment">取消</span>
				评论
				<span class="btn r js-send-comment">发送</span>
			</h5>
			<textarea id="comment-txt" maxlength="20000" placeholder="欢迎在这里发表留言，作者筛选后可公开显示"></textarea>
		</div>
	</div>


            </div>
        </div>
        
            
         
        
        
        
        




<script>
	// 设置字号大小及选中
	(function() {
			var fs = window.localStorage.getItem('font-size') || 'normal';
			var $c = document.querySelector('#middle>.content');
			var $points = document.querySelectorAll('.setting-box .point');
			try{
				// 抢读完了时 该元素不渲染 会有报错
				$c.className = 'content ' + fs;
				for(var i = 0; i < $points.length; i++) {
					if($points[i].className.indexOf(fs) > -1) {
						$points[i].className = $points[i].className + ' current';
					}
				}
			} catch(e) {}
			
	})();
</script>

<script type="text/javascript">
	window.onload = function() {
			zhuge.track('LearnCourse', {
					'Category': '专栏',
					'Name': '03 素昧平生：初识网络协议大家族',
					'CID': '2092',
					'Teacher': '陈子兴'
			});
	}
</script>

        
            <script type="text/javascript">
                var shareData = { 
                    title:  "03 素昧平生：初识网络协议大家族",
                    desc: "学好通用知识，提升技术竞争力",
                    imgUrl: 'https:https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    otherImgUrl: 'https://img3.mukewang.com/5ed8c1c600015fc805400720.jpg',
                    text: '我正在参加@慕课网的课程，很不错哦！快来一起学习吧！',
                    // url: 'https://www.imooc.com' + window.location.pathname + window.location.search
                    url: 'https://m.imooc.com/read/80',
                    link: 'https://m.imooc.com/read/80'
                }
            </script>
            
        
        <div style="display:none;">
            <!-- 百度统计 -->
            <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?c92536284537e1806a07ef3e6873f2b3";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
            </script>

            <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
        </div>
        
    <script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/zhugeio/init_f9752c3.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/jquery-2.1.0.min_ac9f840.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/common_84429c0.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/juicer/juicer.min_8643248.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/lib/previewImage/previewImage.min_43b970d.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/common/js/msg_bed8d10.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/read/7.2.8/article_30e5762.js"></script><script type="text/javascript" src="https://m.imooc.com/static/wap/static/js/course/advertisementReport_6e58a98.js"></script></body>
</html>
